services:
  # ─────────────────────────────────────────────────────────
  # 1) Memcached 캐시 서버
  # ─────────────────────────────────────────────────────────
  ftt-mimir-memcache:
    image: memcached:1.6.28-alpine
    container_name: ftt-mimir-memcache

    # 16GB 서버에 최적화된 메모리 할당 (4GB)
    command: ["-m", "4096", "-I", "10m", "-p", "11211", "-c", "1024", "-vv"]

    ports:
      - "11212:11211"  # Loki와 포트 충돌 방지

    restart: unless-stopped
    networks:
      - mimir-net

    # 헬스체크
    healthcheck:
      test: ["CMD-SHELL", "echo stats | nc localhost 11211 | grep -q uptime"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # 로깅 설정
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ─────────────────────────────────────────────────────────
  # 2) Mimir Monolithic (2.16.0 호환)
  # ─────────────────────────────────────────────────────────
  ftt-mimir:
    image: grafana/mimir:2.16.0
    container_name: ftt-mimir
    restart: unless-stopped

    # 파일 디스크립터 제한
    ulimits:
      nofile:
        soft: 65536
        hard: 1048576

    # 헬스체크
    healthcheck:
      test: ["CMD-SHELL","curl -f http://localhost:8080/-/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    command:
      # ──────[기본 설정]──────────────────────────────────────
      - "-target=all"
      - "-config.file=/etc/mimir/mimir-config.yaml"
      - "-config.expand-env=true"
      - "-log.level=info"

      # ──────[TSDB 기본 설정]─────────────────────────────────
      - "-blocks-storage.tsdb.dir=/var/mimir/tsdb"
      - "-blocks-storage.tsdb.retention-period=48h"
      - "-blocks-storage.tsdb.wal-compression-enabled=true"
      - "-blocks-storage.tsdb.flush-blocks-on-shutdown=true"

      # ──────[Compactor 기본 설정]───────────────────────────
      - "-compactor.data-dir=/var/mimir/compactor"
      - "-compactor.compaction-interval=2h"
      - "-compactor.compaction-concurrency=2"

      # ──────[Ring 복제]─────────────────────────────────────
      - "-ingester.ring.replication-factor=1"
      - "-store-gateway.sharding-ring.replication-factor=1"

      # ──────[Store-Gateway 기본 설정]──────────────────────
      - "-blocks-storage.bucket-store.sync-interval=2m"
      - "-blocks-storage.bucket-store.ignore-blocks-within=3h"
      - "-blocks-storage.bucket-store.ignore-deletion-marks-delay=2h"

      # ──────[캐싱 설정]─────────────────────────────────────
      - "-blocks-storage.bucket-store.index-cache.backend=memcached"
      - "-blocks-storage.bucket-store.index-cache.memcached.addresses=ftt-mimir-memcache:11211"
      - "-blocks-storage.bucket-store.chunks-cache.backend=memcached"
      - "-blocks-storage.bucket-store.chunks-cache.memcached.addresses=ftt-mimir-memcache:11211"
      - "-blocks-storage.bucket-store.metadata-cache.backend=memcached"
      - "-blocks-storage.bucket-store.metadata-cache.memcached.addresses=ftt-mimir-memcache:11211"

      # ──────[Querier 기본 설정]──────────────────────────────
      - "-querier.max-outstanding-requests-per-tenant=1024"
      - "-querier.max-concurrent=128"
      - "-querier.timeout=2m"

      # ──────[Query-Frontend 기본 설정]──────────────────────
      - "-query-frontend.cache-results=true"
      - "-query-frontend.results-cache.backend=memcached"
      - "-query-frontend.results-cache.memcached.addresses=ftt-mimir-memcache:11211"
      - "-query-frontend.results-cache.compression=snappy"
      - "-query-frontend.query-sharding-target-series-per-shard=50000"
      - "-query-frontend.log-queries-longer-than=10s"

    ports:
      - "9009:8080"        # HTTP API
      - "9095:9095"        # gRPC API

    volumes:
      - ./config/mimir-config.yaml:/etc/mimir/mimir-config.yaml:ro
      - ./data/compactor:/var/mimir/compactor
      - ./data/tsdb:/var/mimir/tsdb

    environment:
      AWS_REGION: ap-northeast-2
      MIMIR_S3_BUCKET: sys-lgtm-s3

    depends_on:
      ftt-mimir-memcache:
        condition: service_healthy

    networks:
      - mimir-net

    # 로깅 설정
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

    # 그레이스풀 종료
    stop_signal: SIGTERM
    stop_grace_period: 30s

    # 운영 레이블
    labels:
      - "app=mimir"
      - "component=metrics-storage"
      - "environment=production"
      - "version=2.16.0"

networks:
  mimir-net:
    external: true