##############################################################################
# Mimir 2.16.0 호환 설정 (16GB 서버, sys-lgtm-s3 버킷)
##############################################################################

##############################################################################
# 1) 공통 S3 백엔드 설정
##############################################################################
common:
  storage:
    backend: s3
    s3:
      endpoint: s3.ap-northeast-2.amazonaws.com     # 한국 리전
      region: ap-northeast-2
      bucket_name: ${MIMIR_S3_BUCKET}               # sys-lgtm-s3

##############################################################################
# 2) 테넌트별 제한 설정 (기본 + 최적화)
##############################################################################
limits:
  # 데이터 보존 정책
  compactor_blocks_retention_period: 1y            # 1년 메트릭 보존

  # 순서 관련 설정
  out_of_order_time_window: 10m                    # 10분 늦은 데이터 허용

  # 수집 제한 (테넌트별)
  ingestion_rate: 100000                            # 초당 10만 샘플
  ingestion_burst_size: 500000                      # 버스트 50만 샘플
  max_global_series_per_user: 2000000              # 테넌트당 200만 시리즈
  max_global_series_per_metric: 300000             # 메트릭당 30만 시리즈
  max_global_metadata_per_user: 100000             # 테넌트당 메타데이터 10만
  max_global_metadata_per_metric: 10000            # 메트릭당 메타데이터 1만

  # 쿼리 제한
  max_total_query_length: 12000h                   # 최대 쿼리 범위 (1년 + 여유)
  max_partial_query_length: 744h                   # 부분 쿼리 범위 (31일)
  max_query_parallelism: 32                        # 쿼리 병렬 처리 (8코어 * 4)

  # 라벨 제한
  max_label_name_length: 1024
  max_label_value_length: 4096
  max_label_names_per_series: 30

##############################################################################
# 3) 단일 노드 모드 설정
##############################################################################
memberlist:
  node_name: mimir-single-node
  bind_port: 7946
  join_members: []                                  # 단일 노드

##############################################################################
# 4) 블록 스토리지 (S3)
##############################################################################
blocks_storage:
  backend: s3
  storage_prefix: blocks                            # 블록 전용 prefix (간단하게)
  s3:
    bucket_name: ${MIMIR_S3_BUCKET}                 # sys-lgtm-s3

  # TSDB 기본 설정
  tsdb:
    retention_period: 48h                           # 로컬 48시간 보존

##############################################################################
# 5) 분산 처리 및 샤딩
##############################################################################
distributor:
  ring:
    heartbeat_period: 5s
    heartbeat_timeout: 1m

  # HA 복제 설정 (단일 노드에서는 비활성화)
  ha_tracker:
    enable_ha_tracker: false

  # 원격 쓰기 최적화
  remote_timeout: 2s

##############################################################################
# 6) Ingester 기본 설정
##############################################################################
ingester:
  ring:
    heartbeat_period: 5s
    heartbeat_timeout: 1m
    final_sleep: 0s

##############################################################################
# 7) Querier 기본 설정
##############################################################################
querier:
  # 동시성 제한
  max_concurrent: 16                                # 16개 동시 쿼리
  timeout: 2m

##############################################################################
# 8) Query Frontend 설정은 커맨드라인 옵션으로 처리
##############################################################################
# query_frontend 섹션은 2.16.0에서 YAML 지원 안함
# Docker Compose의 command 섹션에서 설정

##############################################################################
# 9) Compactor 기본 설정
##############################################################################
compactor:
  # 정리 작업
  cleanup_interval: 15m
  cleanup_concurrency: 1

  # 블록 삭제
  deletion_delay: 12h

##############################################################################
# 10) Ruler 스토리지 (알람 룰)
##############################################################################
ruler_storage:
  backend: s3
  storage_prefix: rules
  s3:
    bucket_name: ${MIMIR_S3_BUCKET}

##############################################################################
# 11) Alertmanager 스토리지 (알람 상태)
##############################################################################
alertmanager_storage:
  backend: s3
  storage_prefix: alerts
  s3:
    bucket_name: ${MIMIR_S3_BUCKET}

##############################################################################
# 12) 운영기본 설정
##############################################################################
runtime_config:
  period: 10s                                       # 런타임 설정 리로드 주기

# 사용량 통계 (2.16.0에서 지원하지 않음)
# usage_stats:
#   installation_mode: docker-compose-single