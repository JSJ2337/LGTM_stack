# ============================================================================
# Grafana Docker Compose (시각화 대시보드)
# ============================================================================
# 실행: docker-compose --env-file ../.env -f grafana-docker-compose.yaml up -d
# ============================================================================

services:
  # ─────────────────────────────────────────────────────────────────────────
  # Grafana
  # ─────────────────────────────────────────────────────────────────────────
  jsj-grafana:
    image: grafana/grafana:${GRAFANA_VERSION}
    container_name: ${CONTAINER_PREFIX}-grafana
    user: "0:0"
    restart: unless-stopped

    ports:
      - "${GRAFANA_HTTP_PORT}:3000"

    volumes:
      - ./grafana-data:/var/lib/grafana
      - ./config/grafana-provisioning:/etc/grafana/provisioning:ro
      - ./config/plugins:/var/lib/grafana/plugins
      - ./config/433_logo.svg:/usr/share/grafana/public/img/grafana_icon.svg
      - ./config/433_logo.svg:/usr/share/grafana/public/img/grafana_typelogo.svg
      - ./config/433_logo.svg:/usr/share/grafana/public/img/grafana_com_auth_logo.svg
      - ./config/433_logo.png:/usr/share/grafana/public/img/fav32.png
      - ./config/433_logo.svg:/usr/share/grafana/public/build/static/img/grafana_icon.1e0deb6b.svg

    environment:
      # 기본 관리자 계정
      GF_SECURITY_ADMIN_USER: ${GF_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_ADMIN_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: "false"
      # 서버 설정
      GF_SERVER_ROOT_URL: ${GF_SERVER_ROOT_URL}
      GF_LOG_LEVEL: ${GF_LOG_LEVEL}
      # 플러그인 및 타임존
      GF_INSTALL_PLUGINS: grafana-piechart-panel
      GF_DATE_FORMATS_DEFAULT_TIMEZONE: ${TZ}
      TZ: ${TZ}
      # Alert State History (Loki)
      GF_FEATURE_TOGGLES_ENABLE: alertingCentralAlertHistory
      GF_UNIFIED_ALERTING_STATE_HISTORY_ENABLED: "true"
      GF_UNIFIED_ALERTING_STATE_HISTORY_BACKEND: loki
      GF_UNIFIED_ALERTING_STATE_HISTORY_LOKI_REMOTE_URL: http://${CONTAINER_PREFIX}-loki:3100
      GF_UNIFIED_ALERTING_STATE_HISTORY_LOKI_TENANT_ID: ${DEFAULT_TENANT}

    networks:
      - ${DOCKER_NETWORK}

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE}"
        max-file: "${LOG_MAX_FILE}"

    stop_signal: SIGTERM
    stop_grace_period: 30s

    labels:
      - "app=grafana"
      - "component=visualization"
      - "environment=production"
      - "version=${GRAFANA_VERSION}"

networks:
  jsj-lgtm-net:
    name: ${DOCKER_NETWORK}
    external: true

volumes:
  grafana-data:
    driver: local
