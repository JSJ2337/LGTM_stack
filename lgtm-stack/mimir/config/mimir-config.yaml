###############################################################################
# Mimir Configuration - ECS Fargate 호환
###############################################################################

###############################################################################
# 1. 공통 S3 백엔드 설정
###############################################################################
common:
  storage:
    backend: s3
    s3:
      endpoint: s3.${AWS_REGION}.amazonaws.com
      region: ${AWS_REGION}
      bucket_name: ${MIMIR_S3_BUCKET}

###############################################################################
# 2. 테넌트별 제한 설정
###############################################################################
limits:
  # 데이터 보존 정책
  compactor_blocks_retention_period: 1y   # 1년 메트릭 보존

  # 순서 관련 설정
  out_of_order_time_window: 10m           # 10분 늦은 데이터 허용

  # 수집 제한 (테넌트별)
  ingestion_rate: 100000                  # 초당 10만 샘플
  ingestion_burst_size: 500000            # 버스트 50만 샘플
  max_global_series_per_user: 2000000     # 테넌트당 200만 시리즈
  max_global_series_per_metric: 300000    # 메트릭당 30만 시리즈
  max_global_metadata_per_user: 100000    # 테넌트당 메타데이터 10만
  max_global_metadata_per_metric: 10000   # 메트릭당 메타데이터 1만

  # 쿼리 제한
  max_total_query_length: 12000h          # 최대 쿼리 범위 (1년 + 여유)
  max_partial_query_length: 744h          # 부분 쿼리 범위 (31일)
  max_query_parallelism: 32               # 쿼리 병렬 처리

  # 라벨 제한
  max_label_name_length: 1024
  max_label_value_length: 4096
  max_label_names_per_series: 30

###############################################################################
# 3. 단일 노드 모드 설정
###############################################################################
memberlist:
  node_name: mimir-single-node
  bind_port: 7946
  join_members: []                        # 단일 노드

###############################################################################
# 4. 블록 스토리지 (S3) + 캐싱 설정
###############################################################################
blocks_storage:
  backend: s3
  storage_prefix: blocks                  # 블록 전용 prefix
  s3:
    bucket_name: ${MIMIR_S3_BUCKET}

  # TSDB 설정
  tsdb:
    retention_period: 48h                 # 로컬 48시간 보존

  # Bucket Store 캐싱 (ElastiCache Memcached)
  bucket_store:
    # Index 캐시 (쿼리 성능 향상)
    index_cache:
      backend: memcached
      memcached:
        addresses: ${MEMCACHED_ENDPOINT}
        timeout: 500ms
        max_idle_connections: 16

    # Chunks 캐시 (데이터 로드 성능 향상)
    chunks_cache:
      backend: memcached
      memcached:
        addresses: ${MEMCACHED_ENDPOINT}
        timeout: 500ms
        max_idle_connections: 16

    # Metadata 캐시
    metadata_cache:
      backend: memcached
      memcached:
        addresses: ${MEMCACHED_ENDPOINT}
        timeout: 500ms
        max_idle_connections: 16

###############################################################################
# 5. Distributor 설정
###############################################################################
distributor:
  ring:
    heartbeat_period: 5s
    heartbeat_timeout: 1m

  # HA 복제 설정 (단일 노드에서는 비활성화)
  ha_tracker:
    enable_ha_tracker: false

  # 원격 쓰기 최적화
  remote_timeout: 2s

###############################################################################
# 6. Ingester 설정
###############################################################################
ingester:
  ring:
    heartbeat_period: 5s
    heartbeat_timeout: 1m
    final_sleep: 0s

###############################################################################
# 7. Querier 설정
###############################################################################
querier:
  max_concurrent: 16                      # 16개 동시 쿼리
  timeout: 2m

###############################################################################
# 8. Compactor 설정
###############################################################################
compactor:
  cleanup_interval: 15m                   # 정리 작업 간격
  cleanup_concurrency: 1
  deletion_delay: 12h                     # 블록 삭제 지연

###############################################################################
# 9. Ruler 스토리지 (알람 룰)
###############################################################################
ruler_storage:
  backend: s3
  storage_prefix: rules
  s3:
    bucket_name: ${MIMIR_S3_BUCKET}

###############################################################################
# 10. Alertmanager 스토리지 (알람 상태)
###############################################################################
alertmanager_storage:
  backend: s3
  storage_prefix: alerts
  s3:
    bucket_name: ${MIMIR_S3_BUCKET}

###############################################################################
# 11. 런타임 설정
###############################################################################
runtime_config:
  period: 10s                             # 런타임 설정 리로드 주기
