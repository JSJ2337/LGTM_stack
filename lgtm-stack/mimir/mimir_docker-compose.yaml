# ============================================================================
# Mimir Docker Compose (메트릭 저장소)
# ============================================================================
# 실행: docker-compose --env-file ../.env -f mimir_docker-compose.yaml up -d
# ============================================================================

services:
  # ─────────────────────────────────────────────────────────────────────────
  # Memcached 캐시 서버
  # ─────────────────────────────────────────────────────────────────────────
  jsj-mimir-memcache:
    image: memcached:${MEMCACHED_VERSION}
    container_name: ${CONTAINER_PREFIX}-mimir-memcache
    user: "0:0"
    command: ["-m", "4096", "-I", "10m", "-p", "11211", "-c", "1024", "-vv"]
    ports:
      - "${MEMCACHED_PORT}:11211"
    restart: unless-stopped
    networks:
      - ${DOCKER_NETWORK}

    healthcheck:
      test: ["CMD-SHELL", "echo stats | nc localhost 11211 | grep -q uptime"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE}"
        max-file: "${LOG_MAX_FILE}"

    labels:
      - "app=mimir-memcache"
      - "component=cache"
      - "environment=production"
      - "version=${MEMCACHED_VERSION}"

  # ─────────────────────────────────────────────────────────────────────────
  # Mimir Monolithic
  # ─────────────────────────────────────────────────────────────────────────
  jsj-mimir:
    image: grafana/mimir:${MIMIR_VERSION}
    container_name: ${CONTAINER_PREFIX}-mimir
    user: "0:0"
    restart: unless-stopped

    ulimits:
      nofile:
        soft: 65536
        hard: 1048576

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/-/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    command:
      - "-target=all"
      - "-config.file=/etc/mimir/mimir-config.yaml"
      - "-config.expand-env=true"
      - "-log.level=info"
      # TSDB 설정
      - "-blocks-storage.tsdb.dir=/var/mimir/tsdb"
      - "-blocks-storage.tsdb.retention-period=48h"
      - "-blocks-storage.tsdb.wal-compression-enabled=true"
      - "-blocks-storage.tsdb.flush-blocks-on-shutdown=true"
      # Compactor 설정
      - "-compactor.data-dir=/var/mimir/compactor"
      - "-compactor.compaction-interval=2h"
      - "-compactor.compaction-concurrency=2"
      # Ring 복제
      - "-ingester.ring.replication-factor=1"
      - "-store-gateway.sharding-ring.replication-factor=1"
      # Store-Gateway 설정
      - "-blocks-storage.bucket-store.sync-interval=2m"
      - "-blocks-storage.bucket-store.ignore-blocks-within=3h"
      - "-blocks-storage.bucket-store.ignore-deletion-marks-delay=2h"
      # 캐싱 설정
      - "-blocks-storage.bucket-store.index-cache.backend=memcached"
      - "-blocks-storage.bucket-store.index-cache.memcached.addresses=${CONTAINER_PREFIX}-mimir-memcache:11211"
      - "-blocks-storage.bucket-store.chunks-cache.backend=memcached"
      - "-blocks-storage.bucket-store.chunks-cache.memcached.addresses=${CONTAINER_PREFIX}-mimir-memcache:11211"
      - "-blocks-storage.bucket-store.metadata-cache.backend=memcached"
      - "-blocks-storage.bucket-store.metadata-cache.memcached.addresses=${CONTAINER_PREFIX}-mimir-memcache:11211"
      # Querier 설정
      - "-querier.max-outstanding-requests-per-tenant=1024"
      - "-querier.max-concurrent=128"
      - "-querier.timeout=2m"
      # Query-Frontend 설정
      - "-query-frontend.cache-results=true"
      - "-query-frontend.results-cache.backend=memcached"
      - "-query-frontend.results-cache.memcached.addresses=${CONTAINER_PREFIX}-mimir-memcache:11211"
      - "-query-frontend.results-cache.compression=snappy"
      - "-query-frontend.query-sharding-target-series-per-shard=50000"
      - "-query-frontend.log-queries-longer-than=10s"

    ports:
      - "${MIMIR_HTTP_PORT}:8080"
      - "${MIMIR_GRPC_PORT}:9095"

    volumes:
      - ./config/mimir-config.yaml:/etc/mimir/mimir-config.yaml:ro
      - ./data/compactor:/var/mimir/compactor
      - ./data/tsdb:/var/mimir/tsdb

    environment:
      AWS_REGION: ${AWS_REGION}
      MIMIR_S3_BUCKET: ${S3_BUCKET}
      TZ: ${TZ}

    depends_on:
      jsj-mimir-memcache:
        condition: service_healthy

    networks:
      - ${DOCKER_NETWORK}

    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE}"
        max-file: "${LOG_MAX_FILE}"

    stop_signal: SIGTERM
    stop_grace_period: 30s

    labels:
      - "app=mimir"
      - "component=metrics-storage"
      - "environment=production"
      - "version=${MIMIR_VERSION}"

networks:
  jsj-lgtm-net:
    name: ${DOCKER_NETWORK}
    external: true
