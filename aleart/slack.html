{{ define "slack_webhook_hybrid.body" }}

{{- /* ===== ê³µí†µ ë©”íƒ€ ===== */ -}}
{{- $name := "Alert" -}}
{{- if .CommonLabels.alertname -}} {{- $name = .CommonLabels.alertname -}}
{{- else if gt (len .Alerts) 0 -}} {{- $name = (index .Alerts 0).Labels.alertname -}} {{- end -}}

{{- $sev := "info" -}}
{{- if .CommonLabels.severity -}} {{- $sev = .CommonLabels.severity -}}
{{- else if gt (len .Alerts) 0 -}} {{- $sev = (index .Alerts 0).Labels.severity -}} {{- end -}}

{{- /* ìƒíƒœ/ìƒ‰ìƒ/ì•„ì´ì½˜ */ -}}
{{- $sevIcon := ":grey_question:" -}}
{{- $color   := "#95a5a6" -}}
{{- if eq .Status "firing" -}}
  {{- if or (eq $sev "emergency") (eq $sev "EMERGENCY") -}}
      {{- $sevIcon = ":fire:" -}}          {{- $color = "#8B5CF6" -}}
  {{- else if or (eq $sev "down") (eq $sev "DOWN") -}}
      {{- $sevIcon = ":no_entry:" -}}      {{- $color = "#FF6D00" -}}
  {{- else if or (eq $sev "critical") (eq $sev "CRITICAL") -}}
      {{- $sevIcon = ":rotating_light:" -}} {{- $color = "#E11D48" -}}
  {{- else if or (eq $sev "warning") (eq $sev "WARNING") (eq $sev "caution") (eq $sev "CAUTION") -}}
      {{- $sevIcon = ":warning:" -}}       {{- $color = "#FFB300" -}}
  {{- else -}}
      {{- $sevIcon = ":information_source:" -}} {{- $color = "#36C5F0" -}}
  {{- end -}}
{{- else -}}
  {{- $sevIcon = ":white_check_mark:" -}}   {{- $color = "#2EB67D" -}}
{{- end -}}

{{- /* ìƒíƒœ í…ìŠ¤íŠ¸ */ -}}
{{- $statusLabel := "ë³µêµ¬" -}}
{{- if eq .Status "firing" -}} {{- $statusLabel = "ë°œìƒ" -}} {{- end -}}

{{- /* í‘¸ì‹œ/ë¯¸ë¦¬ë³´ê¸°ìš© íƒ€ì´í‹€(ìœ ë‹ˆì½”ë“œ ì´ëª¨ì§€) */ -}}
{{- $titleIcon := "â„¹ï¸" -}}
{{- if eq .Status "firing" -}}
  {{- if or (eq $sev "emergency") (eq $sev "EMERGENCY") -}} {{- $titleIcon = "ğŸ”¥" -}}
  {{- else if or (eq $sev "down") (eq $sev "DOWN") -}}       {{- $titleIcon = "â›”" -}}
  {{- else if or (eq $sev "critical") (eq $sev "CRITICAL") -}}{{- $titleIcon = "ğŸš¨" -}}
  {{- else if or (eq $sev "warning") (eq $sev "WARNING") (eq $sev "caution") (eq $sev "CAUTION") -}}
                                                             {{- $titleIcon = "âš ï¸" -}}
  {{- end -}}
{{- else -}}
  {{- $titleIcon = "âœ…" -}}
{{- end -}}

{{- $title := printf "%s %s : %s (%dê±´)" $titleIcon $statusLabel $name (len .Alerts) -}}

{
  "text": "*{{ $title }}*",
  "attachments": [
    {
      "fallback": "{{ $title }}",
      "color": "{{ $color }}",
      "blocks": [
        {{- /* ì•ŒëŸ¿ ëª©ë¡ (ìµœëŒ€ 9ê±´) */ -}}
        {{- $max := 9 -}}
        {{- range $i, $a := .Alerts }}
        {{- if lt $i $max }}
        {{- if eq $i 0 -}}
        { "type": "divider" }
        {{- else -}}
        ,{ "type": "divider" }
        {{- end -}}

        ,{ "type": "section",
           "text": { "type": "mrkdwn",
             "text": ":memo: *ìš”ì•½* : {{ if and $a.Annotations $a.Annotations.summary }}{{ $a.Annotations.summary | js }}{{ else if and $a.Annotations $a.Annotations.description }}{{ $a.Annotations.description | js }}{{ else }}ì„¤ëª… ì—†ìŒ{{ end }}" }
         }

        {{- /* ëŒ€ìƒ = inst â†’ instance â†’ pod â†’ node â†’ host â†’ server â†’ job */ -}}
        ,{ "type": "section",
           "text": { "type": "mrkdwn",
             "text": ":label: *ëŒ€ìƒ* : `{{- if $a.Labels -}}
              {{- if $a.Labels.inst -}}{{ $a.Labels.inst }}
              {{- else if $a.Labels.instance -}}{{ $a.Labels.instance }}
              {{- else if $a.Labels.pod -}}{{ $a.Labels.pod }}
              {{- else if $a.Labels.node -}}{{ $a.Labels.node }}
              {{- else if $a.Labels.host -}}{{ $a.Labels.host }}
              {{- else if $a.Labels.server -}}{{ $a.Labels.server }}
              {{- else if $a.Labels.job -}}{{ $a.Labels.job }}
              {{- else -}}unknown{{- end -}}
            {{- else -}}unknown{{- end -}}`
            {{- /* ë””ìŠ¤í¬/ë§ˆìš´íŠ¸/FS ë¶€ê°€ ì •ë³´ */ -}}
            {{- if $a.Labels -}}
              {{- $hasExtra := false -}}
              {{- if or $a.Labels.device $a.Labels.disk $a.Labels.volume $a.Labels.persistentvolumeclaim -}}
                {{- $hasExtra = true -}} â€” disk=`
                {{- if $a.Labels.device -}}{{ $a.Labels.device }}
                {{- else if $a.Labels.disk -}}{{ $a.Labels.disk }}
                {{- else if $a.Labels.volume -}}{{ $a.Labels.volume }}
                {{- else if $a.Labels.persistentvolumeclaim -}}{{ $a.Labels.persistentvolumeclaim }}{{- end -}}`
              {{- end -}}
              {{- if or $a.Labels.mountpoint $a.Labels.path $a.Labels.mount $a.Labels.target -}}
                {{- if $hasExtra -}}, {{- else -}} â€” {{- end -}}mount=`
                {{- if $a.Labels.mountpoint -}}{{ $a.Labels.mountpoint }}
                {{- else if $a.Labels.path -}}{{ $a.Labels.path }}
                {{- else if $a.Labels.mount -}}{{ $a.Labels.mount }}
                {{- else if $a.Labels.target -}}{{ $a.Labels.target }}{{- end -}}`
              {{- end -}}
              {{- if or $a.Labels.fstype $a.Labels.filesystem $a.Labels.fs_type -}}
                {{- if $hasExtra -}}, {{- else -}} â€” {{- end -}}fs=`
                {{- if $a.Labels.fstype -}}{{ $a.Labels.fstype }}
                {{- else if $a.Labels.filesystem -}}{{ $a.Labels.filesystem }}
                {{- else if $a.Labels.fs_type -}}{{ $a.Labels.fs_type }}{{- end -}}`
              {{- end -}}
            {{- end -}}" }
         }

        ,{ "type": "section",
           "text": { "type": "mrkdwn",
             "text": ":bar_chart: *í˜„ì¬ê°’* : {{- /* annotations.current ìš°ì„ , ì—†ìœ¼ë©´ Valuesì—ì„œ ì¶”ì¶œ */ -}}
{{- if and $a.Annotations $a.Annotations.current -}}
  {{- $a.Annotations.current | js -}}
{{- else -}}
  {{- $val := "" -}}
  {{- if $a.Values -}}
    {{- if (index $a.Values "A") -}}
      {{- $val = printf "%.1f" (index $a.Values "A") -}}
    {{- else -}}
      {{- $picked := false -}}
      {{- range $k, $v := $a.Values -}}
        {{- if not $picked -}}
          {{- if not (and (eq $k "C") (eq (printf "%.0f" $v) "1")) -}}
            {{- $val = printf "%.1f" $v -}}
            {{- $picked = true -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- if $val }}{{ $val }}%{{ else }}N/A{{ end -}}
{{- end -}}
{{- if and $a.Annotations $a.Annotations.threshold }} (ì„ê³„ì¹˜: {{ $a.Annotations.threshold }}%){{ end }}" }
         }

        ,{ "type": "section",
           "text": { "type": "mrkdwn",
             "text": ":clock1: *{{ $statusLabel }}* : {{- if eq $.Status "firing" -}}
              {{- if $a.StartsAt -}}{{ printf "%.19s" $a.StartsAt }}{{- else -}}ì‹œê°„ ì •ë³´ ì—†ìŒ{{- end -}}
            {{- else -}}
              {{- if $a.EndsAt -}}{{ printf "%.19s" $a.EndsAt }}{{- else -}}ì‹œê°„ ì •ë³´ ì—†ìŒ{{- end -}}
            {{- end -}}" }
         }
        {{- end -}}
        {{- end -}}
        {{- /* 9ê±´ ì´ˆê³¼ ì•ˆë‚´ */ -}}
        {{- if gt (len .Alerts) $max }}
        ,{ "type": "context",
           "elements": [
             { "type": "mrkdwn",
               "text": "â€¦ì´ {{ len .Alerts }}ê±´ ì¤‘ {{ $max }}ê±´ë§Œ í‘œì‹œ" }
           ]
         }
        {{- end }}
      ]
    }
  ]
}
{{ end }}