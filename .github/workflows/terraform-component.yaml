# Terraform Component Reusable Workflow
# ê°œë³„ ì»´í¬ë„ŒíŠ¸ì— ëŒ€í•œ Terraform ì‹¤í–‰
# ApplyëŠ” Plan ì—†ì´ ì§ì ‘ ì‹¤í–‰ (ì¢…ì† ë¦¬ì†ŒìŠ¤ state ë¬¸ì œ ë°©ì§€)

name: Terraform Component

on:
  workflow_call:
    inputs:
      component:
        description: 'ëŒ€ìƒ ì»´í¬ë„ŒíŠ¸ (ì˜ˆ: 01-vpc, 10-ecr)'
        required: true
        type: string
      action:
        description: 'Terraform ìž‘ì—… (plan, apply, destroy)'
        required: true
        type: string
        default: 'plan'

env:
  AWS_REGION: ap-northeast-2
  TF_VERSION: '1.13.5'

jobs:
  # =============================================================================
  # Plan Job - plan ì•¡ì…˜ì¼ ë•Œë§Œ ì‹¤í–‰
  # =============================================================================
  plan:
    name: "Plan - ${{ inputs.component }}"
    runs-on: ubuntu-latest
    if: inputs.action == 'plan'

    env:
      TF_WORKING_DIR: ecs-migration/terraform/environments/prod/${{ inputs.component }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          TFVARS="../common.tfvars"
          AWS_REGION=$(grep '^aws_region' $TFVARS | cut -d'"' -f2)

          # Bootstrapì€ ë³„ë„ ë²„í‚· ì‚¬ìš© (DynamoDB locking ì—†ìŒ)
          if [ "${{ inputs.component }}" == "00-bootstrap" ]; then
            terraform init -upgrade \
              -backend-config="bucket=jsj-lgtm-terraform-bootstrap" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="encrypt=true"
          else
            STATE_BUCKET=$(grep '^state_bucket' $TFVARS | cut -d'"' -f2)
            STATE_LOCK_TABLE=$(grep '^state_lock_table' $TFVARS | cut -d'"' -f2)
            terraform init -upgrade \
              -backend-config="bucket=${STATE_BUCKET}" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="dynamodb_table=${STATE_LOCK_TABLE}" \
              -backend-config="encrypt=true"
          fi

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan \
            -var-file="../common.tfvars" \
            -compact-warnings \
            -out=tfplan 2>&1 | tee plan_output.txt

          if grep -q "No changes" plan_output.txt; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Plan Summary
        if: always()
        run: |
          echo "## ${{ inputs.component }} - Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "${{ env.TF_WORKING_DIR }}/plan_output.txt" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 "${{ env.TF_WORKING_DIR }}/plan_output.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # Apply Job - apply ì•¡ì…˜ì¼ ë•Œ ì§ì ‘ ì‹¤í–‰ (Plan ìŠ¤í‚µ)
  # =============================================================================
  apply:
    name: "Apply - ${{ inputs.component }}"
    runs-on: ubuntu-latest
    if: inputs.action == 'apply'

    env:
      TF_WORKING_DIR: ecs-migration/terraform/environments/prod/${{ inputs.component }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          TFVARS="../common.tfvars"
          AWS_REGION=$(grep '^aws_region' $TFVARS | cut -d'"' -f2)

          # Bootstrapì€ ë³„ë„ ë²„í‚· ì‚¬ìš© (DynamoDB locking ì—†ìŒ)
          if [ "${{ inputs.component }}" == "00-bootstrap" ]; then
            terraform init -upgrade \
              -backend-config="bucket=jsj-lgtm-terraform-bootstrap" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="encrypt=true"
          else
            STATE_BUCKET=$(grep '^state_bucket' $TFVARS | cut -d'"' -f2)
            STATE_LOCK_TABLE=$(grep '^state_lock_table' $TFVARS | cut -d'"' -f2)
            terraform init -upgrade \
              -backend-config="bucket=${STATE_BUCKET}" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="dynamodb_table=${STATE_LOCK_TABLE}" \
              -backend-config="encrypt=true"
          fi

      - name: Bootstrap Import (if exists)
        if: inputs.component == '00-bootstrap'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          TFVARS="../common.tfvars"
          STATE_BUCKET=$(grep '^state_bucket' $TFVARS | cut -d'"' -f2)
          STATE_LOCK_TABLE=$(grep '^state_lock_table' $TFVARS | cut -d'"' -f2)

          echo "ðŸ” ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ import ì‹œë„..."

          # S3 ë²„í‚· import (ì´ë¯¸ ì¡´ìž¬í•˜ë©´ import, ì—†ìœ¼ë©´ skip)
          if aws s3api head-bucket --bucket "${STATE_BUCKET}" 2>/dev/null; then
            echo "âœ… S3 ë²„í‚· ${STATE_BUCKET} ì¡´ìž¬, import ì‹œë„..."
            terraform import -var-file="../common.tfvars" \
              aws_s3_bucket.terraform_state "${STATE_BUCKET}" || true
          fi

          # DynamoDB í…Œì´ë¸” import (ì´ë¯¸ ì¡´ìž¬í•˜ë©´ import, ì—†ìœ¼ë©´ skip)
          if aws dynamodb describe-table --table-name "${STATE_LOCK_TABLE}" 2>/dev/null; then
            echo "âœ… DynamoDB í…Œì´ë¸” ${STATE_LOCK_TABLE} ì¡´ìž¬, import ì‹œë„..."
            terraform import -var-file="../common.tfvars" \
              aws_dynamodb_table.terraform_lock "${STATE_LOCK_TABLE}" || true
          fi

      - name: Terraform Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "âœ… ${{ inputs.component }} Apply ì‹œìž‘..."
          terraform apply \
            -var-file="../common.tfvars" \
            -compact-warnings \
            -auto-approve 2>&1 | tee apply_output.txt

      - name: Apply Summary
        if: always()
        run: |
          echo "## ${{ inputs.component }} - Apply" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "${{ env.TF_WORKING_DIR }}/apply_output.txt" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 "${{ env.TF_WORKING_DIR }}/apply_output.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # Destroy Job - destroy ì•¡ì…˜ì¼ ë•Œ ì‹¤í–‰
  # =============================================================================
  destroy:
    name: "Destroy - ${{ inputs.component }}"
    runs-on: ubuntu-latest
    if: inputs.action == 'destroy'

    env:
      TF_WORKING_DIR: ecs-migration/terraform/environments/prod/${{ inputs.component }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          TFVARS="../common.tfvars"
          AWS_REGION=$(grep '^aws_region' $TFVARS | cut -d'"' -f2)

          # Bootstrapì€ ë³„ë„ ë²„í‚· ì‚¬ìš© (DynamoDB locking ì—†ìŒ)
          if [ "${{ inputs.component }}" == "00-bootstrap" ]; then
            terraform init -upgrade \
              -backend-config="bucket=jsj-lgtm-terraform-bootstrap" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="encrypt=true"
          else
            STATE_BUCKET=$(grep '^state_bucket' $TFVARS | cut -d'"' -f2)
            STATE_LOCK_TABLE=$(grep '^state_lock_table' $TFVARS | cut -d'"' -f2)
            terraform init -upgrade \
              -backend-config="bucket=${STATE_BUCKET}" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="dynamodb_table=${STATE_LOCK_TABLE}" \
              -backend-config="encrypt=true"
          fi

      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "âš ï¸ ${{ inputs.component }} Destroy ì‹œìž‘..."
          terraform destroy \
            -var-file="../common.tfvars" \
            -compact-warnings \
            -auto-approve 2>&1 | tee destroy_output.txt

      - name: Destroy Summary
        if: always()
        run: |
          echo "## ${{ inputs.component }} - Destroy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "${{ env.TF_WORKING_DIR }}/destroy_output.txt" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 "${{ env.TF_WORKING_DIR }}/destroy_output.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
