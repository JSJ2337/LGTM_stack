# Terraform Component Reusable Workflow
# 개별 컴포넌트에 대한 Terraform 실행
# Apply는 Plan 없이 직접 실행 (종속 리소스 state 문제 방지)

name: Terraform Component

on:
  workflow_call:
    inputs:
      component:
        description: '대상 컴포넌트 (예: 01-vpc, 10-ecr)'
        required: true
        type: string
      action:
        description: 'Terraform 작업 (plan, apply, destroy)'
        required: true
        type: string
        default: 'plan'

env:
  AWS_REGION: ap-northeast-2
  TF_VERSION: '1.13.5'

jobs:
  # =============================================================================
  # Plan Job - plan 액션일 때만 실행
  # =============================================================================
  plan:
    name: "Plan - ${{ inputs.component }}"
    runs-on: ubuntu-latest
    if: inputs.action == 'plan'

    env:
      TF_WORKING_DIR: ecs-migration/terraform/environments/prod/${{ inputs.component }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          TFVARS="../common.tfvars"
          AWS_REGION=$(grep '^aws_region' $TFVARS | cut -d'"' -f2)

          # Bootstrap은 별도 버킷 사용 (DynamoDB locking 없음)
          if [ "${{ inputs.component }}" == "00-bootstrap" ]; then
            terraform init -upgrade \
              -backend-config="bucket=jsj-lgtm-terraform-bootstrap" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="encrypt=true"
          else
            STATE_BUCKET=$(grep '^state_bucket' $TFVARS | cut -d'"' -f2)
            STATE_LOCK_TABLE=$(grep '^state_lock_table' $TFVARS | cut -d'"' -f2)
            terraform init -upgrade \
              -backend-config="bucket=${STATE_BUCKET}" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="dynamodb_table=${STATE_LOCK_TABLE}" \
              -backend-config="encrypt=true"
          fi

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan \
            -var-file="../common.tfvars" \
            -compact-warnings \
            -out=tfplan 2>&1 | tee plan_output.txt

          if grep -q "No changes" plan_output.txt; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Plan Summary
        if: always()
        run: |
          echo "## ${{ inputs.component }} - Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "${{ env.TF_WORKING_DIR }}/plan_output.txt" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 "${{ env.TF_WORKING_DIR }}/plan_output.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # Apply Job - apply 액션일 때 직접 실행 (Plan 스킵)
  # =============================================================================
  apply:
    name: "Apply - ${{ inputs.component }}"
    runs-on: ubuntu-latest
    if: inputs.action == 'apply'

    env:
      TF_WORKING_DIR: ecs-migration/terraform/environments/prod/${{ inputs.component }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          TFVARS="../common.tfvars"
          AWS_REGION=$(grep '^aws_region' $TFVARS | cut -d'"' -f2)

          # Bootstrap은 별도 버킷 사용 (DynamoDB locking 없음)
          if [ "${{ inputs.component }}" == "00-bootstrap" ]; then
            terraform init -upgrade \
              -backend-config="bucket=jsj-lgtm-terraform-bootstrap" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="encrypt=true"
          else
            STATE_BUCKET=$(grep '^state_bucket' $TFVARS | cut -d'"' -f2)
            STATE_LOCK_TABLE=$(grep '^state_lock_table' $TFVARS | cut -d'"' -f2)
            terraform init -upgrade \
              -backend-config="bucket=${STATE_BUCKET}" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="dynamodb_table=${STATE_LOCK_TABLE}" \
              -backend-config="encrypt=true"
          fi

      - name: Terraform Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "✅ ${{ inputs.component }} Apply 시작..."
          terraform apply \
            -var-file="../common.tfvars" \
            -compact-warnings \
            -auto-approve 2>&1 | tee apply_output.txt

      - name: Apply Summary
        if: always()
        run: |
          echo "## ${{ inputs.component }} - Apply" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "${{ env.TF_WORKING_DIR }}/apply_output.txt" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 "${{ env.TF_WORKING_DIR }}/apply_output.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # Destroy Job - destroy 액션일 때 실행
  # =============================================================================
  destroy:
    name: "Destroy - ${{ inputs.component }}"
    runs-on: ubuntu-latest
    if: inputs.action == 'destroy'

    env:
      TF_WORKING_DIR: ecs-migration/terraform/environments/prod/${{ inputs.component }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          TFVARS="../common.tfvars"
          AWS_REGION=$(grep '^aws_region' $TFVARS | cut -d'"' -f2)

          # Bootstrap은 별도 버킷 사용 (DynamoDB locking 없음)
          if [ "${{ inputs.component }}" == "00-bootstrap" ]; then
            terraform init -upgrade \
              -backend-config="bucket=jsj-lgtm-terraform-bootstrap" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="encrypt=true"
          else
            STATE_BUCKET=$(grep '^state_bucket' $TFVARS | cut -d'"' -f2)
            STATE_LOCK_TABLE=$(grep '^state_lock_table' $TFVARS | cut -d'"' -f2)
            terraform init -upgrade \
              -backend-config="bucket=${STATE_BUCKET}" \
              -backend-config="region=${AWS_REGION}" \
              -backend-config="dynamodb_table=${STATE_LOCK_TABLE}" \
              -backend-config="encrypt=true"
          fi

      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "⚠️ ${{ inputs.component }} Destroy 시작..."
          terraform destroy \
            -var-file="../common.tfvars" \
            -compact-warnings \
            -auto-approve 2>&1 | tee destroy_output.txt

      - name: Destroy Summary
        if: always()
        run: |
          echo "## ${{ inputs.component }} - Destroy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "${{ env.TF_WORKING_DIR }}/destroy_output.txt" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 "${{ env.TF_WORKING_DIR }}/destroy_output.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
