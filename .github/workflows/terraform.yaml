# LGTM Stack Terraform Infrastructure Pipeline
# GitHub Actions Workflow for Terraform infrastructure management
# Apply: Stage 1 → 5 순서 / Destroy: Stage 5 → 1 역순

name: Terraform Infrastructure

permissions:
  id-token: write
  contents: read
  pull-requests: write

on:
  push:
    branches:
      - main
      - lgtm_prd
    paths:
      - 'ecs-migration/terraform/**'
      - '.github/workflows/terraform.yaml'

  pull_request:
    branches:
      - main
      - lgtm_prd
    paths:
      - 'ecs-migration/terraform/**'

  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform 작업'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      component:
        description: '대상 컴포넌트 (all = 전체)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - 01-vpc
          - 05-cloudwatch-logs
          - 10-ecr
          - 15-s3
          - 20-iam
          - 30-security-groups
          - 40-cloudmap
          - 50-alb
          - 60-ecs

env:
  AWS_REGION: ap-northeast-2
  TF_BASE_DIR: ecs-migration/terraform/environments/prod
  TF_VERSION: '1.13.5'

jobs:
  # =============================================================================
  # Approval Gate - Apply/Destroy 시 승인 (맨 처음 한 번)
  # =============================================================================
  approval:
    name: "Approval Gate"
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.action == 'apply' || github.event.inputs.action == 'destroy')
    environment:
      name: prod
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Approval Confirmed
        run: |
          echo "## ✅ 승인 완료" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Component:** ${{ github.event.inputs.component }}" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Plan/Apply 순서: Stage 1 → 2 → 3 → 4 → 5
  # =============================================================================

  # Stage 1: VPC, IAM (종속성 없음 - 병렬 실행)
  stage1-vpc:
    name: "Stage1: VPC"
    needs: [approval]
    if: >-
      always() &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      github.event.inputs.action != 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '01-vpc')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 01-vpc
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  stage1-iam:
    name: "Stage1: IAM"
    needs: [approval]
    if: >-
      always() &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      github.event.inputs.action != 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '20-iam')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 20-iam
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  # Stage 2: CloudWatch Logs, ECR, S3
  stage2-cloudwatch-logs:
    name: "Stage2: CloudWatch Logs"
    needs: [approval, stage1-vpc, stage1-iam]
    if: >-
      always() &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage1-iam.result == 'success' || needs.stage1-iam.result == 'skipped') &&
      github.event.inputs.action != 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '05-cloudwatch-logs')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 05-cloudwatch-logs
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  stage2-ecr:
    name: "Stage2: ECR"
    needs: [approval, stage1-vpc, stage1-iam]
    if: >-
      always() &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage1-iam.result == 'success' || needs.stage1-iam.result == 'skipped') &&
      github.event.inputs.action != 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '10-ecr')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 10-ecr
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  stage2-s3:
    name: "Stage2: S3"
    needs: [approval, stage1-vpc, stage1-iam]
    if: >-
      always() &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage1-iam.result == 'success' || needs.stage1-iam.result == 'skipped') &&
      github.event.inputs.action != 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '15-s3')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 15-s3
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  # Stage 3: Security Groups, CloudMap
  stage3-security-groups:
    name: "Stage3: Security Groups"
    needs: [approval, stage1-vpc, stage2-cloudwatch-logs, stage2-ecr, stage2-s3]
    if: >-
      always() &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage2-cloudwatch-logs.result == 'success' || needs.stage2-cloudwatch-logs.result == 'skipped') &&
      (needs.stage2-ecr.result == 'success' || needs.stage2-ecr.result == 'skipped') &&
      (needs.stage2-s3.result == 'success' || needs.stage2-s3.result == 'skipped') &&
      github.event.inputs.action != 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '30-security-groups')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 30-security-groups
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  stage3-cloudmap:
    name: "Stage3: CloudMap"
    needs: [approval, stage1-vpc, stage2-cloudwatch-logs, stage2-ecr, stage2-s3]
    if: >-
      always() &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage2-cloudwatch-logs.result == 'success' || needs.stage2-cloudwatch-logs.result == 'skipped') &&
      (needs.stage2-ecr.result == 'success' || needs.stage2-ecr.result == 'skipped') &&
      (needs.stage2-s3.result == 'success' || needs.stage2-s3.result == 'skipped') &&
      github.event.inputs.action != 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '40-cloudmap')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 40-cloudmap
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  # Stage 4: ALB
  stage4-alb:
    name: "Stage4: ALB"
    needs: [approval, stage1-vpc, stage3-security-groups, stage3-cloudmap]
    if: >-
      always() &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage3-security-groups.result == 'success' || needs.stage3-security-groups.result == 'skipped') &&
      (needs.stage3-cloudmap.result == 'success' || needs.stage3-cloudmap.result == 'skipped') &&
      github.event.inputs.action != 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '50-alb')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 50-alb
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  # Stage 5: ECS
  stage5-ecs:
    name: "Stage5: ECS"
    needs:
      - approval
      - stage1-vpc
      - stage1-iam
      - stage2-cloudwatch-logs
      - stage2-ecr
      - stage2-s3
      - stage3-security-groups
      - stage3-cloudmap
      - stage4-alb
    if: >-
      always() &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage1-iam.result == 'success' || needs.stage1-iam.result == 'skipped') &&
      (needs.stage2-cloudwatch-logs.result == 'success' || needs.stage2-cloudwatch-logs.result == 'skipped') &&
      (needs.stage2-ecr.result == 'success' || needs.stage2-ecr.result == 'skipped') &&
      (needs.stage2-s3.result == 'success' || needs.stage2-s3.result == 'skipped') &&
      (needs.stage3-security-groups.result == 'success' || needs.stage3-security-groups.result == 'skipped') &&
      (needs.stage3-cloudmap.result == 'success' || needs.stage3-cloudmap.result == 'skipped') &&
      (needs.stage4-alb.result == 'success' || needs.stage4-alb.result == 'skipped') &&
      github.event.inputs.action != 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '60-ecs')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 60-ecs
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  # =============================================================================
  # Destroy 역순: Stage 5 → 4 → 3 → 2 → 1
  # =============================================================================

  # Destroy Stage 5: ECS (먼저 삭제)
  destroy-stage5-ecs:
    name: "Destroy-Stage5: ECS"
    needs: [approval]
    if: >-
      always() &&
      needs.approval.result == 'success' &&
      github.event.inputs.action == 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '60-ecs')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 60-ecs
      action: destroy
    secrets: inherit

  # Destroy Stage 4: ALB
  destroy-stage4-alb:
    name: "Destroy-Stage4: ALB"
    needs: [approval, destroy-stage5-ecs]
    if: >-
      always() &&
      needs.approval.result == 'success' &&
      (needs.destroy-stage5-ecs.result == 'success' || needs.destroy-stage5-ecs.result == 'skipped') &&
      github.event.inputs.action == 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '50-alb')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 50-alb
      action: destroy
    secrets: inherit

  # Destroy Stage 3: Security Groups, CloudMap
  destroy-stage3-security-groups:
    name: "Destroy-Stage3: Security Groups"
    needs: [approval, destroy-stage5-ecs, destroy-stage4-alb]
    if: >-
      always() &&
      needs.approval.result == 'success' &&
      (needs.destroy-stage5-ecs.result == 'success' || needs.destroy-stage5-ecs.result == 'skipped') &&
      (needs.destroy-stage4-alb.result == 'success' || needs.destroy-stage4-alb.result == 'skipped') &&
      github.event.inputs.action == 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '30-security-groups')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 30-security-groups
      action: destroy
    secrets: inherit

  destroy-stage3-cloudmap:
    name: "Destroy-Stage3: CloudMap"
    needs: [approval, destroy-stage5-ecs, destroy-stage4-alb]
    if: >-
      always() &&
      needs.approval.result == 'success' &&
      (needs.destroy-stage5-ecs.result == 'success' || needs.destroy-stage5-ecs.result == 'skipped') &&
      (needs.destroy-stage4-alb.result == 'success' || needs.destroy-stage4-alb.result == 'skipped') &&
      github.event.inputs.action == 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '40-cloudmap')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 40-cloudmap
      action: destroy
    secrets: inherit

  # Destroy Stage 2: CloudWatch Logs, ECR, S3
  destroy-stage2-cloudwatch-logs:
    name: "Destroy-Stage2: CloudWatch Logs"
    needs: [approval, destroy-stage3-security-groups, destroy-stage3-cloudmap]
    if: >-
      always() &&
      needs.approval.result == 'success' &&
      (needs.destroy-stage3-security-groups.result == 'success' || needs.destroy-stage3-security-groups.result == 'skipped') &&
      (needs.destroy-stage3-cloudmap.result == 'success' || needs.destroy-stage3-cloudmap.result == 'skipped') &&
      github.event.inputs.action == 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '05-cloudwatch-logs')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 05-cloudwatch-logs
      action: destroy
    secrets: inherit

  destroy-stage2-ecr:
    name: "Destroy-Stage2: ECR"
    needs: [approval, destroy-stage3-security-groups, destroy-stage3-cloudmap]
    if: >-
      always() &&
      needs.approval.result == 'success' &&
      (needs.destroy-stage3-security-groups.result == 'success' || needs.destroy-stage3-security-groups.result == 'skipped') &&
      (needs.destroy-stage3-cloudmap.result == 'success' || needs.destroy-stage3-cloudmap.result == 'skipped') &&
      github.event.inputs.action == 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '10-ecr')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 10-ecr
      action: destroy
    secrets: inherit

  destroy-stage2-s3:
    name: "Destroy-Stage2: S3"
    needs: [approval, destroy-stage3-security-groups, destroy-stage3-cloudmap]
    if: >-
      always() &&
      needs.approval.result == 'success' &&
      (needs.destroy-stage3-security-groups.result == 'success' || needs.destroy-stage3-security-groups.result == 'skipped') &&
      (needs.destroy-stage3-cloudmap.result == 'success' || needs.destroy-stage3-cloudmap.result == 'skipped') &&
      github.event.inputs.action == 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '15-s3')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 15-s3
      action: destroy
    secrets: inherit

  # Destroy Stage 1: VPC, IAM (마지막에 삭제)
  destroy-stage1-vpc:
    name: "Destroy-Stage1: VPC"
    needs: [approval, destroy-stage2-cloudwatch-logs, destroy-stage2-ecr, destroy-stage2-s3]
    if: >-
      always() &&
      needs.approval.result == 'success' &&
      (needs.destroy-stage2-cloudwatch-logs.result == 'success' || needs.destroy-stage2-cloudwatch-logs.result == 'skipped') &&
      (needs.destroy-stage2-ecr.result == 'success' || needs.destroy-stage2-ecr.result == 'skipped') &&
      (needs.destroy-stage2-s3.result == 'success' || needs.destroy-stage2-s3.result == 'skipped') &&
      github.event.inputs.action == 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '01-vpc')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 01-vpc
      action: destroy
    secrets: inherit

  destroy-stage1-iam:
    name: "Destroy-Stage1: IAM"
    needs: [approval, destroy-stage2-cloudwatch-logs, destroy-stage2-ecr, destroy-stage2-s3]
    if: >-
      always() &&
      needs.approval.result == 'success' &&
      (needs.destroy-stage2-cloudwatch-logs.result == 'success' || needs.destroy-stage2-cloudwatch-logs.result == 'skipped') &&
      (needs.destroy-stage2-ecr.result == 'success' || needs.destroy-stage2-ecr.result == 'skipped') &&
      (needs.destroy-stage2-s3.result == 'success' || needs.destroy-stage2-s3.result == 'skipped') &&
      github.event.inputs.action == 'destroy' &&
      (github.event.inputs.component == 'all' || github.event.inputs.component == '20-iam')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 20-iam
      action: destroy
    secrets: inherit

  # =============================================================================
  # Summary
  # =============================================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs:
      - approval
      # Apply jobs
      - stage1-vpc
      - stage1-iam
      - stage2-cloudwatch-logs
      - stage2-ecr
      - stage2-s3
      - stage3-security-groups
      - stage3-cloudmap
      - stage4-alb
      - stage5-ecs
      # Destroy jobs
      - destroy-stage5-ecs
      - destroy-stage4-alb
      - destroy-stage3-security-groups
      - destroy-stage3-cloudmap
      - destroy-stage2-cloudwatch-logs
      - destroy-stage2-ecr
      - destroy-stage2-s3
      - destroy-stage1-vpc
      - destroy-stage1-iam
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Terraform Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action || 'plan' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Component:** ${{ github.event.inputs.component || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.action }}" == "destroy" ]; then
            echo "### Destroy Results (역순 실행)" >> $GITHUB_STEP_SUMMARY
            echo "| Stage | Component | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| 5 | ECS | ${{ needs.destroy-stage5-ecs.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 4 | ALB | ${{ needs.destroy-stage4-alb.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 3 | Security Groups | ${{ needs.destroy-stage3-security-groups.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 3 | CloudMap | ${{ needs.destroy-stage3-cloudmap.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 2 | CloudWatch Logs | ${{ needs.destroy-stage2-cloudwatch-logs.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 2 | ECR | ${{ needs.destroy-stage2-ecr.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 2 | S3 | ${{ needs.destroy-stage2-s3.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 1 | VPC | ${{ needs.destroy-stage1-vpc.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 1 | IAM | ${{ needs.destroy-stage1-iam.result }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Apply/Plan Results (정순 실행)" >> $GITHUB_STEP_SUMMARY
            echo "| Stage | Component | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| 1 | VPC | ${{ needs.stage1-vpc.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 1 | IAM | ${{ needs.stage1-iam.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 2 | CloudWatch Logs | ${{ needs.stage2-cloudwatch-logs.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 2 | ECR | ${{ needs.stage2-ecr.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 2 | S3 | ${{ needs.stage2-s3.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 3 | Security Groups | ${{ needs.stage3-security-groups.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 3 | CloudMap | ${{ needs.stage3-cloudmap.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 4 | ALB | ${{ needs.stage4-alb.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| 5 | ECS | ${{ needs.stage5-ecs.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
