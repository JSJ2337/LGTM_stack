# LGTM Stack Terraform Infrastructure Pipeline
# GitHub Actions Workflow for Terraform infrastructure management
# 컴포넌트별 순차 실행 방식 (종속성 순서 준수)
# Apply/Destroy 시 한 번만 승인 → 이후 자동 실행

name: Terraform Infrastructure

permissions:
  id-token: write
  contents: read
  pull-requests: write

on:
  push:
    branches:
      - main
      - lgtm_prd
    paths:
      - 'ecs-migration/terraform/**'
      - '.github/workflows/terraform.yaml'

  pull_request:
    branches:
      - main
      - lgtm_prd
    paths:
      - 'ecs-migration/terraform/**'

  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform 작업'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      component:
        description: '대상 컴포넌트 (all = 전체)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - 01-vpc
          - 05-cloudwatch-logs
          - 10-ecr
          - 15-s3
          - 20-iam
          - 30-security-groups
          - 40-cloudmap
          - 50-alb
          - 60-ecs

env:
  AWS_REGION: ap-northeast-2
  TF_BASE_DIR: ecs-migration/terraform/environments/prod
  TF_VERSION: '1.13.5'
  # 종속성 순서대로 나열
  # Stage 1: VPC, IAM (병렬) - 기본 인프라
  # Stage 2: CloudWatch-Logs, ECR, S3 (병렬) - 독립 리소스
  # Stage 3: Security-Groups, CloudMap (병렬) - VPC 종속
  # Stage 4: ALB - VPC, Security-Groups 종속
  # Stage 5: ECS - 전체 종속

jobs:
  # =============================================================================
  # Detect Changes - 변경된 컴포넌트 감지
  # =============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      components: ${{ steps.detect.outputs.components }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect Changed Components
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.component }}" == "all" ]; then
              echo 'components=["01-vpc","05-cloudwatch-logs","10-ecr","15-s3","20-iam","30-security-groups","40-cloudmap","50-alb","60-ecs"]' >> $GITHUB_OUTPUT
            else
              echo 'components=["${{ github.event.inputs.component }}"]' >> $GITHUB_OUTPUT
            fi
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            CHANGED_DIRS=$(git diff --name-only HEAD~1 HEAD -- 'ecs-migration/terraform/' | \
              grep -oP 'environments/prod/\K[0-9]+-[a-z-]+' | sort -u | tr '\n' ',' | sed 's/,$//')

            if [ -z "$CHANGED_DIRS" ]; then
              echo "components=[]" >> $GITHUB_OUTPUT
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              COMPONENTS=$(echo "$CHANGED_DIRS" | tr ',' '\n' | jq -R . | jq -s .)
              echo "components=$COMPONENTS" >> $GITHUB_OUTPUT
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          fi

  # =============================================================================
  # Approval Gate - Apply/Destroy 시 한 번만 승인
  # =============================================================================
  approval:
    name: "Approval Gate"
    needs: detect-changes
    runs-on: ubuntu-latest
    if: >-
      needs.detect-changes.outputs.has_changes == 'true' &&
      (github.event.inputs.action == 'apply' || github.event.inputs.action == 'destroy')
    environment:
      name: prod
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Approval Confirmed
        run: |
          echo "## ✅ 승인 완료" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Component:** ${{ github.event.inputs.component }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "모든 Stage가 자동으로 실행됩니다." >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Stage 1: 기본 인프라 (VPC, IAM - 병렬 실행)
  # =============================================================================
  stage1-vpc:
    name: "Stage 1: VPC"
    needs: [detect-changes, approval]
    if: >-
      always() &&
      needs.detect-changes.outputs.has_changes == 'true' &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (contains(fromJSON(needs.detect-changes.outputs.components), '01-vpc') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '30-security-groups') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '40-cloudmap') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '50-alb') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '60-ecs'))
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 01-vpc
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  stage1-iam:
    name: "Stage 1: IAM"
    needs: [detect-changes, approval]
    if: >-
      always() &&
      needs.detect-changes.outputs.has_changes == 'true' &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (contains(fromJSON(needs.detect-changes.outputs.components), '20-iam') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '60-ecs'))
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 20-iam
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  # =============================================================================
  # Stage 2: 독립 리소스 (CloudWatch-Logs, ECR, S3 - 병렬 실행)
  # =============================================================================
  stage2-cloudwatch-logs:
    name: "Stage 2: CloudWatch Logs"
    needs: [detect-changes, approval, stage1-vpc, stage1-iam]
    if: >-
      always() &&
      needs.detect-changes.outputs.has_changes == 'true' &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage1-iam.result == 'success' || needs.stage1-iam.result == 'skipped') &&
      (contains(fromJSON(needs.detect-changes.outputs.components), '05-cloudwatch-logs') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '60-ecs'))
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 05-cloudwatch-logs
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  stage2-ecr:
    name: "Stage 2: ECR"
    needs: [detect-changes, approval, stage1-vpc, stage1-iam]
    if: >-
      always() &&
      needs.detect-changes.outputs.has_changes == 'true' &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage1-iam.result == 'success' || needs.stage1-iam.result == 'skipped') &&
      (contains(fromJSON(needs.detect-changes.outputs.components), '10-ecr') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '60-ecs'))
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 10-ecr
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  stage2-s3:
    name: "Stage 2: S3"
    needs: [detect-changes, approval, stage1-vpc, stage1-iam]
    if: >-
      always() &&
      needs.detect-changes.outputs.has_changes == 'true' &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage1-iam.result == 'success' || needs.stage1-iam.result == 'skipped') &&
      (contains(fromJSON(needs.detect-changes.outputs.components), '15-s3') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '60-ecs'))
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 15-s3
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  # =============================================================================
  # Stage 3: VPC 종속 컴포넌트 (Security-Groups, CloudMap - 병렬 실행)
  # =============================================================================
  stage3-security-groups:
    name: "Stage 3: Security Groups"
    needs: [detect-changes, approval, stage1-vpc, stage2-cloudwatch-logs, stage2-ecr, stage2-s3]
    if: >-
      always() &&
      needs.detect-changes.outputs.has_changes == 'true' &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage2-cloudwatch-logs.result == 'success' || needs.stage2-cloudwatch-logs.result == 'skipped') &&
      (needs.stage2-ecr.result == 'success' || needs.stage2-ecr.result == 'skipped') &&
      (needs.stage2-s3.result == 'success' || needs.stage2-s3.result == 'skipped') &&
      (contains(fromJSON(needs.detect-changes.outputs.components), '30-security-groups') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '50-alb') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '60-ecs'))
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 30-security-groups
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  stage3-cloudmap:
    name: "Stage 3: CloudMap"
    needs: [detect-changes, approval, stage1-vpc, stage2-cloudwatch-logs, stage2-ecr, stage2-s3]
    if: >-
      always() &&
      needs.detect-changes.outputs.has_changes == 'true' &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage2-cloudwatch-logs.result == 'success' || needs.stage2-cloudwatch-logs.result == 'skipped') &&
      (needs.stage2-ecr.result == 'success' || needs.stage2-ecr.result == 'skipped') &&
      (needs.stage2-s3.result == 'success' || needs.stage2-s3.result == 'skipped') &&
      (contains(fromJSON(needs.detect-changes.outputs.components), '40-cloudmap') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '60-ecs'))
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 40-cloudmap
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  # =============================================================================
  # Stage 4: ALB (VPC + Security Groups 종속)
  # =============================================================================
  stage4-alb:
    name: "Stage 4: ALB"
    needs: [detect-changes, approval, stage1-vpc, stage3-security-groups, stage3-cloudmap]
    if: >-
      always() &&
      needs.detect-changes.outputs.has_changes == 'true' &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage3-security-groups.result == 'success' || needs.stage3-security-groups.result == 'skipped') &&
      (needs.stage3-cloudmap.result == 'success' || needs.stage3-cloudmap.result == 'skipped') &&
      (contains(fromJSON(needs.detect-changes.outputs.components), '50-alb') ||
       contains(fromJSON(needs.detect-changes.outputs.components), '60-ecs'))
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 50-alb
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  # =============================================================================
  # Stage 5: ECS (전체 종속)
  # =============================================================================
  stage5-ecs:
    name: "Stage 5: ECS"
    needs:
      - detect-changes
      - approval
      - stage1-vpc
      - stage1-iam
      - stage2-cloudwatch-logs
      - stage2-ecr
      - stage2-s3
      - stage3-security-groups
      - stage3-cloudmap
      - stage4-alb
    if: >-
      always() &&
      needs.detect-changes.outputs.has_changes == 'true' &&
      (needs.approval.result == 'success' || needs.approval.result == 'skipped') &&
      contains(fromJSON(needs.detect-changes.outputs.components), '60-ecs') &&
      (needs.stage1-vpc.result == 'success' || needs.stage1-vpc.result == 'skipped') &&
      (needs.stage1-iam.result == 'success' || needs.stage1-iam.result == 'skipped') &&
      (needs.stage2-cloudwatch-logs.result == 'success' || needs.stage2-cloudwatch-logs.result == 'skipped') &&
      (needs.stage2-ecr.result == 'success' || needs.stage2-ecr.result == 'skipped') &&
      (needs.stage2-s3.result == 'success' || needs.stage2-s3.result == 'skipped') &&
      (needs.stage3-security-groups.result == 'success' || needs.stage3-security-groups.result == 'skipped') &&
      (needs.stage3-cloudmap.result == 'success' || needs.stage3-cloudmap.result == 'skipped') &&
      (needs.stage4-alb.result == 'success' || needs.stage4-alb.result == 'skipped')
    uses: ./.github/workflows/terraform-component.yaml
    with:
      component: 60-ecs
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets: inherit

  # =============================================================================
  # Summary
  # =============================================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - approval
      - stage1-vpc
      - stage1-iam
      - stage2-cloudwatch-logs
      - stage2-ecr
      - stage2-s3
      - stage3-security-groups
      - stage3-cloudmap
      - stage4-alb
      - stage5-ecs
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Terraform Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action || 'plan' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Approval:** ${{ needs.approval.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | VPC | ${{ needs.stage1-vpc.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | IAM | ${{ needs.stage1-iam.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | CloudWatch Logs | ${{ needs.stage2-cloudwatch-logs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | ECR | ${{ needs.stage2-ecr.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | S3 | ${{ needs.stage2-s3.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Security Groups | ${{ needs.stage3-security-groups.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | CloudMap | ${{ needs.stage3-cloudmap.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | ALB | ${{ needs.stage4-alb.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | ECS | ${{ needs.stage5-ecs.result }} |" >> $GITHUB_STEP_SUMMARY
