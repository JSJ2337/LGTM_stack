# 작업 이력 - 2026-01-13

## 09:00 - ECS Fargate 마이그레이션 코드 구현

### 변경 사항

#### 1. 디렉토리 구조 생성

- 변경된 파일: `ecs-migration/` 전체 구조
- 변경 내용:
  - `dockerfiles/` - 6개 컴포넌트 Dockerfile
  - `task-definitions/` - ECS Task Definition JSON
  - `terraform/` - Terraform IaC 모듈
  - `.github/workflows/` - GitHub Actions CI/CD
  - `scripts/` - 빌드 및 배포 스크립트
- 이유: 기존 docker-compose 기반 구성을 ECS Fargate로 마이그레이션하기 위한 코드베이스 구축

---

## 09:30 - Dockerfile 작성 (6개 컴포넌트)

### 변경 사항

- 변경된 파일:
  - `dockerfiles/mimir/Dockerfile`
  - `dockerfiles/mimir/config/mimir-config.yaml`
  - `dockerfiles/loki/Dockerfile`
  - `dockerfiles/loki/config/loki-config.yaml`
  - `dockerfiles/tempo/Dockerfile`
  - `dockerfiles/tempo/config/tempo-config.yaml`
  - `dockerfiles/pyroscope/Dockerfile`
  - `dockerfiles/pyroscope/config/pyroscope-config.yaml`
  - `dockerfiles/grafana/Dockerfile`
  - `dockerfiles/grafana/config/provisioning/datasources/datasources.yaml`
  - `dockerfiles/alloy/Dockerfile`
  - `dockerfiles/alloy/config.d/cloudwatch.alloy`

- 변경 내용:
  - 기존 docker-compose 설정 기반 Dockerfile 작성
  - Tini init 시스템 추가 (Graceful Shutdown)
  - Health check 설정
  - ECS Fargate 환경에 맞는 설정 적용
  - CloudMap Service Discovery 연동 설정

- 이유:
  - ECS Fargate에서 컨테이너 실행을 위한 이미지 빌드
  - 기존 EC2 docker-compose 설정과의 호환성 유지

### 영향도

- 영향받는 컴포넌트: Mimir, Loki, Tempo, Pyroscope, Grafana, Alloy
- 주의사항:
  - Mimir/Loki memberlist 설정에서 CloudMap DNS 사용
  - Grafana datasource에서 CloudMap 엔드포인트 사용

---

## 10:00 - ECS Task Definition JSON 작성

### 변경 사항

- 변경된 파일:
  - `task-definitions/mimir.json`
  - `task-definitions/loki.json`
  - `task-definitions/tempo.json`
  - `task-definitions/pyroscope.json`
  - `task-definitions/grafana.json`
  - `task-definitions/alloy.json`

- 변경 내용:
  - 6개 컴포넌트별 Task Definition 작성
  - CloudWatch Logs 설정
  - Health check 설정
  - stopTimeout 120초 설정 (Graceful Shutdown)
  - Secrets Manager 연동 (Grafana 비밀번호)

- 이유: ECS Service 생성을 위한 Task Definition 정의

### 영향도

- 영향받는 컴포넌트: ECS 전체 서비스
- 주의사항: `${AWS_ACCOUNT_ID}` 플레이스홀더를 실제 계정 ID로 교체 필요

---

## 10:30 - Terraform 인프라 코드 작성

### 변경 사항

- 변경된 파일:
  - `terraform/environments/prod/main.tf`
  - `terraform/environments/prod/variables.tf`
  - `terraform/environments/prod/terraform.tfvars.example`
  - `terraform/modules/ecr/main.tf`
  - `terraform/modules/iam/main.tf`
  - `terraform/modules/security-groups/main.tf`
  - `terraform/modules/cloudmap/main.tf`
  - `terraform/modules/alb/main.tf`
  - `terraform/modules/ecs/main.tf`

- 변경 내용:
  - 모듈화된 Terraform 코드 작성
  - ECR 리포지토리 6개
  - IAM Role (Task Execution, Task Role별)
  - Security Groups (ALB, ECS)
  - CloudMap Service Discovery
  - Application Load Balancer
  - ECS Cluster 및 Services

- 이유: 인프라를 코드로 관리하여 재현성 및 버전 관리 확보

### 영향도

- 영향받는 컴포넌트: AWS 인프라 전체
- 주의사항:
  - VPC, Subnet이 사전에 존재해야 함
  - ACM 인증서 ARN 필요
  - terraform.tfvars 파일 설정 필요

---

## 11:00 - GitHub Actions CI/CD Pipeline 작성

### 변경 사항

- 변경된 파일:
  - `.github/workflows/deploy-ecs.yaml`
  - `.github/workflows/terraform.yaml`
  - `.github/workflows/build-only.yaml`

- 변경 내용:
  - ECS 배포 워크플로우 (빌드, 푸시, 배포, 헬스체크)
  - Terraform 워크플로우 (plan, apply, destroy)
  - PR용 빌드 테스트 워크플로우
  - OIDC 기반 AWS 인증
  - Matrix 빌드로 6개 컴포넌트 병렬 처리

- 이유: Jenkins 대신 GitHub Actions 사용 (사용자 요청)

### 영향도

- 영향받는 컴포넌트: CI/CD 파이프라인
- 주의사항:
  - GitHub Secrets 설정 필요 (AWS_ROLE_ARN)
  - AWS IAM OIDC Provider 설정 필요

---

## 11:30 - 빌드 및 배포 스크립트 작성

### 변경 사항

- 변경된 파일:
  - `scripts/build-all.sh`
  - `scripts/deploy-ecs.sh`
  - `scripts/setup-infrastructure.sh`

- 변경 내용:
  - 전체 이미지 빌드 스크립트
  - ECS 배포 스크립트
  - 인프라 초기 설정 스크립트 (ECR, Log Groups, Secrets)

- 이유: 수동 배포 및 로컬 테스트용 스크립트

### 영향도

- 영향받는 컴포넌트: 로컬 개발 환경
- 주의사항: AWS CLI 및 Docker 설치 필요

---

## 12:00 - 문서 업데이트

### 변경 사항

- 변경된 파일:
  - `ecs-migration/README.md`
  - `ecs-migration/docs/work_history/2026-01-13.md`

- 변경 내용:
  - README.md 전체 업데이트 (GitHub Actions 반영)
  - 작업 이력 작성

- 이유: 문서와 코드의 동기화

---

## 요약

### 생성된 파일 목록

```text
ecs-migration/
├── dockerfiles/
│   ├── mimir/
│   │   ├── Dockerfile
│   │   └── config/mimir-config.yaml
│   ├── loki/
│   │   ├── Dockerfile
│   │   └── config/loki-config.yaml
│   ├── tempo/
│   │   ├── Dockerfile
│   │   └── config/tempo-config.yaml
│   ├── pyroscope/
│   │   ├── Dockerfile
│   │   └── config/pyroscope-config.yaml
│   ├── grafana/
│   │   ├── Dockerfile
│   │   └── config/provisioning/datasources/datasources.yaml
│   └── alloy/
│       ├── Dockerfile
│       └── config.d/cloudwatch.alloy
├── task-definitions/
│   ├── mimir.json
│   ├── loki.json
│   ├── tempo.json
│   ├── pyroscope.json
│   ├── grafana.json
│   └── alloy.json
├── terraform/
│   ├── modules/
│   │   ├── ecr/main.tf
│   │   ├── iam/main.tf
│   │   ├── security-groups/main.tf
│   │   ├── cloudmap/main.tf
│   │   ├── alb/main.tf
│   │   └── ecs/main.tf
│   └── environments/prod/
│       ├── main.tf
│       ├── variables.tf
│       └── terraform.tfvars.example
├── .github/workflows/
│   ├── deploy-ecs.yaml
│   ├── terraform.yaml
│   └── build-only.yaml
├── scripts/
│   ├── build-all.sh
│   ├── deploy-ecs.sh
│   └── setup-infrastructure.sh
└── README.md (업데이트)
```

---

## 13:00 - Jenkins 참조 제거 및 GitHub Actions로 변경

### 변경 사항

- 변경된 파일:
  - `ecs-migration/docs/migration-plan.md`
  - `CLAUDE.md`

- 변경 내용:
  - Phase 6 "Jenkins CI/CD 구축" → "GitHub Actions CI/CD 구축"으로 변경
  - Jenkins 관련 Plugin, Credentials 설명 → GitHub Actions Workflow, Secrets 설명으로 변경
  - AWS IAM OIDC Provider 설정 가이드 추가
  - 팀 교육 항목에서 Jenkins → GitHub Actions로 변경
  - 운영 지표 CI/CD 파이프라인 항목 변경
  - CLAUDE.md ECS Migration 섹션 업데이트 (코드 구조, CI/CD 설명 추가)

- 이유: 사용자 요청에 따라 Jenkins 대신 GitHub Actions 사용

### 영향도

- 영향받는 컴포넌트: CI/CD 파이프라인, 문서
- 주의사항: 기존 jenkins_docker 폴더는 다른 프로젝트용으로 별도 유지

---

## 21:58 - AWS IAM Role 생성 (GitHub Actions OIDC용)

### 변경 사항

- 생성된 리소스:
  - IAM Role: `jsj_github_action_LGTM`
  - Role ARN: GitHub Secrets에 저장 (`AWS_ROLE_ARN`)

- 변경 내용:
  - LGTM_stack 저장소 전용 IAM Role 생성
  - 기존 OIDC Provider (`token.actions.githubusercontent.com`) 재사용
  - Trust Policy: `repo:JSJ2337/LGTM_stack:*` 허용
  - 인라인 정책 `LGTM_ECS_Deployment_Policy` 추가

- 포함된 권한:
  - ECR (이미지 빌드/푸시)
  - ECS (서비스 배포)
  - IAM (Task Role 관리)
  - EC2 (Security Group, VPC)
  - ALB (로드밸런서)
  - CloudMap (Service Discovery)
  - CloudWatch Logs
  - S3/DynamoDB (Terraform State)
  - Secrets Manager
  - Route53

- 이유: GitHub Actions에서 AWS 리소스 접근을 위한 OIDC 인증용 Role 필요

### 영향도

- 영향받는 컴포넌트: GitHub Actions CI/CD
- 주의사항: GitHub Secrets에 `AWS_ROLE_ARN` 설정 완료

---

## 22:00 - GitHub Secrets 설정 완료

### 변경 사항

- 설정된 Secret:
  - Name: `AWS_ROLE_ARN`
  - Value: IAM Role ARN (민감정보 - 직접 기록하지 않음)

- 이유: GitHub Actions 워크플로우에서 AWS OIDC 인증에 사용

---

## 22:10 - VPC 모듈 및 Terraform 설정 완료

### 변경 사항

- 변경된 파일:
  - `terraform/modules/vpc/main.tf` (신규)
  - `terraform/environments/prod/main.tf`
  - `terraform/environments/prod/variables.tf`
  - `terraform/environments/prod/terraform.tfvars` (신규)

- 변경 내용:
  - VPC 모듈 신규 생성 (Public/Private Subnets, NAT Gateway, Route Tables)
  - main.tf에서 data source 대신 VPC 모듈 사용하도록 변경
  - S3 Backend 설정 활성화
  - terraform.tfvars 사용자 설정 파일 작성

- 이유: jsj-aws-training 계정에 기존 VPC가 없어서 새로 생성 필요

### 영향도

- 영향받는 컴포넌트: 전체 인프라
- 주의사항: S3 버킷과 DynamoDB 테이블은 미리 CLI로 생성 필요

---

## 22:12 - GitHub Actions 워크플로우 위치 수정

### 변경 사항

- 변경된 파일:
  - `.github/workflows/` (루트로 복사)

- 변경 내용:
  - `ecs-migration/.github/workflows/`에서 루트 `.github/workflows/`로 이동
  - GitHub가 워크플로우를 인식하도록 수정

- 이유: GitHub Actions는 저장소 루트의 `.github/workflows/`만 인식

---

## 22:14 - ECS 모듈 AWS Provider 5.x 호환 수정

### 변경 사항

- 변경된 파일:
  - `terraform/modules/ecs/main.tf`

- 변경 내용:
  - `deployment_configuration` 블록을 속성으로 변경
  - `deployment_maximum_percent`, `deployment_minimum_healthy_percent` 사용

- 이유: AWS Provider 5.x에서 블록 형식 deprecated

---

## 22:17 - IAM 권한 업데이트

### 변경 사항

- 변경된 리소스:
  - IAM Policy `LGTM_ECS_Deployment_Policy`

- 변경 내용:
  - EC2 전체 권한 추가 (`ec2:*`)
  - Route53 전체 권한 추가 (`route53:*`)
  - ECR 전체 권한 추가 (`ecr:*`)

- 이유: VPC 생성, CloudMap 연동에 필요한 권한 부족 해결

---

## 22:25 - Terraform Apply 성공

### 변경 사항

- 생성된 리소스:
  - VPC, Subnets, NAT Gateway, Route Tables
  - ECS Cluster: `lgtm-prod-cluster`
  - ECR Repositories: 6개
  - ALB, Target Groups, Listener Rules
  - CloudMap Namespace: `lgtm.local`
  - Security Groups
  - IAM Roles

- ALB DNS: (AWS Console에서 확인)

### 영향도

- ECS Tasks가 Pending 상태 (Docker 이미지 없음)
- 다음 단계: Docker 이미지 빌드 및 ECR 푸시 필요

---

## 22:35 - terraform.tfvars 사용자 설정 파일 개선

### 변경 사항

- 변경된 파일:
  - `terraform/environments/prod/terraform.tfvars`

- 변경 내용:
  - 섹션별 주석 추가 (기본 설정, VPC, 스토리지, 서비스 등)
  - 사용자가 이 파일만 수정하면 되도록 구조화
  - Backend 설정은 main.tf 수정 필요함을 안내

- 이유: 사용자 편의성 향상

---

## 현재 완료 상태

### 완료된 작업

- [x] ECS 마이그레이션 코드 작성 (Dockerfile, Task Definition, Terraform)
- [x] GitHub Actions 워크플로우 작성
- [x] AWS OIDC Provider 확인 (기존 설정 재사용)
- [x] IAM Role 생성 (`jsj_github_action_LGTM`)
- [x] GitHub Secrets 설정 (`AWS_ROLE_ARN`)
- [x] VPC 모듈 생성
- [x] S3/DynamoDB Terraform State Backend 생성 (CLI)
- [x] Terraform Apply 성공 (인프라 생성 완료)
- [x] terraform.tfvars 사용자 설정 파일 개선

### 다음 단계

1. **Docker 이미지 빌드** - 6개 컴포넌트 빌드
2. **ECR 푸시** - 이미지 업로드
3. **ECS 서비스 확인** - Running 상태 확인
4. **Grafana 접속 테스트** - ALB DNS로 접속

---

## 23:00 - Terraform 모듈 구조 리팩토링 (Best Practices 적용)

### 변경 사항

#### 변경 배경

- 기존 구조: 모듈별 단일 `main.tf`에 variables, resources, outputs 혼재
- 문제점: Terraform Best Practices 위반 (파일 분리 미흡, 재사용성 저하)
- 요청: "모듈은 모듈로 만들고 레이어에서 모듈을 호출하는 형식"으로 재구성

#### 1. 모듈 구조 리팩토링 (7개 모듈)

모든 모듈을 `main.tf`, `variables.tf`, `outputs.tf` 3파일 구조로 분리:

| 모듈 | 변경 전 | 변경 후 |
|------|---------|---------|
| VPC | main.tf (all-in-one) | main.tf, variables.tf, outputs.tf |
| ECR | main.tf (all-in-one) | main.tf, variables.tf, outputs.tf |
| IAM | main.tf (all-in-one) | main.tf, variables.tf, outputs.tf |
| Security Groups | main.tf (all-in-one) | main.tf, variables.tf, outputs.tf |
| CloudMap | main.tf (all-in-one) | main.tf, variables.tf, outputs.tf |
| ALB | main.tf (all-in-one) | main.tf, variables.tf, outputs.tf |
| ECS | main.tf (all-in-one) | main.tf, variables.tf, outputs.tf |

#### 2. 변수화 및 설정 가능성 개선

- **Security Groups**: `alb_ingress_rules`, `ecs_service_ports`를 map 타입 변수로 변경
- **CloudMap**: `services` 리스트를 변수로 분리, `for_each` 사용
- **ALB**: `health_check_config` 객체 변수로 분리
- **ECS**: `service_config`, `log_retention_days` 등 변수 추가

#### 3. environments/prod 레이어 업데이트

- `main.tf`: 모듈 호출만 포함 (리소스 정의 없음)
- `variables.tf`: 모든 설정 가능한 변수 정의
- `outputs.tf`: 별도 파일로 분리
- `terraform.tfvars`: 사용자 설정 단일 포인트

### 변경된 파일 목록

```text
terraform/modules/vpc/
├── main.tf      (수정 - 리소스만)
├── variables.tf (신규)
└── outputs.tf   (신규)

terraform/modules/ecr/
├── main.tf      (수정 - 리소스만)
├── variables.tf (수정 - project_name 추가)
└── outputs.tf   (신규)

terraform/modules/iam/
├── main.tf      (수정 - 리소스만, project_name 적용)
├── variables.tf (신규)
└── outputs.tf   (신규)

terraform/modules/security-groups/
├── main.tf      (수정 - 리소스만, 변수 참조)
├── variables.tf (수정 - map 타입으로 변경)
└── outputs.tf   (신규)

terraform/modules/cloudmap/
├── main.tf      (수정 - for_each 사용)
├── variables.tf (수정 - services 리스트 추가)
└── outputs.tf   (수정 - for 표현식 사용)

terraform/modules/alb/
├── main.tf      (수정 - 리소스만)
├── variables.tf (수정 - health_check_config 추가)
└── outputs.tf   (수정 - 추가 outputs)

terraform/modules/ecs/
├── main.tf      (수정 - 리소스만, Service Discovery 통합)
├── variables.tf (수정 - 완전한 변수 정의)
└── outputs.tf   (수정)

terraform/environments/prod/
├── main.tf      (수정 - 모듈 호출만)
├── variables.tf (수정 - 완전한 변수 정의)
├── outputs.tf   (신규 - 별도 파일)
└── terraform.tfvars (수정 - 전체 설정 포함)
```

### 주요 개선 사항

1. **파일 분리**: 각 모듈이 main.tf, variables.tf, outputs.tf로 명확히 분리
2. **변수화**: 하드코딩된 값을 변수로 추출하여 재사용성 향상
3. **태그 일관성**: 모든 모듈에서 `var.tags` 사용
4. **네이밍**: `var.project_name` 변수로 리소스 이름 통일
5. **레이어 분리**: environments/prod는 모듈 호출만 담당

### 리팩토링 영향도

- 영향받는 컴포넌트: Terraform 인프라 전체
- 기존 리소스: 변경 없음 (리팩토링은 코드 구조만 변경)
- 주의사항: `terraform.tfvars` 설정 확인 필요

---

## 23:20 - Terraform 구조 최종 리팩토링 (서비스별 루트 모듈 분리)

### 변경 사항

#### 변경 배경

- 이전 구조: `environments/prod/main.tf`에서 모든 모듈을 한 번에 호출
- 문제점: 모듈별 독립적인 배포/관리 불가, state 파일이 하나로 통합
- 요청: "prod 밑에 각 모듈별로 root module을 만드는 것이 정석"

#### 새로운 구조

```text
terraform/
├── modules/                    # 재사용 가능한 모듈 (하드코딩 제거)
│   ├── vpc/
│   ├── ecr/
│   ├── iam/
│   ├── security-groups/
│   ├── cloudmap/
│   ├── alb/
│   └── ecs/
└── environments/prod/
    ├── common.tfvars          # 공통 설정
    ├── README.md              # 배포 가이드
    ├── 01-vpc/                # VPC 루트 모듈 (순서 1)
    ├── 10-ecr/                # ECR 루트 모듈 (순서 2)
    ├── 20-iam/                # IAM 루트 모듈 (순서 3)
    ├── 30-security-groups/    # Security Groups 루트 모듈 (순서 4)
    ├── 40-cloudmap/           # CloudMap 루트 모듈 (순서 5)
    ├── 50-alb/                # ALB 루트 모듈 (순서 6)
    └── 60-ecs/                # ECS 루트 모듈 (순서 7)
```

#### 주요 변경 내용

1. **폴더 넘버링**: 배포 순서에 따라 01, 10, 20... 번호 부여
2. **common.tfvars**: 공통 설정 (aws_region, project_name, tags 등)
3. **모듈 하드코딩 제거**: 모든 default 값 제거, 루트 모듈에서 설정
4. **terraform_remote_state**: 모듈 간 종속성을 remote state로 참조
5. **독립적 state 파일**: 각 모듈별 별도 state 관리

#### 배포 순서 및 종속성

| 순서 | 폴더 | 종속성 |
|------|------|--------|
| 1 | 01-vpc | 없음 |
| 2 | 10-ecr | 없음 (병렬 가능) |
| 3 | 20-iam | 없음 (병렬 가능) |
| 4 | 30-security-groups | 01-vpc |
| 5 | 40-cloudmap | 01-vpc |
| 6 | 50-alb | 01-vpc, 30-security-groups |
| 7 | 60-ecs | 모든 이전 모듈 |

#### 사용법

```bash
# 각 모듈별 배포
cd 01-vpc
terraform init
terraform apply -var-file="../common.tfvars" -var-file="terraform.tfvars"
```

### 변경된 파일 목록

#### 신규 생성

```text
environments/prod/
├── common.tfvars
├── README.md
├── 01-vpc/{main.tf, variables.tf, outputs.tf, terraform.tfvars}
├── 10-ecr/{main.tf, variables.tf, outputs.tf, terraform.tfvars}
├── 20-iam/{main.tf, variables.tf, outputs.tf, terraform.tfvars}
├── 30-security-groups/{main.tf, variables.tf, outputs.tf, terraform.tfvars}
├── 40-cloudmap/{main.tf, variables.tf, outputs.tf, terraform.tfvars}
├── 50-alb/{main.tf, variables.tf, outputs.tf, terraform.tfvars}
└── 60-ecs/{main.tf, variables.tf, outputs.tf, terraform.tfvars}
```

#### 수정됨 (하드코딩 제거)

```text
modules/vpc/variables.tf      # default 값 제거
modules/ecr/variables.tf      # default 값 제거
modules/iam/variables.tf      # default 값 제거
modules/security-groups/variables.tf  # default 값 제거
modules/cloudmap/variables.tf # default 값 제거, project_name 추가
modules/alb/variables.tf      # default 값 제거
modules/ecs/variables.tf      # default 값 제거
```

#### 삭제됨

```text
environments/prod/main.tf           # 삭제 (각 폴더로 분리)
environments/prod/variables.tf      # 삭제
environments/prod/outputs.tf        # 삭제
environments/prod/terraform.tfvars  # 삭제 (common.tfvars로 대체)
```

### 영향도

- 영향받는 컴포넌트: Terraform 전체 구조
- State 파일: 7개 독립 state로 분리됨
- 주의사항: 기존 state가 있다면 마이그레이션 필요

---

## 23:30 - AWS Provider 5.x Deprecated 경고 수정

### 변경 사항

- 변경된 파일:
  - `terraform/modules/ecs/main.tf`

- 변경 내용:
  - Service Discovery 리소스의 `failure_threshold = 1` 속성 제거
  - AWS Provider 5.x에서 deprecated된 속성
  - 6개 리소스 수정: mimir, loki, tempo, pyroscope, grafana, alloy

- 변경 전:

  ```hcl
  health_check_custom_config {
    failure_threshold = 1
  }
  ```

- 변경 후:

  ```hcl
  health_check_custom_config {}
  ```

- 이유: VSCode 경고 메시지 해결 (AWS Provider 5.x 호환성)

### 영향도

- 영향받는 컴포넌트: ECS Service Discovery
- 주의사항: 기능 변경 없음 (deprecated 속성 제거만)

---

**작성일:** 2026-01-13
**작성자:** jsj
**프로젝트:** LGTM_PRD ECS Fargate Migration
