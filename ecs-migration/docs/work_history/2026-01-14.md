# 작업 이력 - 2026-01-14

## 09:00 - Terraform 모듈 구조 리팩토링 (Best Practices 적용)

### 개요

Terraform 폴더 구조를 Best Practices 기준으로 검토하고, 식별된 Critical/High/Medium 이슈를 모두 개선했습니다.
기존 점수 7.4/10에서 개선 작업을 통해 코드 품질과 유지보수성을 향상시켰습니다.

---

## 09:30 - CloudMap 중복 정의 제거

### 변경 사항

- 변경된 파일: `modules/ecs/main.tf`
  - CloudMap aws_service_discovery_service 리소스 제거 (6개 서비스)
  - ECS service의 service_registries에서 `var.cloudmap_service_arns["service_name"]` 사용으로 변경
- 변경된 파일: `modules/ecs/variables.tf`
  - `cloudmap_namespace_id` 변수 → `cloudmap_service_arns` 변수로 대체
  - `cloudmap_namespace_name` 변수 추가
- 변경된 파일: `environments/prod/60-ecs/main.tf`
  - cloudmap_service_arns 및 cloudmap_namespace_name 전달
- 변경된 파일: `modules/cloudmap/outputs.tf`
  - alloy_service_arn output 추가

### 이유

- DRY 원칙 위반: CloudMap 서비스가 `cloudmap` 모듈과 `ecs` 모듈에서 중복 정의됨
- 모듈 간 책임 분리: CloudMap 리소스는 cloudmap 모듈에서만 관리

### 영향도

- ECS 모듈: service_registries 참조 방식 변경
- CloudMap 모듈: 모든 서비스 ARN 출력 필요

---

## 10:00 - Alloy 환경변수 변수화

### 변경 사항

- 변경된 파일: `modules/ecs/main.tf`
  - Alloy task definition의 하드코딩된 환경변수를 변수 참조로 변경
  - LOKI_TENANT, MIMIR_TENANT 등 테넌트 정보 변수화
  - CloudMap namespace를 동적으로 참조
- 변경된 파일: `modules/ecs/variables.tf`
  - `alloy_config` 변수 추가 (loki_tenant, mimir_tenant)
- 변경된 파일: `environments/prod/60-ecs/main.tf`
  - alloy_config 변수 전달
- 변경된 파일: `environments/prod/60-ecs/variables.tf`
  - alloy_config 변수 선언 추가
- 변경된 파일: `environments/prod/common.tfvars`
  - alloy_config 기본값 설정

### 이유

- 환경별 설정 분리 필요
- 하드코딩 제거로 재사용성 향상

### 영향도

- 새로운 환경(dev, staging) 추가 시 common.tfvars만 수정하면 됨

---

## 10:30 - ALB 리스너 규칙 완성

### 변경 사항

- 변경된 파일: `modules/alb/main.tf`
  - Pyroscope target group 추가 (port 4040)
  - Pyroscope HTTP/HTTPS 리스너 규칙 추가 (priority 40)
  - Tempo 리스너 규칙에 `/tempo/*` 경로 패턴 추가
- 변경된 파일: `modules/alb/outputs.tf`
  - `target_group_arns` map output 추가 (개별 output 유지, map으로 통합 제공)
- 변경된 파일: `modules/ecs/main.tf`
  - Pyroscope ECS 서비스에 load_balancer 블록 추가
- 변경된 파일: `modules/ecs/variables.tf`
  - `pyroscope_target_group_arn` 변수 추가
- 변경된 파일: `environments/prod/60-ecs/main.tf`
  - pyroscope_target_group_arn 전달

### 이유

- Pyroscope 서비스가 ALB를 통한 외부 접근 불가 상태였음
- 경로 패턴 불일치로 일부 요청 라우팅 실패 가능성

### 영향도

- Pyroscope 외부 접근 가능
- ALB 리스너 규칙 완성

---

## 11:00 - IAM alloy_task 권한 정밀화

### 변경 사항

- 변경된 파일: `modules/iam/main.tf`
  - alloy_cloudwatch_access 정책을 세분화된 Statement로 분리
  - 각 Statement에 Sid 추가 (CloudWatchMetricsReadOnly, CloudWatchLogsReadOnly 등)
  - 가능한 경우 Resource를 특정 ARN으로 제한
- 변경된 파일: `modules/iam/variables.tf`
  - `aws_region`, `aws_account_id` 변수 추가
- 변경된 파일: `environments/prod/20-iam/main.tf`
  - aws_caller_identity data source 추가
  - aws_region, aws_account_id 변수 전달

### 이유

- IAM 최소 권한 원칙 (Least Privilege) 적용
- 보안 감사 대응 용이
- 어떤 권한이 왜 필요한지 명확한 문서화

### 영향도

- 기능적 변화 없음 (읽기 권한만 사용)
- 보안 강화

---

## 11:30 - Grafana IAM 정책 추가

### 변경 사항

- 변경된 파일: `modules/iam/main.tf`
  - grafana_cloudwatch_access 정책 추가
  - CloudWatch Metrics 읽기 권한
  - CloudWatch Logs 읽기 권한
  - EC2 Describe 권한 (인스턴스 메타데이터)
  - Tag 읽기 권한

### 이유

- Grafana에서 CloudWatch 데이터소스 직접 연결 시 필요
- AWS 리소스 탐색 기능 활성화

### 영향도

- Grafana에서 CloudWatch 데이터소스 사용 가능

---

## 12:00 - 로그 그룹 네이밍 표준화

### 변경 사항

- 변경된 파일: `modules/ecs/main.tf`
  - 모든 task definition의 awslogs-group 변경
  - 변경 전: `/ecs/${project_name}-${service}`
  - 변경 후: `/ecs/${project_name}-${environment}/${service}`
  - 영향받는 서비스: mimir, loki, tempo, pyroscope, grafana, alloy

### 이유

- 환경별 로그 분리 (prod/dev/staging)
- CloudWatch 로그 그룹 탐색 용이
- 비용 추적 개선

### 영향도

- 새로운 로그 그룹 생성됨
- 기존 로그 그룹은 수동 삭제 필요 (선택)

---

## 12:30 - 변경 사항 요약

### 수정된 파일 목록

| 파일 | 변경 유형 |
|------|---------|
| modules/ecs/main.tf | 수정 |
| modules/ecs/variables.tf | 수정 |
| modules/alb/main.tf | 수정 |
| modules/alb/outputs.tf | 수정 |
| modules/iam/main.tf | 수정 |
| modules/iam/variables.tf | 수정 |
| modules/cloudmap/outputs.tf | 수정 |
| environments/prod/20-iam/main.tf | 수정 |
| environments/prod/60-ecs/main.tf | 수정 |
| environments/prod/60-ecs/variables.tf | 수정 |
| environments/prod/common.tfvars | 수정 |

### Best Practices 개선 항목

| 항목 | 상태 |
|------|------|
| CloudMap 중복 정의 제거 | 완료 |
| Alloy 환경변수 변수화 | 완료 |
| ALB 리스너 규칙 완성 | 완료 |
| IAM 권한 정밀화 | 완료 |
| Grafana IAM 정책 추가 | 완료 |
| 로그 그룹 네이밍 표준화 | 완료 |

### 다음 단계

- `terraform plan`으로 변경 사항 검증
- 각 모듈 순서대로 apply (01-vpc → 05-cloudwatch-logs → 10-ecr → 20-iam → 30-security-groups → 40-cloudmap → 50-alb → 60-ecs)
- 기존 CloudWatch 로그 그룹 정리 (선택)

---

## 14:00 - CloudWatch Logs 모듈 분리

### 개요

ECS 모듈에서 CloudWatch Log Groups를 별도 모듈로 분리하여 단일 책임 원칙(SRP)을 적용했습니다.

### 변경 사항

- 신규 파일: `modules/cloudwatch-logs/main.tf`
  - aws_cloudwatch_log_group 리소스를 for_each로 생성
  - 서비스별 retention_days 오버라이드 지원
- 신규 파일: `modules/cloudwatch-logs/variables.tf`
  - services, default_retention_days 변수 정의
- 신규 파일: `modules/cloudwatch-logs/outputs.tf`
  - log_group_names, log_group_arns map 출력
- 신규 파일: `environments/prod/05-cloudwatch-logs/main.tf`
  - CloudWatch Logs 루트 모듈 생성
- 신규 파일: `environments/prod/05-cloudwatch-logs/variables.tf`
- 신규 파일: `environments/prod/05-cloudwatch-logs/outputs.tf`
- 변경된 파일: `modules/ecs/main.tf`
  - aws_cloudwatch_log_group 리소스 제거
  - Task Definition에서 var.log_group_names["service"] 참조
- 변경된 파일: `modules/ecs/variables.tf`
  - log_retention_days → log_group_names 변수로 변경
- 변경된 파일: `environments/prod/60-ecs/main.tf`
  - cloudwatch_logs remote state 추가
  - log_group_names 변수 전달
- 변경된 파일: `environments/prod/60-ecs/variables.tf`
  - log_retention_days 변수 제거
- 변경된 파일: `environments/prod/common.tfvars`
  - log_services 설정 추가

### 이유

- 단일 책임 원칙(SRP) 적용: ECS 모듈은 컴퓨팅만 담당
- 라이프사이클 분리: 로그 그룹은 ECS와 독립적으로 관리
- 재사용성: 다른 서비스(Lambda 등)에서도 동일 패턴 사용 가능
- 로그 보존: ECS 재배포해도 로그 그룹 유지

### 영향도

- 신규 모듈 실행 순서: 05-cloudwatch-logs (VPC와 병렬 가능)
- ECS 모듈은 CloudWatch Logs 모듈에 의존
- 기존 로그 그룹은 import 또는 재생성 필요

### 새로운 모듈 실행 순서

```text
01-vpc           (네트워크)
05-cloudwatch-logs (로깅) ← 신규
10-ecr           (컨테이너 레지스트리)
20-iam           (권한)
30-security-groups (보안)
40-cloudmap      (서비스 디스커버리)
50-alb           (로드밸런서)
60-ecs           (컴퓨팅)
```

---

## 15:00 - common.tfvars 통합 및 Security Groups 동적 확장성 개선

### 개요

모든 설정을 common.tfvars 하나로 통합하고, Security Groups 모듈을 동적으로 확장 가능하도록 개선했습니다.

### 변경 사항

#### 1. common.tfvars 통합

모든 루트 모듈별 terraform.tfvars 설정을 common.tfvars로 이동:

- 변경된 파일: `environments/prod/common.tfvars`
  - `state_bucket` 추가
  - VPC 설정 통합 (`vpc_cidr`, `availability_zones`, 서브넷)
  - ECR 설정 통합 (`ecr_repositories`, `ecr_*` 변수)
  - CloudMap 설정 통합 (`cloudmap_namespace_name`, `cloudmap_services`, `cloudmap_dns_ttl`)
  - ALB 설정 통합 (`alb_internal`, `alb_enable_deletion_protection`, `alb_certificate_arn`, `alb_health_check_config`)
  - Security Groups 설정 통합 (`alb_ingress_rules`, `ecs_service_ports`)

- 변경된 파일: `environments/prod/*/terraform.tfvars` (8개 파일)
  - 모든 설정 제거, 주석으로 참조 정보만 남김
  - 사용법: `terraform apply -var-file="../common.tfvars"` (단일 파일만 사용)

#### 2. 변수명 표준화

- 변경된 파일: `environments/prod/10-ecr/variables.tf`, `main.tf`
  - `repositories` → `ecr_repositories`
  - `image_tag_mutability` → `ecr_image_tag_mutability`
  - `scan_on_push` → `ecr_scan_on_push`
  - `lifecycle_policy_keep_count` → `ecr_lifecycle_policy_keep_count`
  - `lifecycle_policy_untagged_days` → `ecr_lifecycle_policy_untagged_days`
- 변경된 파일: `environments/prod/40-cloudmap/variables.tf`, `main.tf`
  - `namespace_name` → `cloudmap_namespace_name`
  - `services` → `cloudmap_services`
  - `dns_ttl` → `cloudmap_dns_ttl`
- 변경된 파일: `environments/prod/50-alb/variables.tf`, `main.tf`
  - `internal` → `alb_internal`
  - `enable_deletion_protection` → `alb_enable_deletion_protection`
  - `certificate_arn` → `alb_certificate_arn`
  - `health_check_config` → `alb_health_check_config`

#### 3. Security Groups 모듈 동적 확장성 개선

- 변경된 파일: `modules/security-groups/variables.tf`
  - `ecs_service_ports`에 `from_alb`과 `internal` optional 속성 추가
- 변경된 파일: `modules/security-groups/main.tf`
  - 하드코딩된 ingress 규칙 제거 (약 130줄 → 40줄)
  - `local.alb_ingress_ports`: `from_alb = true`인 포트만 필터링
  - `local.internal_ports`: `internal = true`인 포트만 필터링
  - `dynamic "ingress"` 블록으로 동적 생성
- 변경된 파일: `environments/prod/common.tfvars`
  - `ecs_service_ports`에 `from_alb`과 `internal` 속성 추가

### 사용 방법

#### 새로운 포트/서비스 추가

common.tfvars의 `ecs_service_ports`에 항목 추가:

```hcl
new_service = {
  port        = 8888
  protocol    = "tcp"
  description = "New Service HTTP"
  from_alb    = true   # ALB에서 트래픽 허용
  internal    = true   # 내부 통신 허용
}
```

#### terraform apply 실행

```bash
cd environments/prod/30-security-groups
terraform apply -var-file="../common.tfvars"
```

### 이유

- DRY 원칙: 설정 중복 제거
- 유지보수성: 설정 변경 시 common.tfvars 하나만 수정
- 확장성: 모듈 코드 수정 없이 tfvars만으로 규칙 추가 가능
- 일관성: 변수명에 접두사(ecr_, cloudmap_, alb_) 추가로 명확성 향상

### 영향도

- 기존 terraform apply 명령 변경: `-var-file` 하나만 사용
- Security Groups 모듈: 규칙 추가 시 모듈 수정 불필요

### 변경된 파일 상세

| 파일 | 변경 유형 |
|------|---------|
| environments/prod/common.tfvars | 수정 (통합) |
| environments/prod/01-vpc/terraform.tfvars | 수정 (최소화) |
| environments/prod/05-cloudwatch-logs/terraform.tfvars | 신규 |
| environments/prod/10-ecr/terraform.tfvars | 수정 (최소화) |
| environments/prod/10-ecr/variables.tf | 수정 (변수명) |
| environments/prod/10-ecr/main.tf | 수정 (변수 참조) |
| environments/prod/20-iam/terraform.tfvars | 수정 (최소화) |
| environments/prod/30-security-groups/terraform.tfvars | 수정 (최소화) |
| environments/prod/40-cloudmap/terraform.tfvars | 수정 (최소화) |
| environments/prod/40-cloudmap/variables.tf | 수정 (변수명) |
| environments/prod/40-cloudmap/main.tf | 수정 (변수 참조) |
| environments/prod/50-alb/terraform.tfvars | 수정 (최소화) |
| environments/prod/50-alb/variables.tf | 수정 (변수명) |
| environments/prod/50-alb/main.tf | 수정 (변수 참조) |
| environments/prod/60-ecs/terraform.tfvars | 수정 (최소화) |
| modules/security-groups/main.tf | 수정 (동적 생성) |
| modules/security-groups/variables.tf | 수정 (속성 추가) |

---

## 16:00 - HashiCorp Best Practices 완전 준수 (versions.tf, validation, sensitive)

### 개요

HashiCorp 공식 권장사항 및 커뮤니티 Best Practices를 100% 준수하도록 개선했습니다.
기존 8.4/10 점수에서 개선 작업을 통해 완전 준수 상태로 향상시켰습니다.

### 변경 사항

#### 1. 모든 모듈에 versions.tf 추가

8개 모듈에 Terraform 및 Provider 버전 제약 파일 생성:

- 신규 파일: `modules/vpc/versions.tf`
- 신규 파일: `modules/ecr/versions.tf`
- 신규 파일: `modules/iam/versions.tf`
- 신규 파일: `modules/security-groups/versions.tf`
- 신규 파일: `modules/cloudmap/versions.tf`
- 신규 파일: `modules/cloudwatch-logs/versions.tf`
- 신규 파일: `modules/alb/versions.tf`
- 신규 파일: `modules/ecs/versions.tf`

내용:

```hcl
terraform {
  required_version = ">= 1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}
```

#### 2. 변수 validation 블록 추가

모든 모듈의 variables.tf에 입력값 검증 추가:

| 모듈 | 추가된 validation |
|------|------------------|
| vpc | project_name, environment, vpc_cidr, availability_zones, public/private_subnet_cidrs |
| ecr | repositories, image_tag_mutability, lifecycle_policy_* |
| iam | s3_bucket_name, aws_region, aws_account_id |
| security-groups | vpc_id, vpc_cidr, alb_ingress_rules (port, protocol), ecs_service_ports |
| cloudmap | vpc_id, namespace_name, services, dns_ttl |
| cloudwatch-logs | services (retention_days), default_retention_days |
| alb | vpc_id, public_subnet_ids, security_group_id, certificate_arn, service_config (cpu, memory, port), health_check_config |
| ecs | vpc_id, private_subnet_ids, role_arns, target_group_arns, service_config, s3_bucket_name, alloy_config |

주요 검증 규칙:

- `project_name`: 소문자, 숫자, 하이픈만 허용
- `environment`: dev, staging, prod 중 하나
- `vpc_cidr`: 유효한 CIDR 블록
- `availability_zones`: 최소 2개 필요
- `cpu`: Fargate 유효값 (256, 512, 1024, 2048, 4096, 8192, 16384)
- `memory`: 512-122880 범위
- `container_port`: 1-65535 범위
- `retention_days`: CloudWatch Logs 유효값 (1, 3, 5, 7, 14, 30, 60, 90, ...)
- `aws_account_id`: 12자리 숫자

#### 3. sensitive 플래그 추가

민감 정보 노출 방지를 위한 sensitive 플래그 추가:

- 변경된 파일: `modules/iam/variables.tf`
  - `aws_account_id`: `sensitive = true` 추가
- 변경된 파일: `modules/ecs/variables.tf`
  - `aws_account_id`: `sensitive = true` 추가
  - `execution_role_arn`: `sensitive = true` 추가
  - `*_task_role_arn` (7개): `sensitive = true` 추가
- 변경된 파일: `modules/iam/outputs.tf`
  - `task_execution_role_arn`: `sensitive = true` 추가
  - `*_task_role_arn` (8개): `sensitive = true` 추가

### 이유

- HashiCorp 공식 권장: 모든 모듈에 versions.tf 필수
- terraform-best-practices.com 권장: validation 블록으로 잘못된 입력 사전 차단
- 보안 강화: IAM Role ARN, Account ID 등 민감 정보 노출 방지

### 영향도

- `terraform plan` 시 잘못된 입력값 즉시 오류 발생 (런타임 오류 사전 방지)
- `terraform output` 시 sensitive 값 마스킹 (`<sensitive>`)
- 모듈 버전 호환성 명확화

### 변경된 파일 요약

| 파일 | 변경 유형 |
|------|---------|
| modules/*/versions.tf (8개) | 신규 |
| modules/vpc/variables.tf | 수정 (validation 추가) |
| modules/ecr/variables.tf | 수정 (validation 추가) |
| modules/iam/variables.tf | 수정 (validation, sensitive 추가) |
| modules/security-groups/variables.tf | 수정 (validation 추가) |
| modules/cloudmap/variables.tf | 수정 (validation 추가) |
| modules/cloudwatch-logs/variables.tf | 수정 (validation 추가) |
| modules/alb/variables.tf | 수정 (validation 추가) |
| modules/ecs/variables.tf | 수정 (validation, sensitive 추가) |
| modules/iam/outputs.tf | 수정 (sensitive 추가) |

### Best Practices 준수 현황

| 항목 | 상태 |
|------|------|
| 디렉토리 구조 (모듈화) | ✅ 완료 |
| 모듈 파일 구조 (main, variables, outputs) | ✅ 완료 |
| versions.tf 파일 | ✅ 완료 (신규) |
| 변수 validation | ✅ 완료 (신규) |
| sensitive 플래그 | ✅ 완료 (신규) |
| 네이밍 컨벤션 (snake_case) | ✅ 완료 |
| 리소스 태깅 (default_tags) | ✅ 완료 |
| 원격 상태 관리 (S3 + DynamoDB) | ✅ 완료 |
| 데이터 소스 활용 | ✅ 완료 |

### 참조 문서

- [HashiCorp Standard Module Structure](https://developer.hashicorp.com/terraform/language/modules/develop/structure)
- [Terraform Best Practices - Code Structure](https://www.terraform-best-practices.com/code-structure)
- [AWS Prescriptive Guidance - Terraform Best Practices](https://docs.aws.amazon.com/prescriptive-guidance/latest/terraform-aws-provider-best-practices/structure.html)
