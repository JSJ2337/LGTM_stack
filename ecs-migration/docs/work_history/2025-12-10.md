# Work History - 2025-12-10

## 작업 개요

LGTM 스택(Loki, Grafana, Tempo, Mimir)을 현재 EC2 기반에서 **ECS Fargate**로 마이그레이션하기 위한 사전 조사 및 아키텍처 설계

---

## 1. 프로젝트 목표

### 현재 상태

- EC2 인스턴스에서 Docker Compose로 LGTM 스택 운영
- Alloy Agent를 systemd로 각 EC2에 설치하여 메트릭/로그 수집
- 수동 배포 방식

### 목표 상태

- **ECS Fargate**로 컨테이너 오케스트레이션
- **Jenkins + ECR**을 활용한 CI/CD 자동화
- 서버리스 환경으로 인프라 관리 부담 감소

---

## 2. 조사 내용

### 2.1 Grafana Labs 공식 문서 조사

**주요 발견:**

- [Grafana Labs 공식 Fargate 배포 가이드](https://grafana.com/blog/2021/08/11/a-guide-to-deploying-grafana-loki-and-grafana-tempo-without-kubernetes-on-aws-fargate/)
  - Loki + Tempo ECS Fargate 배포 방법 제공
  - **Mimir는 공식 가이드 없음** (커뮤니티 패턴 활용 필요)

**핵심 기술 요구사항:**

- **Service Discovery**: AWS CloudMap 사용
- **Load Balancing**: ALB Path-based routing
- **Configuration**: Gomplate 템플릿 엔진
- **Graceful Shutdown**: Tini + stopTimeout 120초
- **Network 설정**: `interface_names: ["eth1"]` (Fargate 1.4.0+)

### 2.2 Jenkins + ECR + ECS CI/CD 파이프라인 조사

**참고 자료:**

- [Mastering CI/CD with Jenkins, AWS ECR, and ECS](https://praveendandu24.medium.com/supercharge-software-delivery-mastering-ci-cd-with-jenkins-aws-ecr-and-ecs-6f19aa373190)
- [AWS 공식 블로그](https://aws.amazon.com/blogs/devops/set-up-a-build-pipeline-with-jenkins-and-amazon-ecs/)

**파이프라인 플로우:**

```bash
GitHub Commit → Jenkins Build → Docker Build → ECR Push → ECS Update Service
```

### 2.3 커뮤니티 사례 조사

**GitHub Discussion:**

- [Mimir on AWS ECS Fargate #3807](https://github.com/grafana/mimir/discussions/3807)
  - Monolith 모드 3개 인스턴스 구성
  - Memberlist로 클러스터링
  - S3 백엔드 (blocks, ruler, alertmanager)

**AWS Samples:**

- [sample-grafana-prometheus-stack](https://github.com/aws-samples/sample-grafana-prometheus-stack)
  - 전체 관측성 스택을 AWS CDK로 배포
  - Grafana, Loki, Tempo, Prometheus 포함

**Production 사례 (Seniorlink):**

- Loki: ~1,000 logs/second
- Tempo: ~250 spans/50 traces per second
- Fargate에서 성공적으로 운영 중

---

## 3. 아키텍처 설계

### 3.1 전체 시스템 아키텍처

```text
                    Application Load Balancer
                              │
         ┌────────────────────┼────────────────────┐
         │                    │                    │
         ▼                    ▼                    ▼
    Grafana              Mimir (3x)            Loki
   (Fargate)            (Fargate)            (Fargate)
         │                    │                    │
         │                    │                    │
         ▼                    ▼                    ▼
                    AWS CloudMap
                (Service Discovery)
                         │
                         ▼
                   S3 Bucket
                (sys-lgtm-s3)
```

### 3.2 컴포넌트별 구성

| 컴포넌트 | Launch Type | Task 수 | vCPU | Memory | 포트 |
|----------|-------------|---------|------|--------|------|
| **Mimir** | Fargate | 3 | 2 | 4GB | 9009, 7946 |
| **Loki** | Fargate | 2 | 1 | 2GB | 3100 |
| **Tempo** | Fargate | 1 | 1 | 2GB | 3200, 4317, 4318 |
| **Pyroscope** | Fargate | 1 | 1 | 2GB | 4040 |
| **Grafana** | Fargate | 1 | 0.5 | 1GB | 3000 |
| **Alloy Collector** | Fargate | 1 | 0.5 | 1GB | 12345 |

### 3.3 Service Discovery 설정

**AWS CloudMap Namespace:**

- `lgtm.local` (Private DNS)

**Service Endpoints:**

- `mimir.lgtm.local:9009`
- `loki.lgtm.local:3100`
- `tempo.lgtm.local:3200`
- `pyroscope.lgtm.local:4040`
- `grafana.lgtm.local:3000`

### 3.4 Storage Backend (기존 유지)

```yaml
S3 Bucket: sys-lgtm-s3 (ap-northeast-2)

├── blocks/          # Mimir 메트릭
├── rules/           # Mimir 알람 룰
├── alerts/          # Mimir Alertmanager
├── ftt-loki/        # Loki 로그
├── ftt-tempo/       # Tempo 트레이스
└── ftt-pyroscope/   # Pyroscope 프로파일
```

---

## 4. Fargate 제약사항 및 대응 방안

### 4.1 주요 제약사항

| 제약 | 영향 | 대응 방안 |
|------|------|----------|
| **eBPF 미지원** | Beyla 사용 불가 | Alloy Collector로 대체 (OTLP 수집) |
| **Agent 설치 불가** | EC2 Agent 불가 | CloudWatch → Alloy → LGTM 패턴 |
| **로컬 디스크 20GB** | 스토리지 제한 | S3 백엔드 활용 (이미 구성됨) |
| **Service Discovery** | 컨테이너 간 통신 | AWS CloudMap 사용 |

### 4.2 데이터 수집 전략 변경

**기존 (EC2 Agent):**

- ✅ EC2 시스템 메트릭/로그 (Alloy Agent)
- ✅ CloudWatch 메트릭 (Alloy Collector)

**변경 (Fargate):**

- ❌ EC2 시스템 메트릭 (Agent 불가)
- ✅ **ECS Container Insights** (Fargate 메트릭)
- ✅ **CloudWatch 메트릭** (RDS, ALB, NLB, ElastiCache)
- ✅ **CloudWatch Logs** (Lambda, RDS)
- ✅ **OTLP** (애플리케이션 트레이스/로그)

**옵션:** 기존 EC2는 유지하고 Alloy Agent 계속 사용 (하이브리드 구성)

---

## 5. Jenkins CI/CD 파이프라인 설계

### 5.1 파이프라인 구조

```bash
pipeline {
  stages {
    1. Build Docker Image
    2. Push to ECR
    3. Register Task Definition
    4. Update ECS Service (--force-new-deployment)
  }
}
```

### 5.2 ECR 리포지토리

```text
<account-id>.dkr.ecr.ap-northeast-2.amazonaws.com/

├── lgtm-mimir
├── lgtm-loki
├── lgtm-tempo
├── lgtm-pyroscope
├── lgtm-grafana
└── lgtm-alloy
```

---

## 6. 핵심 설정 예시

### 6.1 Fargate 필수 설정

**Memberlist (Mimir/Loki/Tempo):**

```yaml
memberlist:
  interface_names: ["eth1"]  # Fargate 1.4.0+ 필수
  join_members:

    - mimir.lgtm.local:7946
```

**Graceful Shutdown:**

```json
{
  "stopTimeout": 120,
  "entryPoint": ["/tini", "--"]
}
```

### 6.2 Task Definition 예시 (Mimir)

```json
{
  "family": "lgtm-mimir",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "2048",
  "memory": "4096",
  "containerDefinitions": [
    {
      "name": "mimir",
      "image": "<ECR>/lgtm-mimir:latest",
      "portMappings": [
        {"containerPort": 9009},
        {"containerPort": 7946}
      ],
      "environment": [
        {"name": "MIMIR_S3_BUCKET", "value": "sys-lgtm-s3"}
      ],
      "stopTimeout": 120
    }
  ]
}
```

---

## 7. 마이그레이션 로드맵

### Phase 1: ECR 구성 (1일)

- ECR 리포지토리 생성 (6개)
- IAM Role 설정 (Task Execution, Task Role)

### Phase 2: Dockerfile 작성 (2일)

- 기존 docker-compose → Dockerfile 변환
- Gomplate 템플릿 작성
- 로컬 테스트

### Phase 3: Task Definition 작성 (2일)

- 6개 컴포넌트별 Task Definition JSON
- Service Discovery 설정
- ALB Target Group 생성

### Phase 4: ECS 서비스 배포 (3일)

- ECS Cluster 생성
- Service 배포 및 테스트
- CloudMap 등록 확인

### Phase 5: Jenkins CI/CD 구축 (2일)

- Jenkinsfile 작성
- ECR 푸시 자동화
- ECS 배포 자동화

### Phase 6: 트래픽 전환 (1일)

- Blue/Green 배포 또는 점진적 전환
- 모니터링 및 검증

### 예상 소요 기간

약 2주

---

## 8. 비용 예측

**Fargate 비용 (서울 리전, 월 기준):**

| 서비스 | vCPU | 메모리 | 인스턴스 | 월 예상 비용 |
|--------|------|--------|----------|--------------|
| Mimir | 2 | 4GB | 3 | ~$270 |
| Loki | 1 | 2GB | 2 | ~$120 |
| Tempo | 1 | 2GB | 1 | ~$60 |
| Pyroscope | 1 | 2GB | 1 | ~$60 |
| Grafana | 0.5 | 1GB | 1 | ~$25 |
| Alloy | 0.5 | 1GB | 1 | ~$25 |
| **합계** | - | - | - | **~$560/월** |

> 참고: S3, CloudWatch, 데이터 전송 비용 별도

---

## 9. 다음 단계 (To-Do)

- [ ] Task Definition JSON 파일 작성 (6개 컴포넌트)
- [ ] Dockerfile 작성 (docker-compose 기반)
- [ ] Terraform 코드 작성 (선택사항)
- [ ] Jenkins 파이프라인 스크립트 작성
- [ ] 파일럿 배포 및 테스트

---

## 10. 참고 자료

### Grafana Labs 공식

- [Deploying Loki and Tempo on AWS Fargate](https://grafana.com/blog/2021/08/11/a-guide-to-deploying-grafana-loki-and-grafana-tempo-without-kubernetes-on-aws-fargate/)

### Jenkins CI/CD

- [Mastering CI/CD with Jenkins, ECR, and ECS](https://praveendandu24.medium.com/supercharge-software-delivery-mastering-ci-cd-with-jenkins-aws-ecr-and-ecs-6f19aa373190)
- [AWS Blog: Jenkins + ECS Pipeline](https://aws.amazon.com/blogs/devops/set-up-a-build-pipeline-with-jenkins-and-amazon-ecs/)

### 커뮤니티 사례

- [Mimir on ECS Fargate Discussion](https://github.com/grafana/mimir/discussions/3807)
- [AWS Samples: Grafana Stack](https://github.com/aws-samples/sample-grafana-prometheus-stack)
- [Terraform AWS Grafana](https://github.com/telia-oss/terraform-aws-grafana)

### 추가 참고

- [Full-Stack Observability: ECS Fargate + OpenTelemetry](https://knowledge.businesscompassllc.com/full-stack-observability-ecs-fargate-meets-opentelemetry-and-grafana/)
- [Grafana Beyla with ECS](https://grafana.com/blog/2025/07/09/observability-for-containerized-workloads-how-to-run-grafana-beyla-as-a-sidecar-in-amazon-ecs/)

---

## 11. 메모

### 중요 사항

- Fargate는 eBPF 미지원 → Beyla 사용 불가
- EC2 시스템 메트릭 수집 방법 재고 필요 (Container Insights or 하이브리드)
- Mimir 공식 Fargate 가이드 없음 → 커뮤니티 패턴 활용

### 결정 사항

- **ECS Fargate**로 진행 (서버리스 우선)
- **Monolith 모드** 사용 (Read/Write 분리 없이)
- **S3 백엔드** 유지 (기존 sys-lgtm-s3)
- **Jenkins + ECR** CI/CD 구축

---

**작성일:** 2025-12-10
**작성자:** Claude Sonnet 4.5
**프로젝트:** LGTM_PRD ECS Fargate Migration
