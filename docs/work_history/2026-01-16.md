# 작업 이력 - 2026-01-16

## 01:00 - ECS LGTM 스택 테스트

### 테스트 환경

- ALB DNS: `lgtm-prod-alb-1519102595.ap-northeast-2.elb.amazonaws.com`
- ECS Cluster: `lgtm-prod-cluster`
- Tenant ID: `jsj-lgtm-header`

### 테스트 결과 요약

| 서비스 | 상태 | 테스트 내용 |
|--------|------|-------------|
| Grafana | ✅ 정상 | Health API 응답, 로그인 페이지 접근 가능 |
| Mimir | ✅ 정상 | 메트릭 조회/쓰기 정상, AWS CloudWatch 메트릭 수집됨 |
| Loki | ✅ 정상 | 로그 Push/Query 정상 동작 |
| Tempo | ⚠️ 부분 동작 | 서비스 실행 중, ALB 라우팅 경로 조정 필요 |
| Pyroscope | ⚠️ 부분 동작 | 서비스 실행 중, ALB 라우팅 경로 조정 필요 |

### 상세 테스트 결과

#### 1. Grafana

```bash
# Health 체크 - 정상
curl http://<ALB_DNS>/api/health
# {"database": "ok", "version": "12.1.0", ...}
```

- 버전: 12.1.0
- 데이터베이스 연결: OK
- 로그인 페이지: 접근 가능

#### 2. Mimir (메트릭)

```bash
# 메트릭 목록 조회 - 정상
curl "http://<ALB_DNS>/prometheus/api/v1/label/__name__/values" \
  -H "X-Scope-OrgID: jsj-lgtm-header"
```

저장된 메트릭:

- `aws_applicationelb_*` (ALB 메트릭)
- `aws_ecs_*` (ECS 메트릭)
- `aws_elb_*` (ELB 메트릭)
- `scrape_*`, `up` (스크래핑 메트릭)

#### 3. Loki (로그)

```bash
# 로그 전송 - HTTP 204 (성공)
curl -X POST "http://<ALB_DNS>/loki/api/v1/push" \
  -H "Content-Type: application/json" \
  -H "X-Scope-OrgID: jsj-lgtm-header" \
  -d '{"streams":[{"stream":{"job":"test"},"values":[["<timestamp>","test log"]]}]}'

# 로그 조회 - 정상
curl "http://<ALB_DNS>/loki/api/v1/query_range?query={job=\"test\"}" \
  -H "X-Scope-OrgID: jsj-lgtm-header"
```

- 저장된 라벨: `env`, `instance`, `job`, `service_name`
- Push/Query 모두 정상 동작

#### 4. Tempo (트레이스)

- 서비스 실행 중 (ECS 태스크 정상)
- ALB 라우팅 `/tempo/*` 설정됨
- 직접 API 호출 시 404 반환 (경로 prefix 문제)

#### 5. Pyroscope (프로파일링)

- 서비스 실행 중 (ECS 태스크 정상)
- `/ingest` 엔드포인트: HTTP 400 (요청 본문 누락)
- ALB 라우팅 설정 확인 필요

### 발견된 이슈

#### 1. Tempo/Pyroscope ALB 라우팅

현재 ALB 라우팅이 경로 prefix를 그대로 전달하여 일부 API 호출이 실패함.

- 현재: ALB → `/tempo/api/search` → Tempo
- 기대: Tempo는 `/api/search` 경로를 기대함

**해결 방안:**

1. Tempo/Pyroscope 설정에서 `http_prefix` 설정 추가
2. 또는 ALB에서 path rewrite 설정 (AWS ALB는 미지원)

#### 2. Grafana 인증

- 기본 설정으로 anonymous access 비활성화됨
- 브라우저에서 로그인 필요 (admin/admin)

### 테스트 명령어 모음

```bash
# ALB DNS 설정
ALB_DNS="lgtm-prod-alb-1519102595.ap-northeast-2.elb.amazonaws.com"

# Grafana 헬스체크
curl "http://${ALB_DNS}/api/health"

# Mimir 메트릭 조회
curl "http://${ALB_DNS}/prometheus/api/v1/labels" \
  -H "X-Scope-OrgID: jsj-lgtm-header"

# Loki 로그 전송
curl -X POST "http://${ALB_DNS}/loki/api/v1/push" \
  -H "Content-Type: application/json" \
  -H "X-Scope-OrgID: jsj-lgtm-header" \
  -d '{"streams":[{"stream":{"job":"test","env":"prod"},"values":[["'$(date +%s)000000000'","Test log"]]}]}'

# Loki 라벨 조회
curl "http://${ALB_DNS}/loki/api/v1/labels" \
  -H "X-Scope-OrgID: jsj-lgtm-header"
```

### 다음 단계

1. 브라우저에서 Grafana 접속 후 데이터소스 연결 확인
2. ~~Tempo/Pyroscope ALB 라우팅 수정 (선택적)~~ → 완료
3. 실제 애플리케이션에서 데이터 수집 테스트

---

## 01:30 - Tempo/Pyroscope http_path_prefix 설정 추가

### 문제 상황

ALB 라우팅 규칙이 `/tempo/*`, `/pyroscope/*` 경로를 해당 서비스로 전달하지만,
Tempo와 Pyroscope는 기본적으로 prefix 없이 `/api/...`, `/ready` 등의 경로를 기대함.

```text
# 문제
ALB → /tempo/api/search → Tempo (expects /api/search) → 404

# 해결
ALB → /tempo/api/search → Tempo (http_path_prefix: /tempo) → 200
```

### 수정 내용

#### 1. Tempo 설정 수정

- 파일: `ecs-migration/dockerfiles/tempo/config/tempo-config.yaml`
- 변경: `server.http_path_prefix: /tempo` 추가

```yaml
server:
  http_listen_port: 3200
  http_path_prefix: /tempo
```

#### 2. Pyroscope 설정 수정

- 파일: `ecs-migration/dockerfiles/pyroscope/config/pyroscope-config.yaml`
- 변경: `server.http_path_prefix: /pyroscope` 추가

```yaml
server:
  http_listen_port: 4040
  grpc_listen_port: 4041
  log_level: info
  http_path_prefix: /pyroscope
```

#### 3. ALB 헬스체크 경로 수정

- 파일: `ecs-migration/terraform/modules/alb/main.tf`
- Tempo: `/ready` → `/tempo/ready`
- Pyroscope: `/ready` → `/pyroscope/ready`

### 배포 필요 사항

1. Docker 이미지 리빌드 필요 (Tempo, Pyroscope)
2. Terraform Apply 필요 (ALB 헬스체크 경로 변경)

### 영향도

- Tempo: 이제 `/tempo/api/search`, `/tempo/ready` 등 prefix 경로 사용
- Pyroscope: 이제 `/pyroscope/ready`, `/pyroscope/api/v1/...` 등 prefix 경로 사용
- ALB 헬스체크가 새 경로를 사용하므로 이미지 먼저 배포 필요

---

## 02:00 - Pyroscope S3 Storage Prefix 및 Multitenancy 설정 추가

### 문제 상황

S3 버킷 구조 확인 결과:

```text
jsj-lgtm-data-s3/
├── anonymous/                    ← 문제! Pyroscope 기본 테넌트
├── blocks/
├── loki/
├── pyroscope_cluster_seed.json
└── tempo/
```

**문제점:**

1. `pyroscope/` 폴더가 없음 - storage prefix 미설정
2. `anonymous/` 폴더 생성 - multitenancy 미설정으로 기본 테넌트 사용

### 원인 분석

| 서비스 | Storage Prefix | Multitenancy | 상태 |
|--------|----------------|--------------|------|
| Loki | ✅ `loki` | ✅ `auth_enabled: true` | 정상 |
| Tempo | ✅ `tempo` | ✅ `multitenancy_enabled: true` | 정상 |
| Mimir | ✅ (별도 설정) | ✅ (별도 설정) | 정상 |
| Pyroscope | ❌ 없음 | ❌ 없음 | **문제** |

### 수정 내용

#### 1. Pyroscope 설정 파일 수정

파일: `ecs-migration/dockerfiles/pyroscope/config/pyroscope-config.yaml`

```yaml
target: all

multitenancy_enabled: true  # 추가: X-Scope-OrgID 헤더 필수

server:
  http_listen_port: 4040
  grpc_listen_port: 4041
  log_level: info
  http_path_prefix: /pyroscope

storage:
  backend: s3
  prefix: ${PYROSCOPE_STORAGE_PREFIX}/  # 추가: S3 prefix 설정
  s3:
    bucket_name: ${PYROSCOPE_S3_BUCKET}
    # ...
```

#### 2. ECS Task Definition 환경변수 추가

파일: `ecs-migration/terraform/modules/ecs/main.tf`

```hcl
environment = [
  { name = "AWS_REGION", value = var.aws_region },
  { name = "PYROSCOPE_S3_BUCKET", value = var.s3_bucket_name },
  { name = "PYROSCOPE_STORAGE_PREFIX", value = "pyroscope" },  # 추가
  { name = "TZ", value = "Asia/Seoul" }
]
```

### 수정 후 예상 S3 구조

```text
jsj-lgtm-data-s3/
├── loki/
│   └── jsj-lgtm-header/        ← Loki 테넌트별 데이터
├── tempo/
│   └── jsj-lgtm-header/        ← Tempo 테넌트별 데이터
├── pyroscope/                   ← 새로 생성됨
│   └── jsj-lgtm-header/        ← Pyroscope 테넌트별 데이터
└── blocks/                      ← Mimir 블록 데이터
```

### 배포 필요 사항

1. Docker 이미지 리빌드 (Pyroscope)
2. Terraform Apply (ECS Task Definition 환경변수)

### 영향도

- Pyroscope: 이제 `X-Scope-OrgID` 헤더 필수
- S3: 데이터가 `pyroscope/` prefix 아래에 저장됨
- 기존 `anonymous/` 폴더의 데이터는 마이그레이션 필요 (또는 삭제)

### 참고 문서

- [Pyroscope S3 Storage Configuration](https://grafana.com/docs/pyroscope/latest/configure-server/storage/configure-object-storage-backend/)

---

## 02:30 - Storage Prefix 하드코딩 제거

### 문제 상황

ECS Task Definition에서 storage prefix 값들이 하드코딩되어 있었음:

```hcl
# 하드코딩된 값들
{ name = "LOKI_STORAGE_PREFIX", value = "loki" },
{ name = "TEMPO_STORAGE_PREFIX", value = "tempo" },
{ name = "PYROSCOPE_STORAGE_PREFIX", value = "pyroscope" },
```

### 수정 내용

#### 1. common.tfvars에 storage_prefixes 변수 추가

```hcl
storage_prefixes = {
  loki      = "loki"
  tempo     = "tempo"
  pyroscope = "pyroscope"
}
```

#### 2. ECS 모듈 variables.tf에 변수 정의 추가

```hcl
variable "storage_prefixes" {
  description = "S3 storage prefixes for each service"
  type = object({
    loki      = string
    tempo     = string
    pyroscope = string
  })
}
```

#### 3. ECS 모듈 main.tf에서 변수 참조로 변경

```hcl
# Loki
{ name = "LOKI_STORAGE_PREFIX", value = var.storage_prefixes.loki }

# Tempo
{ name = "TEMPO_STORAGE_PREFIX", value = var.storage_prefixes.tempo }

# Pyroscope
{ name = "PYROSCOPE_STORAGE_PREFIX", value = var.storage_prefixes.pyroscope }
```

#### 4. 60-ecs root module 변수 전달 추가

- `variables.tf`: storage_prefixes 변수 정의
- `main.tf`: 모듈 호출 시 `storage_prefixes = var.storage_prefixes` 전달

### 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `common.tfvars` | storage_prefixes 변수 추가 |
| `modules/ecs/variables.tf` | storage_prefixes 변수 정의 |
| `modules/ecs/main.tf` | 하드코딩 → 변수 참조로 변경 |
| `environments/prod/60-ecs/variables.tf` | storage_prefixes 변수 정의 |
| `environments/prod/60-ecs/main.tf` | 모듈에 변수 전달 |

### 영향도

- 기능 변경 없음 (값은 동일)
- 코드 품질 개선 (DRY 원칙 준수)
- 향후 prefix 변경 시 common.tfvars만 수정하면 됨

---

## 02:45 - Mimir runtime_config S3 경로 지정

### 문제 상황

S3 버킷 루트(`/`)에 `tenant_settings.json` 파일이 생성됨.
Mimir의 runtime_config 기능이 기본 경로를 사용하여 루트에 파일 생성.

### 수정 내용

파일: `ecs-migration/dockerfiles/mimir/config/mimir-config.yaml`

```yaml
runtime_config:
  period: 10s
  file: s3://${MIMIR_S3_BUCKET}/mimir/runtime-config.yaml
```

### 영향도

- ~~Mimir 런타임 설정 파일이 `mimir/` 폴더에 저장됨~~
- ~~S3 버킷 루트 정리됨~~
- ~~Docker 이미지 리빌드 필요~~

**업데이트 (03:00)**: runtime_config 설정 롤백 - S3 URI 미지원으로 인한 서비스 장애 발생

---

## 03:00 - Mimir/Pyroscope 서비스 장애 분석 및 조치

### 문제 상황

ECS 서비스 상태 확인 결과:

| 서비스 | 상태 | 문제 |
|--------|------|------|
| Mimir | ❌ FAILED | runtime_config S3 URI 미지원 |
| Pyroscope | ❌ 롤백 중 | 헬스체크 404 (새 이미지 미배포) |
| Grafana | ✅ | 정상 |
| Loki | ✅ | 정상 |
| Tempo | ⚠️ | 일시적 경고 (정상) |
| Alloy | ✅ | 정상 |

### 원인 분석

#### 1. Mimir runtime_config 오류

```text
failed to load runtime config: read file "s3://jsj-lgtm-data-s3/mimir/runtime-config.yaml":
open s3://jsj-lgtm-data-s3/mimir/runtime-config.yaml: no such file or directory
```

**원인**: Mimir의 `runtime_config.file`은 **로컬 파일 경로**만 지원. `s3://` URI 미지원.

#### 2. Pyroscope 헬스체크 404

```text
GET /pyroscope/ready (404) - "404 page not found"
```

**원인**: ALB 헬스체크는 `/pyroscope/ready` 경로 사용, but 현재 실행 중인 이미지에는 `http_path_prefix` 설정이 없음 (새 이미지 미배포)

### 조치 내용

#### 1. Mimir runtime_config 제거

파일: `ecs-migration/dockerfiles/mimir/config/mimir-config.yaml`

```yaml
# 제거됨 (S3 URI 미지원)
# runtime_config:
#   period: 10s
#   file: s3://${MIMIR_S3_BUCKET}/mimir/runtime-config.yaml

# 대체: 주석으로 안내
# runtime_config는 선택적 기능이며 S3 URI를 직접 지원하지 않음
# 테넌트별 런타임 오버라이드가 필요한 경우 로컬 파일 또는 환경변수로 설정
```

#### 2. S3 파일 생성 (임시)

```bash
echo 'overrides: {}' | aws s3 cp - s3://jsj-lgtm-data-s3/mimir/runtime-config.yaml
```

(이 파일은 새 이미지 배포 후 삭제 가능)

### 후속 작업

1. **Mimir**: Docker 이미지 리빌드 (runtime_config 제거)
2. **Pyroscope**: Docker 이미지 리빌드 (http_path_prefix 포함)
3. **Tempo**: Docker 이미지 리빌드 (http_path_prefix 포함)
4. **Terraform Apply**: ECS Task Definition 업데이트 (storage_prefixes 변수)

### 학습 포인트

- Mimir의 `runtime_config.file`은 로컬 파일 경로만 지원
- S3 기반 런타임 설정이 필요하면 별도 사이드카나 초기화 컨테이너로 S3에서 파일 다운로드 필요
- ECS 배포 시 이미지 태그 변경 없이 설정만 변경하면 새 Task Definition이 생성되어도 기존 이미지 사용

---

## 03:15 - Tempo/Pyroscope ALB Health Check 경로 수정 (롤백)

### 문제 상황

GitHub Actions 배포 실패:

```text
Deploy tempo - FAILED
Deploy pyroscope - FAILED
Error: Waiter ServicesStable failed: Max attempts exceeded
```

**원인**: Tempo/Pyroscope의 `http_path_prefix` 설정이 내부 health check endpoint (`/ready`)에는 적용되지 않음

```text
# 문제
ALB → GET /tempo/ready → Tempo (returns 404)
ALB → GET /pyroscope/ready → Tempo (returns 404)

# 실제 동작
Tempo /ready → 200 OK (prefix 없음)
Tempo /tempo/api/search → 200 OK (prefix 있음)
```

### ALB Health Check 경로 변경

파일: `ecs-migration/terraform/modules/alb/main.tf`

```hcl
# Tempo health check (line 123)
# 변경 전: path = "/tempo/ready"
# 변경 후: path = "/ready"

# Pyroscope health check (line 148)
# 변경 전: path = "/pyroscope/ready"
# 변경 후: path = "/ready"
```

### 커밋 및 배포

```text
commit: fix: Tempo/Pyroscope ALB health check 경로 수정
- Tempo: /tempo/ready → /ready
- Pyroscope: /pyroscope/ready → /ready
- http_path_prefix가 내부 health check endpoint에 적용되지 않음
```

배포 상태:

- GitHub Actions Terraform Infrastructure 워크플로우 트리거됨
- "Approval Gate"에서 수동 승인 대기 중
- 승인 URL: [GitHub Actions Run](https://github.com/JSJ2337/LGTM_stack/actions/runs/21037989261)

### 변경 영향 및 참고사항

영향도:

- ALB Target Group health check가 `/ready` 경로 사용
- Tempo/Pyroscope 내부 health check endpoint 직접 호출
- http_path_prefix는 API 라우팅에만 적용됨

참고:

- `http_path_prefix` 설정은 API 엔드포인트에만 적용됨
- `/ready`, `/metrics` 등 내부 시스템 엔드포인트는 prefix 없이 접근 필요
- ALB health check와 애플리케이션 API 라우팅 경로 구분 필요

---

## 03:30 - Pyroscope storage prefix 설정 오류 수정

### 문제 상황

Pyroscope 컨테이너 시작 실패:

```text
failed parsing config: /etc/pyroscope/config.yaml: yaml: unmarshal errors:
  line 13: field prefix not found in type phlare.StorageConfig
```

### 설정 오류 원인

Pyroscope의 `StorageConfig` 타입에서 `prefix` 필드를 직접 지원하지 않음.
Loki/Tempo와 달리 `storage.s3.prefix`로 설정해야 함.

```yaml
# 잘못된 설정 (오류 발생)
storage:
  backend: s3
  prefix: pyroscope/  # StorageConfig에 prefix 필드 없음
  s3:
    bucket_name: ...

# 올바른 설정
storage:
  backend: s3
  s3:
    bucket_name: ...
    prefix: pyroscope/  # S3 설정 내부에 prefix 지정
```

### 수정 파일

파일: `ecs-migration/dockerfiles/pyroscope/config/pyroscope-config.yaml`

```yaml
storage:
  backend: s3
  s3:
    bucket_name: ${PYROSCOPE_S3_BUCKET}
    endpoint: s3.${AWS_REGION}.amazonaws.com
    region: ${AWS_REGION}
    insecure: false
    prefix: ${PYROSCOPE_STORAGE_PREFIX}/  # s3 블록 내부로 이동
```

### 커밋 정보

```text
commit: fix: Pyroscope storage prefix 설정 위치 수정
- storage.prefix → storage.s3.prefix로 이동
- Pyroscope StorageConfig에서 prefix 필드 미지원 오류 해결
```

### 배포 상태

- GitHub Actions 워크플로우 트리거됨
- 이미지 리빌드 후 ECS 배포 진행 예정

### 현재 서비스 상태

| 서비스 | Target Health | 비고 |
|--------|---------------|------|
| Grafana | ✅ healthy | 정상 |
| Mimir | ✅ healthy | 정상 |
| Loki | ✅ healthy | 정상 |
| Tempo | ✅ healthy | ALB health check `/ready`로 수정 후 정상 |
| Pyroscope | ✅ healthy | 이전 이미지로 실행 중, 새 이미지 배포 필요 |
| Alloy | ✅ healthy | 정상 |

---

## 04:00 - Pyroscope storage.storage_prefix 설정 수정

### 문제 상황

Pyroscope 컨테이너 시작 실패 (계속):

```text
failed parsing config: /etc/pyroscope/config.yaml: yaml: unmarshal errors:
  line 17: field prefix not found in type s3.Config
```

### 원인 분석

GitHub Issue #3670 참조하여 올바른 설정 확인:

- `storage.prefix` - 미지원
- `storage.s3.prefix` - 미지원
- `storage.storage_prefix` - **올바른 설정**

### 수정 파일

파일: `ecs-migration/dockerfiles/pyroscope/config/pyroscope-config.yaml`

```yaml
storage:
  backend: s3
  storage_prefix: ${PYROSCOPE_STORAGE_PREFIX}  # 올바른 위치
  s3:
    bucket_name: ${PYROSCOPE_S3_BUCKET}
    endpoint: s3.${AWS_REGION}.amazonaws.com
    region: ${AWS_REGION}
    insecure: false
```

---

## 04:15 - ECS health_check_grace_period_seconds 추가

### 재시작 문제 현상

Tempo, Pyroscope 서비스가 계속 재시작됨:

- 컨테이너 로그에 정상 시작 메시지 확인
- 그러나 약 5분마다 SIGTERM 수신
- ECS deployment circuit breaker가 롤백 수행

### 재시작 원인

ECS 서비스의 `health_check_grace_period_seconds = 0` 설정으로 인해:

1. 새 Task 시작
2. ALB Target Group에 등록
3. 즉시 health check 시작 (grace period 없음)
4. 컨테이너 초기화 중이라 unhealthy 응답
5. ECS가 Task 종료
6. 반복...

### Grace Period 수정 내용

파일: `ecs-migration/terraform/modules/ecs/main.tf`

ALB와 연결된 5개 서비스에 grace period 추가:

```hcl
# Mimir, Loki, Tempo, Pyroscope, Grafana
health_check_grace_period_seconds = 120
```

### Grace Period 영향도

- ALB 헬스체크 시작 전 120초 대기
- 컨테이너 초기화 시간 확보
- 서비스 안정성 향상

---

## 04:30 - ECR 이미지 태그와 Dockerfile base 버전 분리

### 이미지 업데이트 문제

이미지 업데이트가 반영되지 않아 강제 배포 시도:

1. `aws ecs update-service --force-new-deployment` - 실패
2. `common.tfvars` image_versions 변경 시도 - **문제 발생**

### 이미지 태깅 원인 분석

`common.tfvars`의 `image_versions`가 두 가지 용도로 사용됨:

1. **Dockerfile ARG VERSION** - base 이미지 pull용 (`grafana/tempo:${VERSION}`)
2. **ECR 이미지 태그** - 빌드된 이미지 태깅용

예: `tempo = "2.9.0-20260116"` 변경 시:

- Dockerfile: `FROM grafana/tempo:2.9.0-20260116` → **Docker Hub에 없음!**
- 빌드 실패

### 이미지 태깅 해결 방안

`deploy-ecs.yaml` 워크플로우 수정하여 base_version과 ECR tag 분리:

```yaml
# 변경 전
VERSION=$(grep ...)
echo "tag=${VERSION}" >> "$GITHUB_OUTPUT"
build-args: VERSION=${{ steps.version.outputs.tag }}

# 변경 후
BASE_VERSION=$(grep ...)
TIMESTAMP=$(date '+%Y%m%d-%H%M%S')
ECR_TAG="${BASE_VERSION}-${TIMESTAMP}"

echo "base_version=${BASE_VERSION}" >> "$GITHUB_OUTPUT"
echo "tag=${ECR_TAG}" >> "$GITHUB_OUTPUT"

build-args: VERSION=${{ steps.version.outputs.base_version }}
```

### 이미지 태깅 수정 파일

| 파일 | 변경 내용 |
|------|----------|
| `common.tfvars` | image_versions 원복 (2.9.0, 1.13.5) |
| `deploy-ecs.yaml` | base_version/tag 출력 분리, build-args에서 base_version 사용 |

### 이미지 태깅 커밋 정보

```text
commit: fix: ECR 이미지 태그와 Dockerfile base 버전 분리
- common.tfvars image_versions 원복 (tempo: 2.9.0, pyroscope: 1.13.5)
- deploy-ecs.yaml: base_version과 ECR tag 분리
  - base_version: Dockerfile ARG VERSION (base image pull용)
  - tag: ECR 이미지 태그 (버전-YYYYMMDD-HHMMSS 형식)
- 매 빌드마다 새로운 ECR 태그 생성으로 이미지 업데이트 보장
```

### 새 태그 형식

- 기존: `2.9.0` (고정)
- 변경: `2.9.0-20260116-043000` (버전-날짜-시간)

이제 매 빌드마다 새로운 태그가 생성되어 이미지 업데이트가 보장됨.

---

## 05:30 - S3 버전 관리 비활성화

### 변경 배경

Terraform destroy 중 S3 버킷 삭제 실패:

```text
BucketNotEmpty: The bucket you tried to delete is not empty.
You must delete all versions in the bucket.
```

버전 관리가 활성화된 버킷은 모든 객체 버전과 삭제 마커를 수동으로 제거해야 삭제 가능.

### 버전 관리 필요성 검토

**버전 관리가 유용한 경우:**

- Terraform state 파일 (실수로 삭제/덮어쓰기 복구)
- 규정 준수가 필요한 데이터 (감사 로그 등)
- 중요 문서/자산 보관

**LGTM 데이터 버킷에 불필요한 이유:**

- Loki/Tempo/Pyroscope 데이터는 애플리케이션이 자동 관리
- 보존 정책에 따라 자동 삭제됨
- 버전 관리 시 스토리지 비용 2배 이상 증가
- 버킷 삭제/정리 작업 복잡성 증가

### S3 모듈 수정

파일: `ecs-migration/terraform/modules/s3/main.tf`

```hcl
# 변경 전
resource "aws_s3_bucket_versioning" "lgtm_data" {
  bucket = aws_s3_bucket.lgtm_data.id

  versioning_configuration {
    status = "Enabled"
  }
}

# 변경 후
resource "aws_s3_bucket_versioning" "lgtm_data" {
  bucket = aws_s3_bucket.lgtm_data.id

  versioning_configuration {
    status = "Disabled"
  }
}
```

### 변경 영향

- 새로 생성되는 S3 버킷은 버전 관리 비활성화
- 객체 삭제 시 즉시 삭제됨 (버전 보관 안 함)
- 버킷 삭제가 간편해짐
- 스토리지 비용 절감

---

## 05:00 - Tempo/Pyroscope http_path_prefix 제거

### 배포 실패 현상

빌드는 성공했으나 Deploy 단계에서 타임아웃:

- Deploy tempo: Wait for deployment 실패
- Deploy pyroscope: Wait for deployment 실패

### CloudWatch 로그 분석

**Tempo:**

- 정상 시작 (`"Tempo started"`) 확인
- ALB 헬스체크 `ResponseCodeMismatch` 발생

**Pyroscope:**

```text
POST /schedulerpb.SchedulerForFrontend/FrontendLoop (404)
error sending requests to scheduler: 404 (Not Found)
```

- 내부 gRPC 통신 (scheduler/querier) 404 오류

### 근본 원인

`http_path_prefix` 설정이 모든 HTTP 엔드포인트에 적용됨:

1. **헬스체크 영향**: `/ready` 요청 시 prefix가 적용되어 404 또는 잘못된 응답
2. **내부 gRPC 통신 영향**: `target: all` 모드에서 컴포넌트 간 통신에도 prefix 적용

### http_path_prefix 제거 수정

Tempo/Pyroscope 설정에서 `http_path_prefix` 제거:

**Tempo** (`tempo-config.yaml`):

```yaml
server:
  http_listen_port: 3200
  # http_path_prefix 제거: 내부 통신 및 헬스체크에 영향을 줌
```

**Pyroscope** (`pyroscope-config.yaml`):

```yaml
server:
  http_listen_port: 4040
  grpc_listen_port: 4041
  log_level: info
  # http_path_prefix 제거: 내부 gRPC 통신에 영향을 줌
```

### ALB 라우팅 동작 방식

`http_path_prefix` 없이도 ALB 라우팅이 정상 동작하는 이유:

```text
클라이언트 → ALB /tempo/api/search → Tempo 3200:/ → /api/search (404)
```

실제로 ALB는 path를 그대로 전달하므로, Tempo는 `/tempo/api/search` 요청을 받음.
하지만 Tempo 내부적으로는 `/api/search`를 기대함.

**해결 방안 (향후):**

1. ALB에서 path rewrite (AWS ALB는 미지원)
2. 또는 Grafana에서 데이터소스 URL에 `/tempo` prefix 포함

현재는 헬스체크와 내부 통신 안정화가 우선.

### http_path_prefix 커밋

```text
commit: fix: Tempo/Pyroscope http_path_prefix 제거
- http_path_prefix 설정이 내부 gRPC 통신 및 헬스체크에 영향을 줌
- Pyroscope: scheduler/querier 간 통신 404 오류 발생
- Tempo: ALB 헬스체크 ResponseCodeMismatch 발생
```

---
