# 작업 이력 - 2026-01-16

## 01:00 - ECS LGTM 스택 테스트

### 테스트 환경

- ALB DNS: `lgtm-prod-alb-1519102595.ap-northeast-2.elb.amazonaws.com`
- ECS Cluster: `lgtm-prod-cluster`
- Tenant ID: `jsj-lgtm-header`

### 테스트 결과 요약

| 서비스 | 상태 | 테스트 내용 |
|--------|------|-------------|
| Grafana | ✅ 정상 | Health API 응답, 로그인 페이지 접근 가능 |
| Mimir | ✅ 정상 | 메트릭 조회/쓰기 정상, AWS CloudWatch 메트릭 수집됨 |
| Loki | ✅ 정상 | 로그 Push/Query 정상 동작 |
| Tempo | ⚠️ 부분 동작 | 서비스 실행 중, ALB 라우팅 경로 조정 필요 |
| Pyroscope | ⚠️ 부분 동작 | 서비스 실행 중, ALB 라우팅 경로 조정 필요 |

### 상세 테스트 결과

#### 1. Grafana

```bash
# Health 체크 - 정상
curl http://<ALB_DNS>/api/health
# {"database": "ok", "version": "12.1.0", ...}
```

- 버전: 12.1.0
- 데이터베이스 연결: OK
- 로그인 페이지: 접근 가능

#### 2. Mimir (메트릭)

```bash
# 메트릭 목록 조회 - 정상
curl "http://<ALB_DNS>/prometheus/api/v1/label/__name__/values" \
  -H "X-Scope-OrgID: jsj-lgtm-header"
```

저장된 메트릭:

- `aws_applicationelb_*` (ALB 메트릭)
- `aws_ecs_*` (ECS 메트릭)
- `aws_elb_*` (ELB 메트릭)
- `scrape_*`, `up` (스크래핑 메트릭)

#### 3. Loki (로그)

```bash
# 로그 전송 - HTTP 204 (성공)
curl -X POST "http://<ALB_DNS>/loki/api/v1/push" \
  -H "Content-Type: application/json" \
  -H "X-Scope-OrgID: jsj-lgtm-header" \
  -d '{"streams":[{"stream":{"job":"test"},"values":[["<timestamp>","test log"]]}]}'

# 로그 조회 - 정상
curl "http://<ALB_DNS>/loki/api/v1/query_range?query={job=\"test\"}" \
  -H "X-Scope-OrgID: jsj-lgtm-header"
```

- 저장된 라벨: `env`, `instance`, `job`, `service_name`
- Push/Query 모두 정상 동작

#### 4. Tempo (트레이스)

- 서비스 실행 중 (ECS 태스크 정상)
- ALB 라우팅 `/tempo/*` 설정됨
- 직접 API 호출 시 404 반환 (경로 prefix 문제)

#### 5. Pyroscope (프로파일링)

- 서비스 실행 중 (ECS 태스크 정상)
- `/ingest` 엔드포인트: HTTP 400 (요청 본문 누락)
- ALB 라우팅 설정 확인 필요

### 발견된 이슈

#### 1. Tempo/Pyroscope ALB 라우팅

현재 ALB 라우팅이 경로 prefix를 그대로 전달하여 일부 API 호출이 실패함.

- 현재: ALB → `/tempo/api/search` → Tempo
- 기대: Tempo는 `/api/search` 경로를 기대함

**해결 방안:**

1. Tempo/Pyroscope 설정에서 `http_prefix` 설정 추가
2. 또는 ALB에서 path rewrite 설정 (AWS ALB는 미지원)

#### 2. Grafana 인증

- 기본 설정으로 anonymous access 비활성화됨
- 브라우저에서 로그인 필요 (admin/admin)

### 테스트 명령어 모음

```bash
# ALB DNS 설정
ALB_DNS="lgtm-prod-alb-1519102595.ap-northeast-2.elb.amazonaws.com"

# Grafana 헬스체크
curl "http://${ALB_DNS}/api/health"

# Mimir 메트릭 조회
curl "http://${ALB_DNS}/prometheus/api/v1/labels" \
  -H "X-Scope-OrgID: jsj-lgtm-header"

# Loki 로그 전송
curl -X POST "http://${ALB_DNS}/loki/api/v1/push" \
  -H "Content-Type: application/json" \
  -H "X-Scope-OrgID: jsj-lgtm-header" \
  -d '{"streams":[{"stream":{"job":"test","env":"prod"},"values":[["'$(date +%s)000000000'","Test log"]]}]}'

# Loki 라벨 조회
curl "http://${ALB_DNS}/loki/api/v1/labels" \
  -H "X-Scope-OrgID: jsj-lgtm-header"
```

### 다음 단계

1. 브라우저에서 Grafana 접속 후 데이터소스 연결 확인
2. ~~Tempo/Pyroscope ALB 라우팅 수정 (선택적)~~ → 완료
3. 실제 애플리케이션에서 데이터 수집 테스트

---

## 01:30 - Tempo/Pyroscope http_path_prefix 설정 추가

### 문제 상황

ALB 라우팅 규칙이 `/tempo/*`, `/pyroscope/*` 경로를 해당 서비스로 전달하지만,
Tempo와 Pyroscope는 기본적으로 prefix 없이 `/api/...`, `/ready` 등의 경로를 기대함.

```text
# 문제
ALB → /tempo/api/search → Tempo (expects /api/search) → 404

# 해결
ALB → /tempo/api/search → Tempo (http_path_prefix: /tempo) → 200
```

### 수정 내용

#### 1. Tempo 설정 수정

- 파일: `ecs-migration/dockerfiles/tempo/config/tempo-config.yaml`
- 변경: `server.http_path_prefix: /tempo` 추가

```yaml
server:
  http_listen_port: 3200
  http_path_prefix: /tempo
```

#### 2. Pyroscope 설정 수정

- 파일: `ecs-migration/dockerfiles/pyroscope/config/pyroscope-config.yaml`
- 변경: `server.http_path_prefix: /pyroscope` 추가

```yaml
server:
  http_listen_port: 4040
  grpc_listen_port: 4041
  log_level: info
  http_path_prefix: /pyroscope
```

#### 3. ALB 헬스체크 경로 수정

- 파일: `ecs-migration/terraform/modules/alb/main.tf`
- Tempo: `/ready` → `/tempo/ready`
- Pyroscope: `/ready` → `/pyroscope/ready`

### 배포 필요 사항

1. Docker 이미지 리빌드 필요 (Tempo, Pyroscope)
2. Terraform Apply 필요 (ALB 헬스체크 경로 변경)

### 영향도

- Tempo: 이제 `/tempo/api/search`, `/tempo/ready` 등 prefix 경로 사용
- Pyroscope: 이제 `/pyroscope/ready`, `/pyroscope/api/v1/...` 등 prefix 경로 사용
- ALB 헬스체크가 새 경로를 사용하므로 이미지 먼저 배포 필요

---
