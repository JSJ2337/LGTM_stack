# 작업 이력 - 2026-01-16

## 01:00 - ECS LGTM 스택 테스트

### 테스트 환경

- ALB DNS: `lgtm-prod-alb-1519102595.ap-northeast-2.elb.amazonaws.com`
- ECS Cluster: `lgtm-prod-cluster`
- Tenant ID: `jsj-lgtm-header`

### 테스트 결과 요약

| 서비스 | 상태 | 테스트 내용 |
|--------|------|-------------|
| Grafana | ✅ 정상 | Health API 응답, 로그인 페이지 접근 가능 |
| Mimir | ✅ 정상 | 메트릭 조회/쓰기 정상, AWS CloudWatch 메트릭 수집됨 |
| Loki | ✅ 정상 | 로그 Push/Query 정상 동작 |
| Tempo | ⚠️ 부분 동작 | 서비스 실행 중, ALB 라우팅 경로 조정 필요 |
| Pyroscope | ⚠️ 부분 동작 | 서비스 실행 중, ALB 라우팅 경로 조정 필요 |

### 상세 테스트 결과

#### 1. Grafana

```bash
# Health 체크 - 정상
curl http://<ALB_DNS>/api/health
# {"database": "ok", "version": "12.1.0", ...}
```

- 버전: 12.1.0
- 데이터베이스 연결: OK
- 로그인 페이지: 접근 가능

#### 2. Mimir (메트릭)

```bash
# 메트릭 목록 조회 - 정상
curl "http://<ALB_DNS>/prometheus/api/v1/label/__name__/values" \
  -H "X-Scope-OrgID: jsj-lgtm-header"
```

저장된 메트릭:

- `aws_applicationelb_*` (ALB 메트릭)
- `aws_ecs_*` (ECS 메트릭)
- `aws_elb_*` (ELB 메트릭)
- `scrape_*`, `up` (스크래핑 메트릭)

#### 3. Loki (로그)

```bash
# 로그 전송 - HTTP 204 (성공)
curl -X POST "http://<ALB_DNS>/loki/api/v1/push" \
  -H "Content-Type: application/json" \
  -H "X-Scope-OrgID: jsj-lgtm-header" \
  -d '{"streams":[{"stream":{"job":"test"},"values":[["<timestamp>","test log"]]}]}'

# 로그 조회 - 정상
curl "http://<ALB_DNS>/loki/api/v1/query_range?query={job=\"test\"}" \
  -H "X-Scope-OrgID: jsj-lgtm-header"
```

- 저장된 라벨: `env`, `instance`, `job`, `service_name`
- Push/Query 모두 정상 동작

#### 4. Tempo (트레이스)

- 서비스 실행 중 (ECS 태스크 정상)
- ALB 라우팅 `/tempo/*` 설정됨
- 직접 API 호출 시 404 반환 (경로 prefix 문제)

#### 5. Pyroscope (프로파일링)

- 서비스 실행 중 (ECS 태스크 정상)
- `/ingest` 엔드포인트: HTTP 400 (요청 본문 누락)
- ALB 라우팅 설정 확인 필요

### 발견된 이슈

#### 1. Tempo/Pyroscope ALB 라우팅

현재 ALB 라우팅이 경로 prefix를 그대로 전달하여 일부 API 호출이 실패함.

- 현재: ALB → `/tempo/api/search` → Tempo
- 기대: Tempo는 `/api/search` 경로를 기대함

**해결 방안:**

1. Tempo/Pyroscope 설정에서 `http_prefix` 설정 추가
2. 또는 ALB에서 path rewrite 설정 (AWS ALB는 미지원)

#### 2. Grafana 인증

- 기본 설정으로 anonymous access 비활성화됨
- 브라우저에서 로그인 필요 (admin/admin)

### 테스트 명령어 모음

```bash
# ALB DNS 설정
ALB_DNS="lgtm-prod-alb-1519102595.ap-northeast-2.elb.amazonaws.com"

# Grafana 헬스체크
curl "http://${ALB_DNS}/api/health"

# Mimir 메트릭 조회
curl "http://${ALB_DNS}/prometheus/api/v1/labels" \
  -H "X-Scope-OrgID: jsj-lgtm-header"

# Loki 로그 전송
curl -X POST "http://${ALB_DNS}/loki/api/v1/push" \
  -H "Content-Type: application/json" \
  -H "X-Scope-OrgID: jsj-lgtm-header" \
  -d '{"streams":[{"stream":{"job":"test","env":"prod"},"values":[["'$(date +%s)000000000'","Test log"]]}]}'

# Loki 라벨 조회
curl "http://${ALB_DNS}/loki/api/v1/labels" \
  -H "X-Scope-OrgID: jsj-lgtm-header"
```

### 다음 단계

1. 브라우저에서 Grafana 접속 후 데이터소스 연결 확인
2. ~~Tempo/Pyroscope ALB 라우팅 수정 (선택적)~~ → 완료
3. 실제 애플리케이션에서 데이터 수집 테스트

---

## 01:30 - Tempo/Pyroscope http_path_prefix 설정 추가

### 문제 상황

ALB 라우팅 규칙이 `/tempo/*`, `/pyroscope/*` 경로를 해당 서비스로 전달하지만,
Tempo와 Pyroscope는 기본적으로 prefix 없이 `/api/...`, `/ready` 등의 경로를 기대함.

```text
# 문제
ALB → /tempo/api/search → Tempo (expects /api/search) → 404

# 해결
ALB → /tempo/api/search → Tempo (http_path_prefix: /tempo) → 200
```

### 수정 내용

#### 1. Tempo 설정 수정

- 파일: `ecs-migration/dockerfiles/tempo/config/tempo-config.yaml`
- 변경: `server.http_path_prefix: /tempo` 추가

```yaml
server:
  http_listen_port: 3200
  http_path_prefix: /tempo
```

#### 2. Pyroscope 설정 수정

- 파일: `ecs-migration/dockerfiles/pyroscope/config/pyroscope-config.yaml`
- 변경: `server.http_path_prefix: /pyroscope` 추가

```yaml
server:
  http_listen_port: 4040
  grpc_listen_port: 4041
  log_level: info
  http_path_prefix: /pyroscope
```

#### 3. ALB 헬스체크 경로 수정

- 파일: `ecs-migration/terraform/modules/alb/main.tf`
- Tempo: `/ready` → `/tempo/ready`
- Pyroscope: `/ready` → `/pyroscope/ready`

### 배포 필요 사항

1. Docker 이미지 리빌드 필요 (Tempo, Pyroscope)
2. Terraform Apply 필요 (ALB 헬스체크 경로 변경)

### 영향도

- Tempo: 이제 `/tempo/api/search`, `/tempo/ready` 등 prefix 경로 사용
- Pyroscope: 이제 `/pyroscope/ready`, `/pyroscope/api/v1/...` 등 prefix 경로 사용
- ALB 헬스체크가 새 경로를 사용하므로 이미지 먼저 배포 필요

---

## 02:00 - Pyroscope S3 Storage Prefix 및 Multitenancy 설정 추가

### 문제 상황

S3 버킷 구조 확인 결과:

```text
jsj-lgtm-data-s3/
├── anonymous/                    ← 문제! Pyroscope 기본 테넌트
├── blocks/
├── loki/
├── pyroscope_cluster_seed.json
└── tempo/
```

**문제점:**

1. `pyroscope/` 폴더가 없음 - storage prefix 미설정
2. `anonymous/` 폴더 생성 - multitenancy 미설정으로 기본 테넌트 사용

### 원인 분석

| 서비스 | Storage Prefix | Multitenancy | 상태 |
|--------|----------------|--------------|------|
| Loki | ✅ `loki` | ✅ `auth_enabled: true` | 정상 |
| Tempo | ✅ `tempo` | ✅ `multitenancy_enabled: true` | 정상 |
| Mimir | ✅ (별도 설정) | ✅ (별도 설정) | 정상 |
| Pyroscope | ❌ 없음 | ❌ 없음 | **문제** |

### 수정 내용

#### 1. Pyroscope 설정 파일 수정

파일: `ecs-migration/dockerfiles/pyroscope/config/pyroscope-config.yaml`

```yaml
target: all

multitenancy_enabled: true  # 추가: X-Scope-OrgID 헤더 필수

server:
  http_listen_port: 4040
  grpc_listen_port: 4041
  log_level: info
  http_path_prefix: /pyroscope

storage:
  backend: s3
  prefix: ${PYROSCOPE_STORAGE_PREFIX}/  # 추가: S3 prefix 설정
  s3:
    bucket_name: ${PYROSCOPE_S3_BUCKET}
    # ...
```

#### 2. ECS Task Definition 환경변수 추가

파일: `ecs-migration/terraform/modules/ecs/main.tf`

```hcl
environment = [
  { name = "AWS_REGION", value = var.aws_region },
  { name = "PYROSCOPE_S3_BUCKET", value = var.s3_bucket_name },
  { name = "PYROSCOPE_STORAGE_PREFIX", value = "pyroscope" },  # 추가
  { name = "TZ", value = "Asia/Seoul" }
]
```

### 수정 후 예상 S3 구조

```text
jsj-lgtm-data-s3/
├── loki/
│   └── jsj-lgtm-header/        ← Loki 테넌트별 데이터
├── tempo/
│   └── jsj-lgtm-header/        ← Tempo 테넌트별 데이터
├── pyroscope/                   ← 새로 생성됨
│   └── jsj-lgtm-header/        ← Pyroscope 테넌트별 데이터
└── blocks/                      ← Mimir 블록 데이터
```

### 배포 필요 사항

1. Docker 이미지 리빌드 (Pyroscope)
2. Terraform Apply (ECS Task Definition 환경변수)

### 영향도

- Pyroscope: 이제 `X-Scope-OrgID` 헤더 필수
- S3: 데이터가 `pyroscope/` prefix 아래에 저장됨
- 기존 `anonymous/` 폴더의 데이터는 마이그레이션 필요 (또는 삭제)

### 참고 문서

- [Pyroscope S3 Storage Configuration](https://grafana.com/docs/pyroscope/latest/configure-server/storage/configure-object-storage-backend/)

---

## 02:30 - Storage Prefix 하드코딩 제거

### 문제 상황

ECS Task Definition에서 storage prefix 값들이 하드코딩되어 있었음:

```hcl
# 하드코딩된 값들
{ name = "LOKI_STORAGE_PREFIX", value = "loki" },
{ name = "TEMPO_STORAGE_PREFIX", value = "tempo" },
{ name = "PYROSCOPE_STORAGE_PREFIX", value = "pyroscope" },
```

### 수정 내용

#### 1. common.tfvars에 storage_prefixes 변수 추가

```hcl
storage_prefixes = {
  loki      = "loki"
  tempo     = "tempo"
  pyroscope = "pyroscope"
}
```

#### 2. ECS 모듈 variables.tf에 변수 정의 추가

```hcl
variable "storage_prefixes" {
  description = "S3 storage prefixes for each service"
  type = object({
    loki      = string
    tempo     = string
    pyroscope = string
  })
}
```

#### 3. ECS 모듈 main.tf에서 변수 참조로 변경

```hcl
# Loki
{ name = "LOKI_STORAGE_PREFIX", value = var.storage_prefixes.loki }

# Tempo
{ name = "TEMPO_STORAGE_PREFIX", value = var.storage_prefixes.tempo }

# Pyroscope
{ name = "PYROSCOPE_STORAGE_PREFIX", value = var.storage_prefixes.pyroscope }
```

#### 4. 60-ecs root module 변수 전달 추가

- `variables.tf`: storage_prefixes 변수 정의
- `main.tf`: 모듈 호출 시 `storage_prefixes = var.storage_prefixes` 전달

### 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `common.tfvars` | storage_prefixes 변수 추가 |
| `modules/ecs/variables.tf` | storage_prefixes 변수 정의 |
| `modules/ecs/main.tf` | 하드코딩 → 변수 참조로 변경 |
| `environments/prod/60-ecs/variables.tf` | storage_prefixes 변수 정의 |
| `environments/prod/60-ecs/main.tf` | 모듈에 변수 전달 |

### 영향도

- 기능 변경 없음 (값은 동일)
- 코드 품질 개선 (DRY 원칙 준수)
- 향후 prefix 변경 시 common.tfvars만 수정하면 됨

---

## 02:45 - Mimir runtime_config S3 경로 지정

### 문제 상황

S3 버킷 루트(`/`)에 `tenant_settings.json` 파일이 생성됨.
Mimir의 runtime_config 기능이 기본 경로를 사용하여 루트에 파일 생성.

### 수정 내용

파일: `ecs-migration/dockerfiles/mimir/config/mimir-config.yaml`

```yaml
runtime_config:
  period: 10s
  file: s3://${MIMIR_S3_BUCKET}/mimir/runtime-config.yaml
```

### 영향도

- ~~Mimir 런타임 설정 파일이 `mimir/` 폴더에 저장됨~~
- ~~S3 버킷 루트 정리됨~~
- ~~Docker 이미지 리빌드 필요~~

**업데이트 (03:00)**: runtime_config 설정 롤백 - S3 URI 미지원으로 인한 서비스 장애 발생

---

## 03:00 - Mimir/Pyroscope 서비스 장애 분석 및 조치

### 문제 상황

ECS 서비스 상태 확인 결과:

| 서비스 | 상태 | 문제 |
|--------|------|------|
| Mimir | ❌ FAILED | runtime_config S3 URI 미지원 |
| Pyroscope | ❌ 롤백 중 | 헬스체크 404 (새 이미지 미배포) |
| Grafana | ✅ | 정상 |
| Loki | ✅ | 정상 |
| Tempo | ⚠️ | 일시적 경고 (정상) |
| Alloy | ✅ | 정상 |

### 원인 분석

#### 1. Mimir runtime_config 오류

```text
failed to load runtime config: read file "s3://jsj-lgtm-data-s3/mimir/runtime-config.yaml":
open s3://jsj-lgtm-data-s3/mimir/runtime-config.yaml: no such file or directory
```

**원인**: Mimir의 `runtime_config.file`은 **로컬 파일 경로**만 지원. `s3://` URI 미지원.

#### 2. Pyroscope 헬스체크 404

```text
GET /pyroscope/ready (404) - "404 page not found"
```

**원인**: ALB 헬스체크는 `/pyroscope/ready` 경로 사용, but 현재 실행 중인 이미지에는 `http_path_prefix` 설정이 없음 (새 이미지 미배포)

### 조치 내용

#### 1. Mimir runtime_config 제거

파일: `ecs-migration/dockerfiles/mimir/config/mimir-config.yaml`

```yaml
# 제거됨 (S3 URI 미지원)
# runtime_config:
#   period: 10s
#   file: s3://${MIMIR_S3_BUCKET}/mimir/runtime-config.yaml

# 대체: 주석으로 안내
# runtime_config는 선택적 기능이며 S3 URI를 직접 지원하지 않음
# 테넌트별 런타임 오버라이드가 필요한 경우 로컬 파일 또는 환경변수로 설정
```

#### 2. S3 파일 생성 (임시)

```bash
echo 'overrides: {}' | aws s3 cp - s3://jsj-lgtm-data-s3/mimir/runtime-config.yaml
```

(이 파일은 새 이미지 배포 후 삭제 가능)

### 후속 작업

1. **Mimir**: Docker 이미지 리빌드 (runtime_config 제거)
2. **Pyroscope**: Docker 이미지 리빌드 (http_path_prefix 포함)
3. **Tempo**: Docker 이미지 리빌드 (http_path_prefix 포함)
4. **Terraform Apply**: ECS Task Definition 업데이트 (storage_prefixes 변수)

### 학습 포인트

- Mimir의 `runtime_config.file`은 로컬 파일 경로만 지원
- S3 기반 런타임 설정이 필요하면 별도 사이드카나 초기화 컨테이너로 S3에서 파일 다운로드 필요
- ECS 배포 시 이미지 태그 변경 없이 설정만 변경하면 새 Task Definition이 생성되어도 기존 이미지 사용

---
