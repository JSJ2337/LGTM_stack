# 작업 이력 - 2026-01-14

## 10:30 - GitHub Actions Terraform 워크플로우 실패 원인 분석 및 수정

### 문제 원인

GitHub Actions에서 Terraform Infrastructure 워크플로우 실패 발생.

**근본 원인:**

- `ecs-migration/terraform/environments/prod/` 디렉토리에 `.tf` 파일이 없음
- Terraform 코드가 하위 폴더 (`01-vpc/`, `10-ecr/` 등)에 분리되어 있음
- 워크플로우가 `environments/prod/`에서 직접 `terraform init` 실행하여 빈 디렉토리로 인식

**에러 메시지:**

```text
Error: No configuration files
Plan requires configuration to be present.
```

### 변경 사항

#### 1. 워크플로우 재구조화

- 변경된 파일: `ecs-migration/.github/workflows/terraform.yaml`
- 변경 내용:
  - 단일 디렉토리 실행 → 컴포넌트별 순차/병렬 실행 방식으로 변경
  - 종속성 순서 기반 Stage 구분 (Stage 1~4)
  - 변경된 컴포넌트만 감지하여 실행하는 로직 추가
  - workflow_dispatch에 component 선택 옵션 추가

#### 2. Reusable Workflow 생성

- 생성된 파일: `ecs-migration/.github/workflows/terraform-component.yaml`
- 내용:
  - 개별 컴포넌트에 대한 Terraform init/plan/apply/destroy 실행
  - `common.tfvars` 자동 참조 (`-var-file="../common.tfvars"`)
  - PR 코멘트 자동 작성
  - Artifact 업로드 (7일 보관)

#### 3. 변수 타입 불일치 수정

- 변경된 파일: `ecs-migration/terraform/environments/prod/30-security-groups/variables.tf`
- 변경 내용: `ecs_service_ports` 변수 타입에 `from_alb`, `internal` optional 속성 추가
- 이유: `common.tfvars`와 모듈 변수 타입 불일치로 인한 Terraform 에러 방지

### 워크플로우 실행 순서

```text
Stage 1 (병렬): VPC, CloudWatch-Logs, ECR, IAM
     ↓
Stage 2 (VPC 종속): Security-Groups, CloudMap
     ↓
Stage 3 (VPC + SG 종속): ALB
     ↓
Stage 4 (전체 종속): ECS
```

### 영향도

- 영향받는 컴포넌트: 전체 Terraform CI/CD 파이프라인
- 주의사항:
  - 기존 단일 디렉토리 방식에서 컴포넌트별 방식으로 전환
  - GitHub Actions 실행 시 종속성 순서 자동 준수
  - `workflow_dispatch`로 개별 컴포넌트만 실행 가능

---

## 10:45 - common.tfvars와 루트 모듈 설정 분석

### 분석 결과

**설정 중복 없음 (정상)**

모든 루트 모듈이 `common.tfvars`를 단일 소스로 사용하도록 설계됨.

| 컴포넌트 | terraform.tfvars | common.tfvars 참조 |
|----------|------------------|-------------------|
| 01-vpc | 주석만 (설정 없음) | O |
| 05-cloudwatch-logs | 없음 | O |
| 10-ecr | 주석만 (설정 없음) | O |
| 20-iam | 없음 | O |
| 30-security-groups | 없음 | O |
| 40-cloudmap | 없음 | O |
| 50-alb | 없음 | O |
| 60-ecs | 없음 | O |

**발견된 타입 불일치 (수정 완료)**

- `30-security-groups/variables.tf`의 `ecs_service_ports` 타입에 `from_alb`, `internal` 속성 누락
- `common.tfvars`에서 해당 속성 사용 중이어서 타입 불일치 발생 가능
- 수정 완료: optional 속성 추가

---

## 11:15 - Backend 하드코딩 제거 및 common.tfvars 통합

### 변경 사항

#### 1. 불필요한 파일 삭제

- 삭제된 파일: 모든 컴포넌트의 `terraform.tfvars` (8개)
  - `01-vpc/terraform.tfvars`
  - `05-cloudwatch-logs/terraform.tfvars`
  - `10-ecr/terraform.tfvars`
  - `20-iam/terraform.tfvars`
  - `30-security-groups/terraform.tfvars`
  - `40-cloudmap/terraform.tfvars`
  - `50-alb/terraform.tfvars`
  - `60-ecs/terraform.tfvars`
- 이유: `common.tfvars`로 통합, 불필요한 중복 파일

#### 2. main.tf backend 블록 하드코딩 제거

- 변경된 파일: 모든 컴포넌트 `main.tf` (8개)
- 변경 전:

```hcl
backend "s3" {
  bucket         = "jsj-lgtm-terraform-state"
  key            = "lgtm-ecs/prod/XX-component/terraform.tfstate"
  region         = "ap-northeast-2"
  encrypt        = true
  dynamodb_table = "jsj-lgtm-terraform-locks"
}
```

- 변경 후:

```hcl
backend "s3" {
  key = "lgtm-ecs/prod/XX-component/terraform.tfstate"
}
```

- 이유: `-backend-config` 옵션으로 `common.tfvars` 값 사용

#### 3. common.tfvars에 backend 설정 추가

- 변경된 파일: `common.tfvars`
- 추가된 변수: `state_lock_table = "jsj-lgtm-terraform-locks"`
- 기존 변수 유지: `state_bucket`, `aws_region`

#### 4. 워크플로우 terraform init 수정

- 변경된 파일: `terraform-component.yaml`
- 변경 내용: `common.tfvars`에서 backend 설정 읽어서 `-backend-config` 옵션으로 전달

```yaml
- name: Terraform Init
  run: |
    TFVARS="../common.tfvars"
    STATE_BUCKET=$(grep '^state_bucket' $TFVARS | cut -d'"' -f2)
    STATE_LOCK_TABLE=$(grep '^state_lock_table' $TFVARS | cut -d'"' -f2)
    AWS_REGION=$(grep '^aws_region' $TFVARS | cut -d'"' -f2)

    terraform init -upgrade \
      -backend-config="bucket=${STATE_BUCKET}" \
      -backend-config="region=${AWS_REGION}" \
      -backend-config="dynamodb_table=${STATE_LOCK_TABLE}" \
      -backend-config="encrypt=true"
```

### 영향도

- 영향받는 컴포넌트: 전체 Terraform 루트 모듈 (8개)
- 주의사항:
  - 로컬에서 `terraform init` 실행 시 `-backend-config` 옵션 필요
  - GitHub Actions에서는 자동으로 `common.tfvars` 참조
  - `common.tfvars` 하나만 수정하면 전체 backend 설정 변경 가능

---

## 12:00 - GitHub Actions Reusable Workflow 권한 에러 수정

### 문제 원인

GitHub Actions에서 reusable workflow 호출 시 권한 상속 에러 발생.

**에러 메시지:**

```text
Error calling workflow... The nested job 'terraform' is requesting
'pull-requests: write, id-token: write', but is only allowed
'pull-requests: none, id-token: none'.
```

**근본 원인:**

- reusable workflow(`terraform-component.yaml`)에서 `permissions` 블록 정의
- caller workflow(`terraform.yaml`)에서 권한을 명시적으로 부여하지 않음
- `workflow_call` 사용 시 권한은 caller에서 부여해야 함

### 변경 사항

#### 1. caller workflow에 permissions 추가

- 변경된 파일: `.github/workflows/terraform.yaml`
- 변경 내용: 워크플로우 최상위에 `permissions` 블록 추가

```yaml
permissions:
  id-token: write      # AWS OIDC 인증용
  contents: read       # 코드 체크아웃용
  pull-requests: write # PR 코멘트 작성용
```

#### 2. reusable workflow에서 permissions 제거

- 변경된 파일: `.github/workflows/terraform-component.yaml`
- 변경 내용: `permissions` 블록 제거 (caller에서 상속)

### 영향도

- 영향받는 컴포넌트: GitHub Actions CI/CD 파이프라인
- 주의사항: reusable workflow는 caller의 권한을 상속받음

---

## 13:00 - 불필요한 워크플로우 삭제

### 변경 사항

- 삭제된 파일: `.github/workflows/build-only.yaml`
- 이유: `deploy-ecs.yaml` 워크플로우가 동일한 기능 제공 (Docker 빌드 + ECR 푸시)
- 중복 코드 제거 및 워크플로우 단순화

---

## 13:30 - Terraform 인프라 배포 및 Output 불일치 수정

### 배포 결과

GitHub Actions를 통해 전체 LGTM Stack 인프라 배포 완료 (8개 컴포넌트).

### 발견 및 수정된 문제

#### 1. VPC Output 불일치

- 변경된 파일: `ecs-migration/terraform/environments/prod/01-vpc/outputs.tf`
- 변경 내용: `nat_gateway_ids` → `nat_gateway_ips` (모듈 output과 일치)

#### 2. IAM Output 누락

- 변경된 파일: `ecs-migration/terraform/modules/iam/outputs.tf`
- 추가된 outputs:
  - `lgtm_task_role_name`
  - `alloy_task_role_name`
  - `grafana_task_role_name`

#### 3. IAM Sensitive Output 플래그 추가

- 변경된 파일: `ecs-migration/terraform/environments/prod/20-iam/outputs.tf`
- 변경 내용: ARN 출력에 `sensitive = true` 추가
  - `task_execution_role_arn`
  - `lgtm_task_role_arn`
  - `alloy_task_role_arn`
  - `grafana_task_role_arn`

#### 4. ALB Output 불일치

- 변경된 파일: `ecs-migration/terraform/environments/prod/50-alb/outputs.tf`
- 변경 내용: 모듈 output 이름과 일치하도록 수정
  - `module.alb.alb_arn` → `module.alb.arn`
  - `module.alb.alb_dns_name` → `module.alb.dns_name`
  - `module.alb.alb_zone_id` → `module.alb.zone_id`

#### 5. ECS Output 불일치

- 변경된 파일: `ecs-migration/terraform/environments/prod/60-ecs/outputs.tf`
- 변경 내용: 개별 서비스 output으로 변경 (map 형태 대신)
  - `mimir_service_name`, `loki_service_name`, `tempo_service_name`
  - `pyroscope_service_name`, `grafana_service_name`, `alloy_service_name`

### 기존 AWS 리소스 충돌 해결

배포 중 기존 리소스와의 충돌 해결을 위해 삭제:

- ECR 리포지토리 6개 (mimir, loki, tempo, pyroscope, grafana, alloy)
- IAM 역할 4개 (lgtm-ecs-task-execution, lgtm-task, alloy-task, grafana-task)
- ALB, Listener, Target Groups
- ECS 서비스 6개

---

## 14:00 - Terraform Warning 처리

### 문제 원인

Terraform plan/apply 실행 시 다수의 경고 메시지 출력:

```text
Warning: Value for undeclared variable
The root module does not declare a variable named "X"
```

### 변경 사항

- 변경된 파일: `.github/workflows/terraform-component.yaml`
- 변경 내용: `-compact-warnings` 옵션 추가

```yaml
# Plan 단계
terraform plan \
  -var-file="../common.tfvars" \
  -detailed-exitcode \
  -compact-warnings \
  -out=tfplan

# Apply 단계
terraform apply -auto-approve -compact-warnings tfplan

# Destroy 단계
terraform destroy \
  -var-file="../common.tfvars" \
  -compact-warnings \
  -auto-approve
```

### 미처리 경고 (영향 없음)

- DynamoDB deprecated warning: `aws_dynamodb_table`의 `read_capacity`, `write_capacity` 속성
- 사유: PAY_PER_REQUEST 모드에서는 무시됨, 기능에 영향 없음

### 영향도

- 영향받는 컴포넌트: GitHub Actions Terraform 워크플로우
- 효과: 경고 메시지 압축되어 로그 가독성 향상

---

## 15:30 - LGTM Stack Docker Compose 통일성 및 재사용성 개선

### 문제 분석

기존 LGTM Stack YAML 파일들의 통일성 및 재사용성 문제점 발견.

**발견된 문제:**

| 항목 | 기존 상태 |
|------|----------|
| 이미지 태그 | `latest` 사용 (Tempo, Pyroscope, Alloy) |
| 컨테이너명 prefix | `ftt-` (비표준) |
| user 설정 | `"0"`, `root`, `"0:0"` 혼용 |
| 헬스체크 | 일부만 구현 |
| 로깅 설정 | 일부만 구현 |
| labels | Mimir만 구현 |
| 하드코딩 | S3 버킷명, 리전, 네트워크명 등 |

### 변경 사항

#### 1. 공통 `.env` 파일 생성

- 생성된 파일: `.env`, `.env.example`
- 내용:
  - 공통 설정 (prefix: `jsj`, network: `jsj-lgtm-net`)
  - AWS 설정 (리전, S3 버킷)
  - 이미지 버전 (모두 고정 버전)
  - Grafana 설정 (관리자 계정, URL 등)
  - 테넌트 설정
  - 로깅 설정
  - 포트 설정

#### 2. 이미지 버전 고정

| 컴포넌트 | 변경 전 | 변경 후 |
|----------|---------|---------|
| Mimir | 2.16.0 | 2.16.0 (유지) |
| Loki | 3.5.1 | 3.5.1 (유지) |
| Tempo | latest | **2.9.0** |
| Pyroscope | latest | **1.13.5** |
| Grafana | 12.1.0 | 12.1.0 (유지) |
| Alloy | latest | **1.9.2** |
| Memcached | 1.6.28-alpine | 1.6.28-alpine (유지) |

#### 3. 컨테이너명 prefix 통일

- 변경 전: `ftt-` (예: `ftt-mimir`, `ftt-loki`)
- 변경 후: `jsj-` (예: `jsj-mimir`, `jsj-loki`)
- 환경변수: `CONTAINER_PREFIX=jsj`

#### 4. 6개 docker-compose 파일 전면 개선

**변경된 파일:**

- `mimir/mimir_docker-compose.yaml`
- `loki/loki_docker-compose.yaml`
- `tempo/tempo-docker-compose.yaml`
- `pyroscope/pyroscope-docker-compose.yaml`
- `grafana/grafana-docker-compose.yaml`
- `alloy/container/alloy_multi-docker-compose.yaml`

**통일된 설정:**

| 항목 | 설정 |
|------|------|
| user | `"0:0"` |
| restart | `unless-stopped` |
| healthcheck | 전체 적용 (interval: 30s, timeout: 10s) |
| logging | json-file (max-size: `${LOG_MAX_SIZE}`, max-file: `${LOG_MAX_FILE}`) |
| labels | app, component, environment, version |
| stop_signal | SIGTERM |
| stop_grace_period | 30s (15s for exporters) |
| networks | `${DOCKER_NETWORK}` (jsj-lgtm-net) |

#### 5. 하드코딩 제거

- S3 버킷명: `sys-lgtm-s3` → `${S3_BUCKET}`
- AWS 리전: `ap-northeast-2` → `${AWS_REGION}`
- 네트워크명: `mimir-net` → `${DOCKER_NETWORK}`
- 포트: 하드코딩 → `${COMPONENT_PORT}` 형식

### 실행 방법 변경

```bash
# 변경 전
docker-compose -f mimir/mimir_docker-compose.yaml up -d

# 변경 후
docker-compose --env-file .env -f mimir/mimir_docker-compose.yaml up -d
```

### 네트워크 사전 생성 필요

```bash
docker network create jsj-lgtm-net
```

### 영향도

- 영향받는 컴포넌트: 전체 LGTM Stack (6개 docker-compose 파일)
- 주의사항:
  - 기존 컨테이너 prefix 변경 (`ftt-` → `jsj-`)
  - 기존 네트워크 변경 (`mimir-net` → `jsj-lgtm-net`)
  - `.env` 파일 필수 (`.env.example` 참고하여 생성)
  - `latest` 태그 사용 금지 (버전 고정)

---

## 16:00 - ECS Fargate 코드 통일성 및 재사용성 개선

### 문제 분석

ECS 관련 코드에서 하드코딩 및 중복 문제 발견.

**발견된 문제:**

| 항목 | 기존 상태 |
|------|----------|
| Dockerfile 버전 | 하드코딩 (일부 구버전) |
| Dockerfile ENV | 하드코딩 (AWS_REGION, S3_BUCKET 등) |
| task-definition.json | Terraform과 중복 관리 |
| ECS Task Definition | `:latest` 태그 사용 |

### 변경 사항

#### 1. common.tfvars에 이미지 버전 및 테넌트 설정 추가

- 변경된 파일: `ecs-migration/terraform/environments/prod/common.tfvars`
- 추가된 변수:
  - `image_versions`: Docker Compose와 동일한 버전 (6개 컴포넌트)
  - `tenants`: 멀티테넌트 설정 (default, cloudflare, rds)

#### 2. Dockerfile 하드코딩 제거 (6개)

**변경된 파일:**

- `ecs-migration/dockerfiles/mimir/Dockerfile`
- `ecs-migration/dockerfiles/loki/Dockerfile`
- `ecs-migration/dockerfiles/tempo/Dockerfile`
- `ecs-migration/dockerfiles/pyroscope/Dockerfile`
- `ecs-migration/dockerfiles/grafana/Dockerfile`
- `ecs-migration/dockerfiles/alloy/Dockerfile`

**변경 내용:**

- `ARG VERSION` 사용 (빌드 시 `--build-arg VERSION=x.x.x` 전달)
- 하드코딩된 `ENV` 제거 (런타임에 ECS Task Definition에서 주입)
- 버전을 Docker Compose와 동일하게 통일

| 컴포넌트 | 변경 전 버전 | 변경 후 버전 |
|----------|-------------|-------------|
| Mimir | 2.16.0 | 2.16.0 (유지) |
| Loki | 3.5.1 | 3.5.1 (유지) |
| Tempo | 2.7.2 | **2.9.0** |
| Pyroscope | 1.11.1 | **1.13.5** |
| Grafana | 12.1.0 | 12.1.0 (유지) |
| Alloy | 1.5.1 | **1.9.2** |

#### 3. Terraform ECS 모듈 변수 추가

- 변경된 파일:
  - `ecs-migration/terraform/modules/ecs/variables.tf`
  - `ecs-migration/terraform/modules/ecs/main.tf`
  - `ecs-migration/terraform/environments/prod/60-ecs/variables.tf`
  - `ecs-migration/terraform/environments/prod/60-ecs/main.tf`

**추가된 변수:**

```hcl
variable "image_versions" {
  type = object({
    mimir     = string
    loki      = string
    tempo     = string
    pyroscope = string
    grafana   = string
    alloy     = string
  })
}

variable "tenants" {
  type = object({
    default    = string
    cloudflare = string
    rds        = string
  })
}
```

**Task Definition 변경:**

```hcl
# 변경 전
image = "${var.ecr_repository_urls["lgtm-mimir"]}:latest"

# 변경 후
image = "${var.ecr_repository_urls["lgtm-mimir"]}:${var.image_versions.mimir}"
```

#### 4. 중복 파일 삭제

- 삭제된 폴더: `ecs-migration/task-definitions/` (6개 JSON 파일)
- 이유: Terraform ECS 모듈에서 동일한 기능 제공 (중복 관리 방지)

### Docker Compose와 ECS 버전 동기화

| 컴포넌트 | Docker Compose (.env) | ECS (common.tfvars) |
|----------|----------------------|---------------------|
| Mimir | 2.16.0 | 2.16.0 |
| Loki | 3.5.1 | 3.5.1 |
| Tempo | 2.9.0 | 2.9.0 |
| Pyroscope | 1.13.5 | 1.13.5 |
| Grafana | 12.1.0 | 12.1.0 |
| Alloy | 1.9.2 | 1.9.2 |

### 영향도

- 영향받는 컴포넌트:
  - ECS Dockerfile (6개)
  - Terraform ECS 모듈
  - ECS Task Definition (6개 서비스)
- 주의사항:
  - Docker 이미지 재빌드 필요 (`--build-arg VERSION=x.x.x`)
  - Terraform apply 필요 (Task Definition 업데이트)
  - `common.tfvars`에서 버전 중앙 관리
