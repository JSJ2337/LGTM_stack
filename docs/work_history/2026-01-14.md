# 작업 이력 - 2026-01-14

## 10:30 - GitHub Actions Terraform 워크플로우 실패 원인 분석 및 수정

### 문제 원인

GitHub Actions에서 Terraform Infrastructure 워크플로우 실패 발생.

**근본 원인:**

- `ecs-migration/terraform/environments/prod/` 디렉토리에 `.tf` 파일이 없음
- Terraform 코드가 하위 폴더 (`01-vpc/`, `10-ecr/` 등)에 분리되어 있음
- 워크플로우가 `environments/prod/`에서 직접 `terraform init` 실행하여 빈 디렉토리로 인식

**에러 메시지:**

```text
Error: No configuration files
Plan requires configuration to be present.
```

### 변경 사항

#### 1. 워크플로우 재구조화

- 변경된 파일: `ecs-migration/.github/workflows/terraform.yaml`
- 변경 내용:
  - 단일 디렉토리 실행 → 컴포넌트별 순차/병렬 실행 방식으로 변경
  - 종속성 순서 기반 Stage 구분 (Stage 1~4)
  - 변경된 컴포넌트만 감지하여 실행하는 로직 추가
  - workflow_dispatch에 component 선택 옵션 추가

#### 2. Reusable Workflow 생성

- 생성된 파일: `ecs-migration/.github/workflows/terraform-component.yaml`
- 내용:
  - 개별 컴포넌트에 대한 Terraform init/plan/apply/destroy 실행
  - `common.tfvars` 자동 참조 (`-var-file="../common.tfvars"`)
  - PR 코멘트 자동 작성
  - Artifact 업로드 (7일 보관)

#### 3. 변수 타입 불일치 수정

- 변경된 파일: `ecs-migration/terraform/environments/prod/30-security-groups/variables.tf`
- 변경 내용: `ecs_service_ports` 변수 타입에 `from_alb`, `internal` optional 속성 추가
- 이유: `common.tfvars`와 모듈 변수 타입 불일치로 인한 Terraform 에러 방지

### 워크플로우 실행 순서

```text
Stage 1 (병렬): VPC, CloudWatch-Logs, ECR, IAM
     ↓
Stage 2 (VPC 종속): Security-Groups, CloudMap
     ↓
Stage 3 (VPC + SG 종속): ALB
     ↓
Stage 4 (전체 종속): ECS
```

### 영향도

- 영향받는 컴포넌트: 전체 Terraform CI/CD 파이프라인
- 주의사항:
  - 기존 단일 디렉토리 방식에서 컴포넌트별 방식으로 전환
  - GitHub Actions 실행 시 종속성 순서 자동 준수
  - `workflow_dispatch`로 개별 컴포넌트만 실행 가능

---

## 10:45 - common.tfvars와 루트 모듈 설정 분석

### 분석 결과

**설정 중복 없음 (정상)**

모든 루트 모듈이 `common.tfvars`를 단일 소스로 사용하도록 설계됨.

| 컴포넌트 | terraform.tfvars | common.tfvars 참조 |
|----------|------------------|-------------------|
| 01-vpc | 주석만 (설정 없음) | O |
| 05-cloudwatch-logs | 없음 | O |
| 10-ecr | 주석만 (설정 없음) | O |
| 20-iam | 없음 | O |
| 30-security-groups | 없음 | O |
| 40-cloudmap | 없음 | O |
| 50-alb | 없음 | O |
| 60-ecs | 없음 | O |

**발견된 타입 불일치 (수정 완료)**

- `30-security-groups/variables.tf`의 `ecs_service_ports` 타입에 `from_alb`, `internal` 속성 누락
- `common.tfvars`에서 해당 속성 사용 중이어서 타입 불일치 발생 가능
- 수정 완료: optional 속성 추가

---

## 11:15 - Backend 하드코딩 제거 및 common.tfvars 통합

### 변경 사항

#### 1. 불필요한 파일 삭제

- 삭제된 파일: 모든 컴포넌트의 `terraform.tfvars` (8개)
  - `01-vpc/terraform.tfvars`
  - `05-cloudwatch-logs/terraform.tfvars`
  - `10-ecr/terraform.tfvars`
  - `20-iam/terraform.tfvars`
  - `30-security-groups/terraform.tfvars`
  - `40-cloudmap/terraform.tfvars`
  - `50-alb/terraform.tfvars`
  - `60-ecs/terraform.tfvars`
- 이유: `common.tfvars`로 통합, 불필요한 중복 파일

#### 2. main.tf backend 블록 하드코딩 제거

- 변경된 파일: 모든 컴포넌트 `main.tf` (8개)
- 변경 전:

```hcl
backend "s3" {
  bucket         = "jsj-lgtm-terraform-state"
  key            = "lgtm-ecs/prod/XX-component/terraform.tfstate"
  region         = "ap-northeast-2"
  encrypt        = true
  dynamodb_table = "jsj-lgtm-terraform-locks"
}
```

- 변경 후:

```hcl
backend "s3" {
  key = "lgtm-ecs/prod/XX-component/terraform.tfstate"
}
```

- 이유: `-backend-config` 옵션으로 `common.tfvars` 값 사용

#### 3. common.tfvars에 backend 설정 추가

- 변경된 파일: `common.tfvars`
- 추가된 변수: `state_lock_table = "jsj-lgtm-terraform-locks"`
- 기존 변수 유지: `state_bucket`, `aws_region`

#### 4. 워크플로우 terraform init 수정

- 변경된 파일: `terraform-component.yaml`
- 변경 내용: `common.tfvars`에서 backend 설정 읽어서 `-backend-config` 옵션으로 전달

```yaml
- name: Terraform Init
  run: |
    TFVARS="../common.tfvars"
    STATE_BUCKET=$(grep '^state_bucket' $TFVARS | cut -d'"' -f2)
    STATE_LOCK_TABLE=$(grep '^state_lock_table' $TFVARS | cut -d'"' -f2)
    AWS_REGION=$(grep '^aws_region' $TFVARS | cut -d'"' -f2)

    terraform init -upgrade \
      -backend-config="bucket=${STATE_BUCKET}" \
      -backend-config="region=${AWS_REGION}" \
      -backend-config="dynamodb_table=${STATE_LOCK_TABLE}" \
      -backend-config="encrypt=true"
```

### 영향도

- 영향받는 컴포넌트: 전체 Terraform 루트 모듈 (8개)
- 주의사항:
  - 로컬에서 `terraform init` 실행 시 `-backend-config` 옵션 필요
  - GitHub Actions에서는 자동으로 `common.tfvars` 참조
  - `common.tfvars` 하나만 수정하면 전체 backend 설정 변경 가능

---

## 12:00 - GitHub Actions Reusable Workflow 권한 에러 수정

### 문제 원인

GitHub Actions에서 reusable workflow 호출 시 권한 상속 에러 발생.

**에러 메시지:**

```text
Error calling workflow... The nested job 'terraform' is requesting
'pull-requests: write, id-token: write', but is only allowed
'pull-requests: none, id-token: none'.
```

**근본 원인:**

- reusable workflow(`terraform-component.yaml`)에서 `permissions` 블록 정의
- caller workflow(`terraform.yaml`)에서 권한을 명시적으로 부여하지 않음
- `workflow_call` 사용 시 권한은 caller에서 부여해야 함

### 변경 사항

#### 1. caller workflow에 permissions 추가

- 변경된 파일: `.github/workflows/terraform.yaml`
- 변경 내용: 워크플로우 최상위에 `permissions` 블록 추가

```yaml
permissions:
  id-token: write      # AWS OIDC 인증용
  contents: read       # 코드 체크아웃용
  pull-requests: write # PR 코멘트 작성용
```

#### 2. reusable workflow에서 permissions 제거

- 변경된 파일: `.github/workflows/terraform-component.yaml`
- 변경 내용: `permissions` 블록 제거 (caller에서 상속)

### 영향도

- 영향받는 컴포넌트: GitHub Actions CI/CD 파이프라인
- 주의사항: reusable workflow는 caller의 권한을 상속받음
