# 작업 이력 - 2026-01-15

## 10:00 - Terraform Bootstrap 모듈 생성 및 워크플로우 수정

### 배경

GitHub Actions에서 Terraform 배포 실패. S3 버킷 `jsj-lgtm-terraform-state`가 존재하지 않아 terraform init 실패.

### 변경 사항

#### 1. Bootstrap 모듈 생성

- 생성된 폴더: `ecs-migration/terraform/environments/prod/00-bootstrap/`
- 생성된 파일:
  - `main.tf` - S3 버킷 및 DynamoDB 테이블 생성
  - `variables.tf` - 변수 정의
  - `outputs.tf` - 출력값 정의

**main.tf 주요 내용:**

```hcl
terraform {
  required_version = ">= 1.0.0"
  backend "s3" {
    key = "bootstrap/terraform.tfstate"
  }
}

resource "aws_s3_bucket" "terraform_state" {
  bucket = var.state_bucket
}

resource "aws_dynamodb_table" "terraform_lock" {
  name         = var.state_lock_table
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "LockID"
}
```

#### 2. common.tfvars 버킷명 변경

- 변경된 파일: `ecs-migration/terraform/environments/prod/common.tfvars`
- 변경 내용:
  - `state_bucket = "jsj-lgtm-terraform-state-prod"`
  - `state_lock_table = "jsj-lgtm-terraform-lock-prod"`

#### 3. Bootstrap 전용 S3 버킷 수동 생성

- 버킷명: `jsj-lgtm-terraform-bootstrap`
- 목적: Bootstrap 모듈의 state 파일 저장 (chicken-and-egg 문제 해결)
- 생성 방법: AWS CLI (`aws s3 mb s3://jsj-lgtm-terraform-bootstrap`)

#### 4. terraform-component.yaml 수정

- 변경된 파일: `.github/workflows/terraform-component.yaml`
- 변경 내용: Plan, Apply, Destroy job의 terraform init에 조건부 로직 추가

**조건부 로직:**

```yaml
- name: Terraform Init
  run: |
    TFVARS="../common.tfvars"
    AWS_REGION=$(grep '^aws_region' $TFVARS | cut -d'"' -f2)

    # Bootstrap은 별도 버킷 사용 (DynamoDB locking 없음)
    if [ "${{ inputs.component }}" == "00-bootstrap" ]; then
      terraform init -upgrade \
        -backend-config="bucket=jsj-lgtm-terraform-bootstrap" \
        -backend-config="region=${AWS_REGION}" \
        -backend-config="encrypt=true"
    else
      STATE_BUCKET=$(grep '^state_bucket' $TFVARS | cut -d'"' -f2)
      STATE_LOCK_TABLE=$(grep '^state_lock_table' $TFVARS | cut -d'"' -f2)
      terraform init -upgrade \
        -backend-config="bucket=${STATE_BUCKET}" \
        -backend-config="region=${AWS_REGION}" \
        -backend-config="dynamodb_table=${STATE_LOCK_TABLE}" \
        -backend-config="encrypt=true"
    fi
```

#### 5. terraform.yaml 워크플로우 수정

- 변경된 파일: `.github/workflows/terraform.yaml`
- 변경 내용: `00-bootstrap` 컴포넌트 옵션 추가

#### 6. IAM 정책 권한 추가

- 변경 대상: `jsj_github_action_LGTM` IAM 정책
- 추가된 권한:
  - `dynamodb:CreateTable`
  - `dynamodb:DeleteTable`
  - `dynamodb:TagResource`
  - `dynamodb:UntagResource`
  - `dynamodb:UpdateTable`

### 아키텍처

```text
Bootstrap 모듈 구조:
┌──────────────────────────────────────────────────────┐
│  jsj-lgtm-terraform-bootstrap (수동 생성)            │
│  └── bootstrap/terraform.tfstate                    │
└──────────────────────────────────────────────────────┘
                        │
                        ▼ (Bootstrap 모듈이 생성)
┌──────────────────────────────────────────────────────┐
│  jsj-lgtm-terraform-state-prod                       │
│  └── lgtm-ecs/prod/XX-component/terraform.tfstate   │
└──────────────────────────────────────────────────────┘
┌──────────────────────────────────────────────────────┐
│  jsj-lgtm-terraform-lock-prod (DynamoDB)            │
└──────────────────────────────────────────────────────┘
```

### 영향도

- 영향받는 컴포넌트:
  - GitHub Actions Terraform 워크플로우
  - 전체 Terraform 컴포넌트 (state backend 변경)
- 주의사항:
  - Bootstrap은 다른 컴포넌트보다 먼저 실행해야 함
  - Bootstrap의 state는 별도 버킷(`jsj-lgtm-terraform-bootstrap`)에 저장
  - Bootstrap 버킷은 DynamoDB locking 없이 운영

---
