# 작업 이력 - 2026-01-15

## 10:00 - Terraform Bootstrap 모듈 생성 및 워크플로우 수정

### 배경

GitHub Actions에서 Terraform 배포 실패. S3 버킷 `jsj-lgtm-terraform-state`가 존재하지 않아 terraform init 실패.

### 변경 사항

#### 1. Bootstrap 모듈 생성

- 생성된 폴더: `ecs-migration/terraform/environments/prod/00-bootstrap/`
- 생성된 파일:
  - `main.tf` - S3 버킷 및 DynamoDB 테이블 생성
  - `variables.tf` - 변수 정의
  - `outputs.tf` - 출력값 정의

**main.tf 주요 내용:**

```hcl
terraform {
  required_version = ">= 1.0.0"
  backend "s3" {
    key = "bootstrap/terraform.tfstate"
  }
}

resource "aws_s3_bucket" "terraform_state" {
  bucket = var.state_bucket
}

resource "aws_dynamodb_table" "terraform_lock" {
  name         = var.state_lock_table
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "LockID"
}
```

#### 2. common.tfvars 버킷명 변경

- 변경된 파일: `ecs-migration/terraform/environments/prod/common.tfvars`
- 변경 내용:
  - `state_bucket = "jsj-lgtm-terraform-state-prod"`
  - `state_lock_table = "jsj-lgtm-terraform-lock-prod"`

#### 3. Bootstrap 전용 S3 버킷 수동 생성

- 버킷명: `jsj-lgtm-terraform-bootstrap`
- 목적: Bootstrap 모듈의 state 파일 저장 (chicken-and-egg 문제 해결)
- 생성 방법: AWS CLI (`aws s3 mb s3://jsj-lgtm-terraform-bootstrap`)

#### 4. terraform-component.yaml 수정

- 변경된 파일: `.github/workflows/terraform-component.yaml`
- 변경 내용: Plan, Apply, Destroy job의 terraform init에 조건부 로직 추가

**조건부 로직:**

```yaml
- name: Terraform Init
  run: |
    TFVARS="../common.tfvars"
    AWS_REGION=$(grep '^aws_region' $TFVARS | cut -d'"' -f2)

    # Bootstrap은 별도 버킷 사용 (DynamoDB locking 없음)
    if [ "${{ inputs.component }}" == "00-bootstrap" ]; then
      terraform init -upgrade \
        -backend-config="bucket=jsj-lgtm-terraform-bootstrap" \
        -backend-config="region=${AWS_REGION}" \
        -backend-config="encrypt=true"
    else
      STATE_BUCKET=$(grep '^state_bucket' $TFVARS | cut -d'"' -f2)
      STATE_LOCK_TABLE=$(grep '^state_lock_table' $TFVARS | cut -d'"' -f2)
      terraform init -upgrade \
        -backend-config="bucket=${STATE_BUCKET}" \
        -backend-config="region=${AWS_REGION}" \
        -backend-config="dynamodb_table=${STATE_LOCK_TABLE}" \
        -backend-config="encrypt=true"
    fi
```

#### 5. terraform.yaml 워크플로우 수정

- 변경된 파일: `.github/workflows/terraform.yaml`
- 변경 내용: `00-bootstrap` 컴포넌트 옵션 추가

#### 6. IAM 정책 권한 추가

- 변경 대상: `jsj_github_action_LGTM` IAM 정책
- 추가된 권한:
  - `dynamodb:CreateTable`
  - `dynamodb:DeleteTable`
  - `dynamodb:TagResource`
  - `dynamodb:UntagResource`
  - `dynamodb:UpdateTable`

### 아키텍처

```text
Bootstrap 모듈 구조:
┌──────────────────────────────────────────────────────┐
│  jsj-lgtm-terraform-bootstrap (수동 생성)            │
│  └── bootstrap/terraform.tfstate                    │
└──────────────────────────────────────────────────────┘
                        │
                        ▼ (Bootstrap 모듈이 생성)
┌──────────────────────────────────────────────────────┐
│  jsj-lgtm-terraform-state-prod                       │
│  └── lgtm-ecs/prod/XX-component/terraform.tfstate   │
└──────────────────────────────────────────────────────┘
┌──────────────────────────────────────────────────────┐
│  jsj-lgtm-terraform-lock-prod (DynamoDB)            │
└──────────────────────────────────────────────────────┘
```

### 영향도

- 영향받는 컴포넌트:
  - GitHub Actions Terraform 워크플로우
  - 전체 Terraform 컴포넌트 (state backend 변경)
- 주의사항:
  - Bootstrap은 다른 컴포넌트보다 먼저 실행해야 함
  - Bootstrap의 state는 별도 버킷(`jsj-lgtm-terraform-bootstrap`)에 저장
  - Bootstrap 버킷은 DynamoDB locking 없이 운영

---

## 15:00 - Tempo OTLP 4318 포트 제거 (Port 80 통합)

### 배경

Tempo OTLP HTTP(4318) 포트가 별도 리스너로 구성되어 있었으나, Port 80의 path-based routing (`/v1/traces`)으로 통합 가능하여 불필요한 포트 제거.

### 변경 사항

#### 1. ALB 모듈 수정

- 변경된 파일: `ecs-migration/terraform/modules/alb/main.tf`
- 삭제된 리소스:
  - `aws_lb_target_group.tempo_otlp` (4318 target group)
  - `aws_lb_listener.tempo_otlp` (4318 listener)

#### 2. ALB outputs 수정

- 변경된 파일: `ecs-migration/terraform/modules/alb/outputs.tf`
- 삭제된 출력:
  - `tempo_otlp_target_group_arn`
  - `target_group_arns` map에서 `tempo_otlp` 제거

#### 3. ECS 모듈 수정

- 변경된 파일: `ecs-migration/terraform/modules/ecs/variables.tf`
- 삭제된 변수: `tempo_otlp_target_group_arn`

- 변경된 파일: `ecs-migration/terraform/modules/ecs/main.tf`
- 삭제된 설정: Tempo 서비스의 OTLP 4318 load_balancer 블록

#### 4. common.tfvars 수정

- 변경된 파일: `ecs-migration/terraform/environments/prod/common.tfvars`
- 삭제된 항목:
  - `alb_ingress_rules.tempo_otlp` (ALB 보안 그룹)
  - `ecs_service_ports.tempo_otlp_grpc` (ECS 보안 그룹)
  - `ecs_service_ports.tempo_otlp_http` (ECS 보안 그룹)

#### 5. 60-ecs main.tf 수정

- 변경된 파일: `ecs-migration/terraform/environments/prod/60-ecs/main.tf`
- 삭제된 참조: `tempo_otlp_target_group_arn`

### 변경 전후 비교

```text
변경 전:
┌─────────────────────────────────────────────┐
│              ALB                            │
│  Port 80  → Grafana, Mimir, Loki, Tempo     │
│  Port 4318 → Tempo OTLP (별도)              │
└─────────────────────────────────────────────┘

변경 후:
┌─────────────────────────────────────────────┐
│              ALB                            │
│  Port 80  → 모든 서비스 통합                │
│    /api/v1/push    → Mimir                  │
│    /loki/*         → Loki                   │
│    /v1/traces      → Tempo (OTLP 포함)      │
│    /tempo/*        → Tempo                  │
│    /pyroscope/*    → Pyroscope              │
│    /               → Grafana (기본)         │
└─────────────────────────────────────────────┘
```

### 클라이언트 설정 변경

```text
변경 전: OTEL_EXPORTER_OTLP_ENDPOINT=http://<ALB>:4318
변경 후: OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://<ALB>/v1/traces
```

### 영향도

- 영향받는 컴포넌트:
  - ALB (50-alb) - 리스너 및 타겟 그룹 제거
  - ECS (60-ecs) - load_balancer 설정 제거
  - Security Group (30-security-groups) - 4318 포트 규칙 제거
- 배포 순서: ALB → ECS 순으로 재배포 필요

---

## 16:00 - Tenant ID 통일 및 Pyroscope 멀티테넌시 설정

### 배경

S3 버킷에서 `anonymous/phlaredb/` 폴더 발견. Pyroscope에 tenant ID가 설정되지 않아 기본값 `anonymous`로 저장됨. 또한 기존 tenant ID(`aws-rag-cloudwatch`, `aws-rag-ec2`)가 더 이상 사용되지 않아 통일 필요.

### 변경 사항

#### 1. common.tfvars tenant ID 변경

- 변경된 파일: `ecs-migration/terraform/environments/prod/common.tfvars`
- 변경 내용:

```hcl
# 변경 전
alloy_config = {
  loki_tenant  = "aws-rag-cloudwatch"
  mimir_tenant = "aws-rag-ec2"
}

# 변경 후
alloy_config = {
  loki_tenant  = "jsj-lgtm-header"
  mimir_tenant = "jsj-lgtm-header"
}
```

#### 2. Grafana Pyroscope 데이터소스에 tenant 헤더 추가

- 변경된 파일: `ecs-migration/dockerfiles/grafana/config/provisioning/datasources/datasources.yaml`
- 변경 내용: Pyroscope 데이터소스에 `X-Scope-OrgID` 헤더 추가

```yaml
# 변경 전
- name: Pyroscope
  type: grafana-pyroscope-datasource
  access: proxy
  url: ${PYROSCOPE_DATASOURCE_URL}
  editable: false

# 변경 후
- name: Pyroscope
  type: grafana-pyroscope-datasource
  access: proxy
  url: ${PYROSCOPE_DATASOURCE_URL}
  jsonData:
    httpHeaderName1: X-Scope-OrgID
  secureJsonData:
    httpHeaderValue1: ${LGTM_TENANT_ID}
  editable: false
```

### Tenant ID 구조 (변경 후)

| 서비스 | Tenant ID | 용도 |
|--------|-----------|------|
| Mimir | jsj-lgtm-header | 메트릭 저장 |
| Loki | jsj-lgtm-header | 로그 저장 |
| Tempo | jsj-lgtm-header | 트레이스 저장 |
| Pyroscope | jsj-lgtm-header | 프로파일 저장 |

### 영향도

- 영향받는 컴포넌트:
  - Grafana (datasources 설정)
  - Alloy (tenant ID 변경)
  - ECS 서비스 재배포 필요 (환경변수 변경)
- 주의사항:
  - 기존 `aws-rag-*` tenant의 데이터는 새 tenant에서 조회 불가
  - 새 데이터는 `jsj-lgtm-header/` 폴더에 저장됨

---
